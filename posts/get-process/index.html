<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Enumerando Processos pelo Nome" /><meta name="author" content="H41stur" /><meta property="og:locale" content="en" /><meta name="description" content="“Strange is the night where black stars rise, and strange moons circle through the skies, but stranger still is lost Carcosa.”" /><meta property="og:description" content="“Strange is the night where black stars rise, and strange moons circle through the skies, but stranger still is lost Carcosa.”" /><link rel="canonical" href="https://h41stur.github.io/posts/get-process/" /><meta property="og:url" content="https://h41stur.github.io/posts/get-process/" /><meta property="og:site_name" content="H41stur" /><meta property="og:image" content="https://h41stur.github.io/img/posts/WinAPI.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-08-06T01:00:00-03:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://h41stur.github.io/img/posts/WinAPI.png" /><meta property="twitter:title" content="Enumerando Processos pelo Nome" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@H41stur" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"H41stur"},"dateModified":"2024-08-06T01:00:00-03:00","datePublished":"2024-08-06T01:00:00-03:00","description":"“Strange is the night where black stars rise, and strange moons circle through the skies, but stranger still is lost Carcosa.”","headline":"Enumerando Processos pelo Nome","image":"https://h41stur.github.io/img/posts/WinAPI.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://h41stur.github.io/posts/get-process/"},"url":"https://h41stur.github.io/posts/get-process/"}</script><title>Enumerando Processos pelo Nome | H41stur</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="H41stur"><meta name="application-name" content="H41stur"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://h41stur.github.io/img/h41stur.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">H41stur</a></div><div class="site-subtitle font-italic">Strange is the night where black stars rise, and strange moons circle through the skies, but stranger still is lost Carcosa.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIAS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARQUIVO</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>SOBRE</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/h41stur" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['leonardor.toledo','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/leo-toledo/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Enumerando Processos pelo Nome</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Enumerando Processos pelo Nome</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> H41stur </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Aug 6, 2024, 1:00 AM -0300" >Aug 6, 2024<i class="unloaded">2024-08-06T01:00:00-03:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2618 words">14 min read</span></div></div><div class="post-content"><p><img data-proofer-ignore data-src="/img/posts/WinAPI.png" alt="Enumerando Processos pelo Nome" /></p><h1 id="tldr">TL;DR</h1><p>Neste artigo, exploramos como utilizar as APIs do Windows para enumerar processos em execução, focando nas funções <code class="language-plaintext highlighter-rouge">CreateToolhelp32Snapshot</code>, <code class="language-plaintext highlighter-rouge">Process32First</code> e <code class="language-plaintext highlighter-rouge">Process32Next</code>. Discutimos a importância de entender como essas APIs funcionam por baixo dos panos, especialmente para desenvolvedores e profissionais de segurança cibernética. Mostramos um exemplo prático de código para obter o PID de processos pelo nome, comparando os resultados com ferramentas nativas do Windows como PowerShell e CMD.</p><p>Esta compreensão profunda das APIs permite desenvolver soluções personalizadas e fortalecer as habilidades técnicas, abrindo caminho para futuras explorações criativas e seguras no campo da segurança cibernética.</p><h1 id="introdução">Introdução</h1><p>Seguindo com os estudos sobre como explorar as chamadas de WinAPI, achei interessante escrever sobre alguns pontos específicos que fazem muito sentido para o <strong>meu</strong> processo de estudos, sendo basicamente mimetizar ações que possam parecer triviais, porém com uso das APIs.</p><p>Acredito que este tipo de entendimento é essencial no contexto de <strong>verdadeiro</strong> entendimento de todo o processo. Uma vez que, mesmo podendo realizar ações simples utilizando ferramentas prontas e até mesmo intrínsecas do próprio Windows, podemos “abrir o capô” do SO e ver o motor funcionando. Saber como as aplicações realizam estas ações simples, reproduzir estas ações de forma primitiva e até mesmo encontrar maneiras diferentes de fazê-las.</p><p>No caso deste artigo, me foquei em estudar e utilizar as APIs do Windows para encontrar informações de processos em execução através de uma pesquisa por seu nome. Algo tão simples quanto utilizar o comando <code class="language-plaintext highlighter-rouge">Get-Process</code> no <code class="language-plaintext highlighter-rouge">PowerShell</code> ou o <code class="language-plaintext highlighter-rouge">tasklist</code> no <code class="language-plaintext highlighter-rouge">CMD</code>. Mas, e se eu não quiser utilizar <code class="language-plaintext highlighter-rouge">Powershell</code> ou <code class="language-plaintext highlighter-rouge">CMD</code>? E se eu estiver codando um <em>malware</em> que faz uso exclusivo de WinAPI? E se eu quiser criar minhas próprias chamadas customizadas? E se eu quiser entender como tudo funciona por baixo?</p><p>Tentarei esmiuçar o processo que usei para estudar e os achados deste processo que podem ser úteis não só para esta ação utilizada no artigo, mas para tantas outras.</p><p>Boa leitura e boa sorte!</p><h1 id="god-save-the-debuggers"><em>God save the debuggers!</em></h1><p>As APIs do Windows compreendem uma infinidade de funcionalidades e possibilidades dentro do SO, uma simples olhada na documentação da <a href="https://learn.microsoft.com/en-us/windows/win32/api/">Win32 API</a> já revela sua magnitude. Isso facilita muito o processo para os desenvolvedores do próprio Windows e de desenvolvedores de <em>softwares</em> em geral.</p><p>Entre as diversas bibliotecas possíveis, existem algumas em específico que tem potencial para qualquer uso, inclusive usos maliciosos (eu diria que qualquer biblioteca poderia ter uso malicioso). Porém, a depender da criatividade, algumas delas podem ser uma pérola. É o caso da <a href="https://learn.microsoft.com/en-us/windows/win32/toolhelp/tool-help-library"><em>Tool Help Library</em></a>.</p><p>Conforme a própria documentação, esta biblioteca fornece funções “que foram projetadas para simplificar a criação de ferramentas, especificamente <em>debuggers</em>.”</p><p>Uma vez que <em>debuggers</em> precisam de informações completas sobre processos, <em>threads</em>, módulos, memória, entre outras informações, temos a nossa disposição uma biblioteca que nos entrega muita coisa que pode ser utilizada para enumeração e possível exploração.</p><h2 id="tool-help-library"><em>Tool Help Library</em></h2><p>Quando utilizamos a <em>Tool Help Library</em> para enumerar os processos em memória, esta biblioteca faz um <em>snapshot</em> somente leitura da memória que pode conter os processos, <em>threads</em>, módulos ou a <em>heap</em>, ou todos eles.</p><p>O fato de usar um <em>snapshot</em> e não consultar a memória em tempo real, se dá pelo fato de que cada processo iniciado ou encerrado, cada <em>thread</em> iniciada ou encerrada, cada módulo executado ou encerrado, cada <em>heap</em> criada ou destruída, altera a estrutura da memória em tempo real, e um processo que fizesse consultas nesta estrutura, poderia corrompê-la facilmente.</p><p>Portanto, o “<em>core</em>” da <em>Tool Help Library</em>, é a função <a href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot"><em>CreateToolhelp32Snapshot</em></a> que cria este <em>snapshot</em> e o retorna em um <em>handle</em> que nada mais é que uma ou várias listas contendo as informações solicitadas.</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">HANDLE</span> <span class="nf">CreateToolhelp32Snapshot</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">DWORD</span> <span class="n">dwFlags</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">DWORD</span> <span class="n">th32ProcessID</span>
<span class="p">);</span>
</pre></table></code></div></div><p>Onde:</p><ul><li><code class="language-plaintext highlighter-rouge">[in] dwFlags</code>: Indica as partes do sistema a serem incluídas no <em>snapshot</em>. Podendo ser um ou mais valores.</ul><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240805220814.png" alt="" /></p><ul><li><code class="language-plaintext highlighter-rouge">[in] th32ProcessID</code>: O identificador de processo do processo a ser incluído no <em>snapshot</em>. Este parâmetro pode ser zero para indicar o processo atual.</ul><p>No contexto deste artigo, o que nos interessa é enumerar os processos, portanto, utilizaremos o argumento <code class="language-plaintext highlighter-rouge">TH32CS_SNAPPROCESS</code>.</p><p>Uma vez que temos o <em>handle</em> que contém a lista de todos os processos em execução com suas respectivas particularidades, podemos navegar por esta lista utilizando outras funções.</p><p>A primeira delas é a função <a href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-process32first">Process32First</a>.</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">BOOL</span> <span class="nf">Process32First</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>      <span class="n">HANDLE</span>           <span class="n">hSnapshot</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">]</span> <span class="n">LPPROCESSENTRY32</span> <span class="n">lppe</span>
<span class="p">);</span>
</pre></table></code></div></div><p>Esta função exige como argumento o <em>handle</em> extraído com a lista dos processos, e um ponteiro para uma estrutura do tipo <a href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/ns-tlhelp32-processentry32">PROCESSENTRY32</a> onde ela descarregará as informações sobre o primeiro processo encontrado na lista.</p><p>A estrutura <code class="language-plaintext highlighter-rouge">PROCESSENTRY32</code> tem o seguinte formato:</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">tagPROCESSENTRY32</span> <span class="p">{</span>
  <span class="n">DWORD</span>     <span class="n">dwSize</span><span class="p">;</span>
  <span class="n">DWORD</span>     <span class="n">cntUsage</span><span class="p">;</span>
  <span class="n">DWORD</span>     <span class="n">th32ProcessID</span><span class="p">;</span>
  <span class="n">ULONG_PTR</span> <span class="n">th32DefaultHeapID</span><span class="p">;</span>
  <span class="n">DWORD</span>     <span class="n">th32ModuleID</span><span class="p">;</span>
  <span class="n">DWORD</span>     <span class="n">cntThreads</span><span class="p">;</span>
  <span class="n">DWORD</span>     <span class="n">th32ParentProcessID</span><span class="p">;</span>
  <span class="n">LONG</span>      <span class="n">pcPriClassBase</span><span class="p">;</span>
  <span class="n">DWORD</span>     <span class="n">dwFlags</span><span class="p">;</span>
  <span class="n">CHAR</span>      <span class="n">szExeFile</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>
<span class="p">}</span> <span class="n">PROCESSENTRY32</span><span class="p">;</span>
</pre></table></code></div></div><p>Uma informação importante vinda da própria documentação, é que antes de invocarmos a função <code class="language-plaintext highlighter-rouge">Process32First()</code> temos que inicializar o parâmetro <code class="language-plaintext highlighter-rouge">dwSize</code> da estrutura PROCESSENTRY32 com o valor <code class="language-plaintext highlighter-rouge">sizeof(PROCESSENTRY32)</code>, caso contrário o processo falhará.</p><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240805222649.png" alt="" /></p><p>Uma vez que a função <code class="language-plaintext highlighter-rouge">Process32First()</code> foi executada com sucesso, temos todas as informações sobre o primeiro processo do <em>snapshot</em> contidos na <em>struct</em> PROCESSENTRY32 e podemos consultá-la e obtermos as informações que precisamos.</p><p>Para continuar a navegação no <em>snapshot</em> a partir deste ponto, utilizamos a função <a href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-process32next">Process32Next</a> que tem basicamente os mesmos argumentos da anterior.</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">BOOL</span> <span class="nf">Process32Next</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>  <span class="n">HANDLE</span>           <span class="n">hSnapshot</span><span class="p">,</span>
  <span class="p">[</span><span class="n">out</span><span class="p">]</span> <span class="n">LPPROCESSENTRY32</span> <span class="n">lppe</span>
<span class="p">);</span>
</pre></table></code></div></div><p>Após sua execução, a estrutura PROCESSENTRY32 passa a conter os dados do próximo processo do <em>snapshot</em>. A partir deste ponto, podemos percorrer toda a lista de processos contidos no <em>snapshot</em> obtendo as informações necessárias para nossos objetivos.</p><p>Este processo, em nosso contexto, será utilizado com um <em>snapshot</em> focado nos processos em execução, porém, para cada outro tipo de informação possível de se extrair, temos funções equivalentes, como estrutura <code class="language-plaintext highlighter-rouge">THREADENTRY32</code> e funções <code class="language-plaintext highlighter-rouge">Thread32Frist</code> e <code class="language-plaintext highlighter-rouge">Thread32Next</code>, estrutura <code class="language-plaintext highlighter-rouge">MODULEENTRY32</code> e funções <code class="language-plaintext highlighter-rouge">Module32First</code> e <code class="language-plaintext highlighter-rouge">Module32Next</code> e assim por diante.</p><p>Na própria documentação, temos um <a href="https://learn.microsoft.com/en-us/windows/win32/toolhelp/taking-a-snapshot-and-viewing-processes">script de exemplo </a> que dá uma série de detalhes sobre processos, <em>threads</em> e módulos em execução.</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tchar.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="c1">//  Forward declarations:</span>
<span class="n">BOOL</span> <span class="nf">GetProcessList</span><span class="p">(</span> <span class="p">);</span>
<span class="n">BOOL</span> <span class="nf">ListProcessModules</span><span class="p">(</span> <span class="n">DWORD</span> <span class="n">dwPID</span> <span class="p">);</span>
<span class="n">BOOL</span> <span class="nf">ListProcessThreads</span><span class="p">(</span> <span class="n">DWORD</span> <span class="n">dwOwnerPID</span> <span class="p">);</span>
<span class="kt">void</span> <span class="nf">printError</span><span class="p">(</span> <span class="n">TCHAR</span> <span class="k">const</span><span class="o">*</span> <span class="n">msg</span> <span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="n">GetProcessList</span><span class="p">(</span> <span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="nf">GetProcessList</span><span class="p">(</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="n">HANDLE</span> <span class="n">hProcessSnap</span><span class="p">;</span>
  <span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">;</span>
  <span class="n">PROCESSENTRY32</span> <span class="n">pe32</span><span class="p">;</span>
  <span class="n">DWORD</span> <span class="n">dwPriorityClass</span><span class="p">;</span>

  <span class="c1">// Take a snapshot of all processes in the system.</span>
  <span class="n">hProcessSnap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span> <span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">hProcessSnap</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printError</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"CreateToolhelp32Snapshot (of processes)"</span><span class="p">)</span> <span class="p">);</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">FALSE</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Set the size of the structure before using it.</span>
  <span class="n">pe32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">PROCESSENTRY32</span> <span class="p">);</span>

  <span class="c1">// Retrieve information about the first process,</span>
  <span class="c1">// and exit if unsuccessful</span>
  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">Process32First</span><span class="p">(</span> <span class="n">hProcessSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span> <span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printError</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"Process32First"</span><span class="p">)</span> <span class="p">);</span> <span class="c1">// show cause of failure</span>
    <span class="n">CloseHandle</span><span class="p">(</span> <span class="n">hProcessSnap</span> <span class="p">);</span>          <span class="c1">// clean the snapshot object</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">FALSE</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Now walk the snapshot of processes, and</span>
  <span class="c1">// display information about each process in turn</span>
  <span class="k">do</span>
  <span class="p">{</span>
    <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">====================================================="</span> <span class="p">));</span>
    <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">PROCESS NAME:  %s"</span><span class="p">),</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span> <span class="p">);</span>
    <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">-------------------------------------------------------"</span> <span class="p">));</span>

    <span class="c1">// Retrieve the priority class.</span>
    <span class="n">dwPriorityClass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hProcess</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span> <span class="n">PROCESS_ALL_ACCESS</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span> <span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">hProcess</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
      <span class="n">printError</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"OpenProcess"</span><span class="p">)</span> <span class="p">);</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">dwPriorityClass</span> <span class="o">=</span> <span class="n">GetPriorityClass</span><span class="p">(</span> <span class="n">hProcess</span> <span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">dwPriorityClass</span> <span class="p">)</span>
        <span class="n">printError</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"GetPriorityClass"</span><span class="p">)</span> <span class="p">);</span>
      <span class="n">CloseHandle</span><span class="p">(</span> <span class="n">hProcess</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">  Process ID        = 0x%08X"</span><span class="p">),</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span> <span class="p">);</span>
    <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">  Thread count      = %d"</span><span class="p">),</span>   <span class="n">pe32</span><span class="p">.</span><span class="n">cntThreads</span> <span class="p">);</span>
    <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">  Parent process ID = 0x%08X"</span><span class="p">),</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ParentProcessID</span> <span class="p">);</span>
    <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">  Priority base     = %d"</span><span class="p">),</span> <span class="n">pe32</span><span class="p">.</span><span class="n">pcPriClassBase</span> <span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">dwPriorityClass</span> <span class="p">)</span>
      <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">  Priority class    = %d"</span><span class="p">),</span> <span class="n">dwPriorityClass</span> <span class="p">);</span>

    <span class="c1">// List the modules and threads associated with this process</span>
    <span class="n">ListProcessModules</span><span class="p">(</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span> <span class="p">);</span>
    <span class="n">ListProcessThreads</span><span class="p">(</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span> <span class="p">);</span>

  <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="n">Process32Next</span><span class="p">(</span> <span class="n">hProcessSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span> <span class="p">)</span> <span class="p">);</span>

  <span class="n">CloseHandle</span><span class="p">(</span> <span class="n">hProcessSnap</span> <span class="p">);</span>
  <span class="k">return</span><span class="p">(</span> <span class="n">TRUE</span> <span class="p">);</span>
<span class="p">}</span>


<span class="n">BOOL</span> <span class="nf">ListProcessModules</span><span class="p">(</span> <span class="n">DWORD</span> <span class="n">dwPID</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="n">HANDLE</span> <span class="n">hModuleSnap</span> <span class="o">=</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">;</span>
  <span class="n">MODULEENTRY32</span> <span class="n">me32</span><span class="p">;</span>

  <span class="c1">// Take a snapshot of all modules in the specified process.</span>
  <span class="n">hModuleSnap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span> <span class="n">TH32CS_SNAPMODULE</span><span class="p">,</span> <span class="n">dwPID</span> <span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">hModuleSnap</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printError</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"CreateToolhelp32Snapshot (of modules)"</span><span class="p">)</span> <span class="p">);</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">FALSE</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Set the size of the structure before using it.</span>
  <span class="n">me32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">MODULEENTRY32</span> <span class="p">);</span>

  <span class="c1">// Retrieve information about the first module,</span>
  <span class="c1">// and exit if unsuccessful</span>
  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">Module32First</span><span class="p">(</span> <span class="n">hModuleSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">me32</span> <span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printError</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"Module32First"</span><span class="p">)</span> <span class="p">);</span>  <span class="c1">// show cause of failure</span>
    <span class="n">CloseHandle</span><span class="p">(</span> <span class="n">hModuleSnap</span> <span class="p">);</span>           <span class="c1">// clean the snapshot object</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">FALSE</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Now walk the module list of the process,</span>
  <span class="c1">// and display information about each module</span>
  <span class="k">do</span>
  <span class="p">{</span>
    <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">     MODULE NAME:     %s"</span><span class="p">),</span>   <span class="n">me32</span><span class="p">.</span><span class="n">szModule</span> <span class="p">);</span>
    <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">     Executable     = %s"</span><span class="p">),</span>     <span class="n">me32</span><span class="p">.</span><span class="n">szExePath</span> <span class="p">);</span>
    <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">     Process ID     = 0x%08X"</span><span class="p">),</span>         <span class="n">me32</span><span class="p">.</span><span class="n">th32ProcessID</span> <span class="p">);</span>
    <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">     Ref count (g)  = 0x%04X"</span><span class="p">),</span>     <span class="n">me32</span><span class="p">.</span><span class="n">GlblcntUsage</span> <span class="p">);</span>
    <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">     Ref count (p)  = 0x%04X"</span><span class="p">),</span>     <span class="n">me32</span><span class="p">.</span><span class="n">ProccntUsage</span> <span class="p">);</span>
    <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">     Base address   = 0x%08X"</span><span class="p">),</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span> <span class="n">me32</span><span class="p">.</span><span class="n">modBaseAddr</span> <span class="p">);</span>
    <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">     Base size      = %d"</span><span class="p">),</span>             <span class="n">me32</span><span class="p">.</span><span class="n">modBaseSize</span> <span class="p">);</span>

  <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="n">Module32Next</span><span class="p">(</span> <span class="n">hModuleSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">me32</span> <span class="p">)</span> <span class="p">);</span>

  <span class="n">CloseHandle</span><span class="p">(</span> <span class="n">hModuleSnap</span> <span class="p">);</span>
  <span class="k">return</span><span class="p">(</span> <span class="n">TRUE</span> <span class="p">);</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="nf">ListProcessThreads</span><span class="p">(</span> <span class="n">DWORD</span> <span class="n">dwOwnerPID</span> <span class="p">)</span> 
<span class="p">{</span> 
  <span class="n">HANDLE</span> <span class="n">hThreadSnap</span> <span class="o">=</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">;</span> 
  <span class="n">THREADENTRY32</span> <span class="n">te32</span><span class="p">;</span> 
 
  <span class="c1">// Take a snapshot of all running threads  </span>
  <span class="n">hThreadSnap</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span> <span class="n">TH32CS_SNAPTHREAD</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span> 
  <span class="k">if</span><span class="p">(</span> <span class="n">hThreadSnap</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span> <span class="p">)</span> 
    <span class="k">return</span><span class="p">(</span> <span class="n">FALSE</span> <span class="p">);</span> 
 
  <span class="c1">// Fill in the size of the structure before using it. </span>
  <span class="n">te32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">THREADENTRY32</span><span class="p">);</span> 
 
  <span class="c1">// Retrieve information about the first thread,</span>
  <span class="c1">// and exit if unsuccessful</span>
  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">Thread32First</span><span class="p">(</span> <span class="n">hThreadSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">te32</span> <span class="p">)</span> <span class="p">)</span> 
  <span class="p">{</span>
    <span class="n">printError</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"Thread32First"</span><span class="p">)</span> <span class="p">);</span> <span class="c1">// show cause of failure</span>
    <span class="n">CloseHandle</span><span class="p">(</span> <span class="n">hThreadSnap</span> <span class="p">);</span>          <span class="c1">// clean the snapshot object</span>
    <span class="k">return</span><span class="p">(</span> <span class="n">FALSE</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Now walk the thread list of the system,</span>
  <span class="c1">// and display information about each thread</span>
  <span class="c1">// associated with the specified process</span>
  <span class="k">do</span> 
  <span class="p">{</span> 
    <span class="k">if</span><span class="p">(</span> <span class="n">te32</span><span class="p">.</span><span class="n">th32OwnerProcessID</span> <span class="o">==</span> <span class="n">dwOwnerPID</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">     THREAD ID      = 0x%08X"</span><span class="p">),</span> <span class="n">te32</span><span class="p">.</span><span class="n">th32ThreadID</span> <span class="p">);</span> 
      <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">     Base priority  = %d"</span><span class="p">),</span> <span class="n">te32</span><span class="p">.</span><span class="n">tpBasePri</span> <span class="p">);</span> 
      <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">     Delta priority = %d"</span><span class="p">),</span> <span class="n">te32</span><span class="p">.</span><span class="n">tpDeltaPri</span> <span class="p">);</span> 
      <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="n">Thread32Next</span><span class="p">(</span><span class="n">hThreadSnap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">te32</span> <span class="p">)</span> <span class="p">);</span> 

  <span class="n">CloseHandle</span><span class="p">(</span> <span class="n">hThreadSnap</span> <span class="p">);</span>
  <span class="k">return</span><span class="p">(</span> <span class="n">TRUE</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">printError</span><span class="p">(</span> <span class="n">TCHAR</span> <span class="k">const</span><span class="o">*</span> <span class="n">msg</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="n">DWORD</span> <span class="n">eNum</span><span class="p">;</span>
  <span class="n">TCHAR</span> <span class="n">sysMsg</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
  <span class="n">TCHAR</span><span class="o">*</span> <span class="n">p</span><span class="p">;</span>

  <span class="n">eNum</span> <span class="o">=</span> <span class="n">GetLastError</span><span class="p">(</span> <span class="p">);</span>
  <span class="n">FormatMessage</span><span class="p">(</span> <span class="n">FORMAT_MESSAGE_FROM_SYSTEM</span> <span class="o">|</span> <span class="n">FORMAT_MESSAGE_IGNORE_INSERTS</span><span class="p">,</span>
         <span class="nb">NULL</span><span class="p">,</span> <span class="n">eNum</span><span class="p">,</span>
         <span class="n">MAKELANGID</span><span class="p">(</span><span class="n">LANG_NEUTRAL</span><span class="p">,</span> <span class="n">SUBLANG_DEFAULT</span><span class="p">),</span> <span class="c1">// Default language</span>
         <span class="n">sysMsg</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">);</span>

  <span class="c1">// Trim the end of the line and terminate it with a null</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">sysMsg</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span> <span class="p">(</span> <span class="o">*</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">31</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="mi">9</span> <span class="p">)</span> <span class="p">)</span>
    <span class="o">++</span><span class="n">p</span><span class="p">;</span>
  <span class="k">do</span> <span class="p">{</span> <span class="o">*</span><span class="n">p</span><span class="o">--</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="p">(</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="n">sysMsg</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
                          <span class="p">(</span> <span class="p">(</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">'.'</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="o">*</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mi">33</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>

  <span class="c1">// Display the message</span>
  <span class="n">_tprintf</span><span class="p">(</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">  WARNING: %s failed with error %d (%s)"</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="n">eNum</span><span class="p">,</span> <span class="n">sysMsg</span> <span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Podemos compilar este programa:</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>i686-w64-mingw32-gcc snapProcess.cpp <span class="nt">-o</span> snapProcess.exe
</pre></table></code></div></div><p>Ao executarmos no Windows, ele começará a enumerar todas as informações a partir de um <em>snapshot</em>.</p><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240806072245.png" alt="" /></p><p>Obviamente este programa de exemplo trás muitas informações em uma resposta bastante completa, como o objeto deste estudo é somente enumerarmos os processos, podemos utilizá-lo como base para criarmos um programa mais simples, como um que nos retorne o <strong>PID</strong> de um processo, pesquisando pelo nome.</p><p>Uma vez que o PID é a principal forma de identificar um processo no ponto de vista do SO, e do kernel, obter esta informação é de extrema importância em um contexto <i><span style="color:red;">red team</span></i>.</p><p>Aproveitando a lógica do programa de exemplo, podemos criar a estrutura <code class="language-plaintext highlighter-rouge">PROCESSENTRY32</code> que receberá as informações do processo durante a iteração com o <em>snapshot</em>. Um dos parâmetros da estrutura é o <code class="language-plaintext highlighter-rouge">szExeFile</code> que contém o nome do executável. Durante o <em>loop</em> pelos processos, podemos comparar este parâmetro com o que procuramos, caso o encontre, o <em>loop</em> pára e nos retorna o parâmetro <code class="language-plaintext highlighter-rouge">th32ProcessID</code> que contém o PID do processo.</p><div lang="cpp" class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">findPID</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">procName</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">HANDLE</span> <span class="n">hSnapshot</span><span class="p">;</span>
    <span class="n">PROCESSENTRY32</span> <span class="n">pe32</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">BOOL</span> <span class="n">proc</span><span class="p">;</span>

    <span class="c1">// snapshot de todos os processos em execucao</span>
    <span class="n">hSnapshot</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">INVALID_HANDLE_VALUE</span> <span class="o">==</span> <span class="n">hSnapshot</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// inicializando dwSize</span>
    <span class="n">pe32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESSENTRY32</span><span class="p">);</span>

    <span class="c1">// inicio da iteracao, primeiro processo</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">Process32First</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">);</span>

    <span class="c1">// loop para iterar sobre os processos</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">proc</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">procName</span><span class="p">,</span> <span class="n">pe32</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="n">pe32</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">Process32Next</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe32</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// fecha o handle aberto</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">pid</span> <span class="o">=</span> <span class="n">findPID</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"PID of %s: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pid</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Podemos compilar o programa:</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>i686-w64-mingw32-gcc getPID.cpp <span class="nt">-o</span> getPID.exe
</pre></table></code></div></div><p>Para fins de teste, podemos iniciar um executável qualquer, como o <code class="language-plaintext highlighter-rouge">Notepad.exe</code> e enumerar seu PID tanto com o nosso programa quanto com o <code class="language-plaintext highlighter-rouge">PowerShell</code> para comparação.</p><p><img data-proofer-ignore data-src="/img/posts/Pasted%20image%2020240806085211.png" alt="" /></p><p>Como podemos ver, ambos trouxeram o mesmo resultado, mostrando que conseguimos enumerar os processos utilizando as APIS do Windows sem grandes dificuldades. Este exercício nos proporciona uma compreensão mais profunda do funcionamento interno do sistema operacional.</p><p>Conforme dito no início deste artigo, esta é uma ação trivial que pode ser feita com qualquer outra ferramenta, porém nos da entendimento sobre como o processo funciona de forma mais primitiva dentro do SO.</p><p>Sabendo do potencial de informações possíveis utilizando este método, podemos, em artigos futuros, nos aproveitar da visão <i><span style="color:red;">red teamer</span></i> para utilizar este conhecimento de forma mais criativa.</p><h1 id="conclusão">Conclusão</h1><p>Neste artigo, exploramos detalhadamente como as APIs do Windows podem ser utilizadas para enumerar processos em execução, focando no uso de chamadas específicas como <code class="language-plaintext highlighter-rouge">CreateToolhelp32Snapshot</code>, <code class="language-plaintext highlighter-rouge">Process32First</code> e <code class="language-plaintext highlighter-rouge">Process32Next</code>. Compreendemos que, embora existam ferramentas prontas no próprio sistema operacional, a implementação dessas funcionalidades diretamente através da WinAPI nos proporciona uma visão mais profunda e um controle maior sobre o funcionamento interno do Windows.</p><p>Através do exemplo prático e das explicações fornecidas, vimos como é possível replicar essas funcionalidades de forma primitiva, demonstrando que, com o conhecimento adequado, podemos desenvolver soluções personalizadas e entender melhor o comportamento do sistema operacional. Este exercício é especialmente útil para desenvolvedores, profissionais de segurança e entusiastas que desejam fortalecer suas habilidades e conhecimentos técnicos.</p><p>Ao aprofundarmos nosso entendimento sobre como os processos funcionam e como podem ser manipulados, abrimos portas para inúmeras possibilidades, como desenvolvimento de novas ferramentas. Este artigo é apenas um ponto de partida, e esperamos explorar mais técnicas e abordagens nos próximos textos, sempre com a visão de red teamer, buscando formas criativas e inovadoras de aplicar esse conhecimento.</p><p>Agradeço por acompanhar este estudo e convido todos a continuar explorando e aprendendo sobre as infinitas possibilidades que as APIs do Windows oferecem. Boa sorte em seus estudos e desenvolvimento!</p><h1 id="referências">Referências</h1><ul><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/">https://learn.microsoft.com/en-us/windows/win32/api/</a><li><a href="https://learn.microsoft.com/en-us/windows/win32/toolhelp/tool-help-library">https://learn.microsoft.com/en-us/windows/win32/toolhelp/tool-help-library</a><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot">https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot</a><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-process32first">https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-process32first</a><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/ns-tlhelp32-processentry32">https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/ns-tlhelp32-processentry32</a><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-process32next">https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-process32next</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/estudos/'>Estudos</a>, <a href='/categories/winapi/'>WinAPI</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/shellcoding/" class="post-tag no-text-decoration" >Shellcoding</a> <a href="/tags/shellcode/" class="post-tag no-text-decoration" >Shellcode</a> <a href="/tags/windows-api/" class="post-tag no-text-decoration" >Windows API</a> <a href="/tags/kernel/" class="post-tag no-text-decoration" >Kernel</a> <a href="/tags/winapi/" class="post-tag no-text-decoration" >WinAPI</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Enumerando Processos pelo Nome - H41stur&url=https://h41stur.github.io/posts/get-process/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Enumerando Processos pelo Nome - H41stur&u=https://h41stur.github.io/posts/get-process/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Enumerando Processos pelo Nome - H41stur&url=https://h41stur.github.io/posts/get-process/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://h41stur.github.io/posts/get-process/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div><div> <script src="https://utteranc.es/client.js" repo="h41stur/h41stur.github.io" issue-term="url" theme="photon-dark" crossorigin="anonymous" async> </script></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/process-injection/">Process Injection 101</a><li><a href="/posts/evasao-av/">Evasão de Antivírus - Princípios Gerais e Abordagens Específicas</a><li><a href="/posts/paper-heap/">Heap Exploitation P.1</a><li><a href="/posts/shellcoding101/">Shellcoding 101</a><li><a href="/posts/replay-sinal-rf/">Uma Jornada no Hardware Hacking: Criando um Clonador de Sinais RF</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/binary-exploitation/">Binary Exploitation</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/vulnserver/">Vulnserver</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/kernel/">Kernel</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/process-injection/"><div class="card-body"> <span class="timeago small" >Aug 7, 2024<i class="unloaded">2024-08-07T01:00:00-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Process Injection 101</h3><div class="text-muted small"><p> TL;DR Neste artigo, exploramos a técnica de Process Injection, uma abordagem avançada que permite a injeção de código em processos legítimos em execução. Amplamente utilizada em cenários de segu...</p></div></div></a></div><div class="card"> <a href="/posts/process-listing/"><div class="card-body"> <span class="timeago small" >Aug 19, 2024<i class="unloaded">2024-08-19T01:00:00-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Process Listing e Token Dumping com WinAPI</h3><div class="text-muted small"><p> TL;DR Este artigo explora técnicas para listar processos e realizar token dumping em sistemas Windows utilizando diversas APIs. Abordamos métodos além da Tool Help Library, como WTSEnumerateProc...</p></div></div></a></div><div class="card"> <a href="/posts/shellcoding101/"><div class="card-body"> <span class="timeago small" >Jul 18, 2024<i class="unloaded">2024-07-18T01:00:00-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Shellcoding 101</h3><div class="text-muted small"><p> TL;DR Neste artigo, exploramos os fundamentos do desenvolvimento de shellcodes, focando principalmente no ambiente Windows e na manipulação de endereços dinâmicos. O shellcoding envolve escrever...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/evasao-av/" class="btn btn-outline-primary" prompt="Older"><p>Evasão de Antivírus - Princípios Gerais e Abordagens Específicas</p></a> <a href="/posts/process-injection/" class="btn btn-outline-primary" prompt="Newer"><p>Process Injection 101</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/h41stur">H41stur</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/windows/">Windows</a> <a class="post-tag" href="/tags/assembly/">Assembly</a> <a class="post-tag" href="/tags/binary-exploitation/">Binary Exploitation</a> <a class="post-tag" href="/tags/buffer-overflow/">Buffer Overflow</a> <a class="post-tag" href="/tags/web/">Web</a> <a class="post-tag" href="/tags/htb/">HTB</a> <a class="post-tag" href="/tags/vulnserver/">Vulnserver</a> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/kernel/">Kernel</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://h41stur.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
